---
phase: 04-recurring-transactions
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - spendwise/src/graphql/queries/recurring.ts
  - spendwise/src/graphql/mutations/recurring.ts
  - spendwise/src/graphql/queries/index.ts
  - spendwise/src/graphql/mutations/index.ts
  - spendwise/src/hooks/useRecurring.ts
  - spendwise/src/hooks/index.ts
  - spendwise/src/app/(dashboard)/recurring/page.tsx
  - spendwise/src/components/recurring/RecurringSummary.tsx
  - spendwise/src/components/recurring/RecurringTable.tsx
  - spendwise/src/components/recurring/RecurringFilters.tsx
  - spendwise/src/components/recurring/AddRecurringModal.tsx
  - spendwise/src/components/layout/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /recurring from sidebar and see the recurring transactions page"
    - "Recurring page shows 4 summary cards: Total Recurring Expenses, Total Recurring Income, Net Recurring, Active Count"
    - "Summary cards show monthly-normalized amounts"
    - "User can see a sortable table of all recurring transactions with columns: Merchant, Amount, Frequency, Category, Next Expected, Last Paid, Status"
    - "User can click a column header to sort the table"
    - "User can filter by frequency and type (All/Expenses/Income tabs)"
    - "User can expand a row to see past transaction dates and amounts"
    - "User can dismiss a recurring item (soft delete)"
    - "User can manually add a recurring item via Add Recurring modal"
    - "Possibly cancelled items appear dimmed/grayed in the table"
    - "Empty state shows guidance message with import CTA when no recurring items detected"
  artifacts:
    - path: "spendwise/src/graphql/queries/recurring.ts"
      provides: "GET_RECURRING and GET_RECURRING_SUMMARY GraphQL queries"
      exports: ["GET_RECURRING", "GET_RECURRING_SUMMARY"]
    - path: "spendwise/src/graphql/mutations/recurring.ts"
      provides: "UPDATE_RECURRING, DISMISS_RECURRING, RESTORE_RECURRING, ADD_RECURRING mutations"
      exports: ["UPDATE_RECURRING", "DISMISS_RECURRING", "RESTORE_RECURRING", "ADD_RECURRING"]
    - path: "spendwise/src/hooks/useRecurring.ts"
      provides: "useRecurring, useRecurringSummary, useUpdateRecurring, useDismissRecurring, useAddRecurring hooks"
      exports: ["useRecurring", "useRecurringSummary", "useUpdateRecurring", "useDismissRecurring", "useAddRecurring"]
    - path: "spendwise/src/app/(dashboard)/recurring/page.tsx"
      provides: "Recurring transactions page with summary + table + filters"
      min_lines: 50
    - path: "spendwise/src/components/recurring/RecurringTable.tsx"
      provides: "Sortable table with expandable rows for transaction history"
      min_lines: 80
    - path: "spendwise/src/components/recurring/RecurringSummary.tsx"
      provides: "4 summary cards (expenses, income, net, active count)"
      min_lines: 30
    - path: "spendwise/src/components/layout/Sidebar.tsx"
      provides: "Recurring nav item added between Analytics and Accounts"
      contains: "Recurring"
  key_links:
    - from: "spendwise/src/hooks/useRecurring.ts"
      to: "spendwise/src/graphql/queries/recurring.ts"
      via: "useQuery with GET_RECURRING"
      pattern: "GET_RECURRING"
    - from: "spendwise/src/app/(dashboard)/recurring/page.tsx"
      to: "spendwise/src/hooks/useRecurring.ts"
      via: "useRecurring and useRecurringSummary hooks"
      pattern: "useRecurring|useRecurringSummary"
    - from: "spendwise/src/components/recurring/RecurringTable.tsx"
      to: "spendwise/src/hooks/useRecurring.ts"
      via: "useDismissRecurring for dismiss action"
      pattern: "useDismissRecurring"
    - from: "spendwise/src/components/layout/Sidebar.tsx"
      to: "/recurring"
      via: "Link href in navigation array"
      pattern: "recurring"
---

<objective>
Build the complete frontend for recurring transactions: GraphQL queries/mutations, Apollo Client hooks, page with summary cards and sortable/filterable table, expandable rows, add/dismiss functionality, and sidebar navigation.

Purpose: Users need a dedicated page to view, manage, and understand their recurring financial commitments. This completes the full feature — from detection (Plan 01) through API (Plan 02) to user interface.

Output: Working /recurring page with summary cards, filterable table, expandable rows, dismiss/add functionality, sidebar nav item
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-recurring-transactions/04-CONTEXT.md
@.planning/phases/04-recurring-transactions/04-02-SUMMARY.md
@spendwise/src/app/(dashboard)/analytics/page.tsx
@spendwise/src/hooks/useDashboard.ts
@spendwise/src/hooks/useAnalyticsFilters.ts
@spendwise/src/components/layout/Sidebar.tsx
@spendwise/src/components/charts/TopMerchantsTable.tsx
@spendwise/src/graphql/queries/analytics.ts
@spendwise/src/graphql/mutations/transactions.ts
@spendwise/src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GraphQL queries, mutations, and Apollo hooks for recurring transactions</name>
  <files>
    spendwise/src/graphql/queries/recurring.ts
    spendwise/src/graphql/mutations/recurring.ts
    spendwise/src/graphql/queries/index.ts
    spendwise/src/graphql/mutations/index.ts
    spendwise/src/hooks/useRecurring.ts
    spendwise/src/hooks/index.ts
  </files>
  <action>
    **GraphQL Queries (queries/recurring.ts):**

    `GET_RECURRING` query:
    ```graphql
    query GetRecurring($filters: RecurringFiltersInput, $sort: RecurringSortInput, $dismissed: Boolean) {
      recurring(filters: $filters, sort: $sort, dismissed: $dismissed) {
        id
        description
        merchantName
        category
        frequency
        isActive
        isDismissed
        lastAmount
        averageAmount
        lastDate
        firstDate
        nextExpectedDate
        status
        transactionIds
        createdAt
        updatedAt
      }
    }
    ```

    `GET_RECURRING_SUMMARY` query:
    ```graphql
    query GetRecurringSummary {
      recurringSummary {
        totalRecurringExpenses
        totalRecurringIncome
        netRecurring
        activeCount
        incomeRatio
      }
    }
    ```

    **GraphQL Mutations (mutations/recurring.ts):**

    `UPDATE_RECURRING` — mutates updateRecurring(id, input) returning full RecurringTransaction
    `DISMISS_RECURRING` — mutates dismissRecurring(id) returning id and isDismissed
    `RESTORE_RECURRING` — mutates restoreRecurring(id) returning id and isDismissed
    `ADD_RECURRING` — mutates addRecurring(input: AddRecurringInput) returning full RecurringTransaction
    `DETECT_RECURRING` — mutates detectRecurring returning count (Int)

    **Update index files:**
    Add exports for recurring queries in queries/index.ts and mutations in mutations/index.ts. Follow existing patterns (re-export from domain files).

    **Hooks (hooks/useRecurring.ts):**

    Follow the options object pattern established in Phase 3 (reference useDashboard.ts).

    `useRecurring(options?)` — accepts optional `{ filters, sort, dismissed }`, returns `{ recurring, loading, error, refetch }`. Uses `GET_RECURRING` with `fetchPolicy: 'cache-and-network'`.

    `useRecurringSummary()` — no args, returns `{ summary, loading, error, refetch }`. Uses `GET_RECURRING_SUMMARY`.

    `useUpdateRecurring()` — returns `{ updateRecurring(id, input), loading, error }`. Refetches 'GetRecurring' and 'GetRecurringSummary' on completion.

    `useDismissRecurring()` — returns `{ dismissRecurring(id), loading, error }`. Refetches both queries.

    `useRestoreRecurring()` — returns `{ restoreRecurring(id), loading, error }`. Refetches both queries.

    `useAddRecurring()` — returns `{ addRecurring(input), loading, error }`. Refetches both queries.

    **Update hooks/index.ts:**
    Re-export all hooks from useRecurring.ts.
  </action>
  <verify>
    ```bash
    cd /Users/heechung/projects/spendwise && npx tsc --noEmit
    ```
  </verify>
  <done>
    All GraphQL documents and hooks compile. Hooks follow established options object pattern with proper cache invalidation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build recurring page with summary cards, sortable table, filters, and sidebar navigation</name>
  <files>
    spendwise/src/app/(dashboard)/recurring/page.tsx
    spendwise/src/components/recurring/RecurringSummary.tsx
    spendwise/src/components/recurring/RecurringTable.tsx
    spendwise/src/components/recurring/RecurringFilters.tsx
    spendwise/src/components/recurring/AddRecurringModal.tsx
    spendwise/src/components/layout/Sidebar.tsx
  </files>
  <action>
    **RecurringSummary.tsx:**
    4 summary cards in a responsive grid (grid-cols-1 sm:grid-cols-2 lg:grid-cols-4). Use the Card component from `@/components/ui/Card`. Each card shows:
    1. Total Recurring Expenses — red text, formatted as currency, label "Monthly Recurring Expenses"
    2. Total Recurring Income — green text, formatted as currency, label "Monthly Recurring Income"
    3. Net Recurring — color based on positive (green) or negative (red), label "Net Monthly Recurring"
    4. Active Count — neutral color, integer, label "Active Subscriptions"

    Show income ratio below expenses card if available (e.g., "45% of income goes to fixed costs"). Use `formatCurrency` from `@/lib/utils`.

    Loading state: Show skeleton placeholders when loading (gray animated div boxes).

    **RecurringFilters.tsx:**
    Tabs for type filter: All | Expenses | Income (horizontal tab buttons, active tab highlighted with primary color).
    Dropdown for frequency filter: All Frequencies | Weekly | Biweekly | Monthly | Quarterly | Annual.
    These filters are managed by the parent page and passed as props. Callback `onFilterChange({ type?, frequency? })`.

    **RecurringTable.tsx:**
    Sortable table with columns: Merchant, Amount (averageAmount), Frequency, Category, Next Expected, Last Paid (lastDate), Status.

    Props: `{ recurring: RecurringTransaction[], sort: { field, order }, onSort: (field) => void, onDismiss: (id) => void, onRestore: (id) => void }`.

    Clickable column headers with sort indicator (arrow up/down SVG). Clicking toggles asc/desc. Current sort column highlighted.

    Each row:
    - Chevron icon on left (rotates 90deg when expanded)
    - Merchant name (bold) with description below if different
    - Amount formatted as currency (averageAmount)
    - Frequency as capitalized label (e.g., "Monthly", "Weekly")
    - Category as badge/pill
    - Next Expected as formatted date (or "N/A" if null)
    - Last Paid as formatted date
    - Status: "Active" in green, "Possibly Cancelled" in amber/orange, dimmed row for possibly cancelled
    - Dismiss/Restore button on right (X icon for dismiss, undo icon for restore — shown based on isDismissed)

    Expandable row: When row is clicked, expand below to show transaction history. Since we have transactionIds but not full transaction data in the recurring item, show a simple list: "X transactions since [firstDate]" with a note about the pattern. If the recurring item has transactionIds, display count and date range. Use `expandedId` state (only one row expanded at a time).

    Dismissed items: When showing dismissed items (separate query or filtered), rows appear with opacity-50 and strikethrough on merchant name.

    Empty state: "No recurring transactions detected yet. Import more statements to help identify patterns." with a Link to /import.

    **AddRecurringModal.tsx:**
    Modal overlay with form fields:
    - Merchant Name (text input, required)
    - Amount (number input, required, positive)
    - Frequency (select: Weekly, Biweekly, Monthly, Quarterly, Annual)
    - Category (select: use VALID_CATEGORIES or a reasonable subset — Subscriptions, Utilities, Insurance, Entertainment, Rent, Gym, Income, Other)
    - Description (text input, optional)
    - Start Date (date input, required, defaults to today)

    Submit calls `useAddRecurring`. Cancel closes modal. Show loading state on submit button.

    **Page (recurring/page.tsx):**
    Structure matching analytics page pattern:
    1. Page title "Recurring Transactions" with "Add Recurring" button on right
    2. RecurringFilters component (tabs + frequency dropdown)
    3. RecurringSummary component (4 cards)
    4. RecurringTable component (sortable table)
    5. Collapsed "Dismissed Items" section at bottom (expandable) showing dismissed items with restore option

    State management:
    - `type` filter state (All/INCOME/EXPENSE) — default All
    - `frequency` filter state — default undefined (all)
    - `sort` state ({ field: 'lastDate', order: 'desc' } default)
    - `showAddModal` boolean state
    - `showDismissed` boolean state

    Wire useRecurring with filters and sort. Wire useRecurringSummary for cards. Separate useRecurring call with `dismissed: true` for dismissed section (only fetch if showDismissed is true).

    Wrap in Suspense boundary for useSearchParams compatibility (same pattern as analytics page).

    **Sidebar.tsx:**
    Add "Recurring" nav item to the navigation array between "Analytics" and "Accounts" (position index 3). Use a repeat/refresh-style SVG icon:
    ```
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
    ```
    (This is the Heroicons "refresh" icon which visually suggests recurring/repeating.)
  </action>
  <verify>
    ```bash
    cd /Users/heechung/projects/spendwise && npm run build
    ```
    Build completes without errors.
  </verify>
  <done>
    Recurring page renders with summary cards, filterable/sortable table, expandable rows, dismiss/restore, add modal, and sidebar navigation. Build passes.
  </done>
</task>

</tasks>

<verification>
```bash
# Build frontend
cd /Users/heechung/projects/spendwise && npm run build

# Lint check
cd /Users/heechung/projects/spendwise && npm run lint

# TypeScript check
cd /Users/heechung/projects/spendwise && npx tsc --noEmit
```
</verification>

<success_criteria>
- /recurring page renders with 4 summary cards showing monthly-normalized amounts
- Table shows all recurring transactions with 7 columns, sortable by clicking headers
- Type tabs (All/Expenses/Income) filter the table
- Frequency dropdown filters the table
- Clicking a row expands to show transaction history details
- Dismiss button removes item from active list (soft delete)
- "Add Recurring" opens modal and creates new entry
- Dismissed section at bottom shows dismissed items with restore option
- Empty state shows helpful guidance with import CTA
- Possibly cancelled items appear dimmed
- Sidebar shows "Recurring" nav item between Analytics and Accounts
- Frontend builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-recurring-transactions/04-03-SUMMARY.md`
</output>
