---
phase: 05-net-worth-tracking
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - spendwise-api/src/schema/typeDefs/netWorth.ts
  - spendwise-api/src/schema/typeDefs/index.ts
  - spendwise-api/src/schema/resolvers/netWorth.ts
  - spendwise-api/src/schema/resolvers/index.ts
  - spendwise-api/src/schema/resolvers/statementImport.ts
autonomous: true

must_haves:
  truths:
    - "GraphQL netWorth query returns current net worth, month-over-month change, period change, history array, and account breakdown"
    - "Net worth calculation subtracts CREDIT account balances (liabilities) from all other account types (assets)"
    - "toggleIncludeInNetWorth mutation updates account's includeInNetWorth field and invalidates cache"
    - "Statement import triggers on-demand snapshot capture for the importing user"
    - "backfillNetWorthSnapshots mutation generates monthly historical snapshots from transaction history"
    - "Net worth query results are cached in Redis with filter-aware cache keys"
  artifacts:
    - path: "spendwise-api/src/schema/typeDefs/netWorth.ts"
      provides: "GraphQL type definitions for net worth"
      exports: ["netWorthTypeDefs"]
    - path: "spendwise-api/src/schema/resolvers/netWorth.ts"
      provides: "Query and mutation resolvers for net worth"
      exports: ["netWorthResolvers"]
  key_links:
    - from: "spendwise-api/src/schema/resolvers/netWorth.ts"
      to: "prisma.netWorthSnapshot"
      via: "Prisma findMany with date range filter"
      pattern: "prisma\\.netWorthSnapshot\\.findMany"
    - from: "spendwise-api/src/schema/resolvers/statementImport.ts"
      to: "snapshotQueue"
      via: "BullMQ queue.add for on-demand snapshot"
      pattern: "snapshotQueue\\.add"
    - from: "spendwise-api/src/schema/resolvers/netWorth.ts"
      to: "redis cache"
      via: "getCache/setCache/invalidateCache"
      pattern: "(getCache|setCache|invalidateCache)"
---

<objective>
Create GraphQL API for net worth tracking: query for net worth data with time range filtering, mutations for toggling account inclusion and backfilling history, and on-import snapshot trigger.

Purpose: The API layer connects the snapshot infrastructure (Plan 01) to the frontend (Plan 03), providing all data needed for the net worth page.
Output: Working GraphQL queries and mutations for net worth, integrated with statement import flow.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-net-worth-tracking/05-RESEARCH.md
@.planning/phases/05-net-worth-tracking/05-CONTEXT.md
@.planning/phases/05-net-worth-tracking/05-01-SUMMARY.md

Key existing files:
@spendwise-api/src/schema/typeDefs/index.ts
@spendwise-api/src/schema/typeDefs/recurring.ts (pattern reference)
@spendwise-api/src/schema/resolvers/index.ts
@spendwise-api/src/schema/resolvers/analytics.ts (pattern reference for caching, time ranges)
@spendwise-api/src/schema/resolvers/statementImport.ts
@spendwise-api/src/lib/redis.ts
@spendwise-api/src/lib/jobs/snapshotNetWorth.ts (from Plan 01 â€” exports snapshotQueue)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create net worth GraphQL typeDefs and resolvers</name>
  <files>
    spendwise-api/src/schema/typeDefs/netWorth.ts
    spendwise-api/src/schema/typeDefs/index.ts
    spendwise-api/src/schema/resolvers/netWorth.ts
    spendwise-api/src/schema/resolvers/index.ts
  </files>
  <action>
    1. Create `spendwise-api/src/schema/typeDefs/netWorth.ts`:

    Follow the existing `extend type Query` / `extend type Mutation` pattern used by recurring.ts.

    Types to define:
    ```graphql
    enum TimeRange {
      ONE_MONTH
      THREE_MONTHS
      SIX_MONTHS
      ONE_YEAR
      ALL
    }

    type NetWorthHistory {
      date: DateTime!
      value: Decimal!
    }

    type AccountNetWorth {
      accountId: String!
      accountName: String!
      accountType: String!
      balance: Decimal!
      percentOfTotal: Float!
      includeInNetWorth: Boolean!
      history: [NetWorthHistory!]!
    }

    type NetWorthData {
      current: Decimal!
      monthOverMonthChange: Decimal!
      monthOverMonthChangePercent: Float!
      periodChange: Decimal!
      periodChangePercent: Float!
      totalAssets: Decimal!
      totalLiabilities: Decimal!
      history: [NetWorthHistory!]!
      accounts: [AccountNetWorth!]!
    }

    extend type Query {
      netWorth(timeRange: TimeRange, accountIds: [String!]): NetWorthData!
    }

    extend type Mutation {
      toggleIncludeInNetWorth(accountId: String!): Account!
      backfillNetWorthSnapshots: Boolean!
    }
    ```

    2. Create `spendwise-api/src/schema/resolvers/netWorth.ts`:

    **netWorth query resolver:**
    - Call `requireAuth(context)` to get user
    - Accept optional `timeRange` (default ONE_MONTH) and `accountIds` filter
    - Build cache key: `user:${userId}:netWorth:${timeRange}:${accountIds?.sort().join(',') || 'all'}`
    - Check Redis cache with `getCache()`, return if hit
    - Calculate date range from timeRange:
      - ONE_MONTH: 30 days ago
      - THREE_MONTHS: 90 days ago
      - SIX_MONTHS: 180 days ago
      - ONE_YEAR: 365 days ago
      - ALL: no start date filter
    - Fetch snapshots from `prisma.netWorthSnapshot.findMany()` with:
      - where: userId, date range, optionally filtered by accountIds
      - include: { account: true }
      - orderBy: { date: 'asc' }
    - Also fetch current accounts for the user (for live balances and breakdown):
      - `prisma.account.findMany({ where: { userId, includeInNetWorth: true, ...(accountIds filter) } })`
    - Group snapshots by date to build history array:
      - For each date, sum balances: CREDIT accounts subtract, others add
      - Return array of { date, value } points
    - Build account breakdown from current accounts:
      - Calculate total net worth from current balances
      - For each account: { accountId, accountName, accountType, balance, percentOfTotal, includeInNetWorth }
      - Include per-account history from snapshots filtered by accountId
    - Calculate comparison values:
      - monthOverMonthChange: current - value 30 days ago (find closest snapshot)
      - monthOverMonthChangePercent: percentage of change
      - periodChange: current - first value in history
      - periodChangePercent: percentage of change
    - Separate totalAssets and totalLiabilities
    - Cache result for 15 minutes (900 seconds)
    - Return NetWorthData object

    **Credit card handling:** CREDIT account type = liability. Always subtract from net worth regardless of balance sign. All other types (CHECKING, SAVINGS, INVESTMENT) = assets.

    **toggleIncludeInNetWorth mutation:**
    - Require auth
    - Find account by id, verify userId matches
    - Toggle includeInNetWorth boolean
    - Invalidate cache: `invalidateCache(\`user:${userId}:netWorth:*\`)`
    - Return updated account

    **backfillNetWorthSnapshots mutation:**
    - Require auth
    - Fetch all user accounts
    - Find oldest transaction date for user
    - Generate monthly snapshots from oldest transaction date to now:
      - For each month (1st of month), for each account:
        - Calculate balance at that date: current balance minus sum of all transactions after that date
      - Use `prisma.netWorthSnapshot.createMany({ data: snapshots, skipDuplicates: true })`
    - Invalidate cache
    - Return true
    - Limit to 2 years of history (24 months max)

    3. Update `spendwise-api/src/schema/typeDefs/index.ts`:
    - Import `netWorthTypeDefs` and add to typeDefs array

    4. Update `spendwise-api/src/schema/resolvers/index.ts`:
    - Import `netWorthResolvers` and spread into Query and Mutation objects
  </action>
  <verify>
    - `cd spendwise-api && npx tsc --noEmit` compiles without errors
    - GraphQL schema includes netWorth query and toggleIncludeInNetWorth, backfillNetWorthSnapshots mutations (check via introspection or tsc)
  </verify>
  <done>
    GraphQL API serves netWorth query with time range filtering, account breakdown, and history. Mutations toggle account inclusion and backfill historical data. Results are cached in Redis.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add on-import snapshot trigger to statement import</name>
  <files>
    spendwise-api/src/schema/resolvers/statementImport.ts
  </files>
  <action>
    1. In `spendwise-api/src/schema/resolvers/statementImport.ts`:
    - Import the snapshot queue from `../../lib/jobs/snapshotNetWorth` (the exported queue instance)
    - Find the mutation that completes a statement import (the one that processes and saves transactions)
    - AFTER successful transaction import completion, add an on-demand snapshot job:
      ```typescript
      try {
        await snapshotQueue.add('on-demand-snapshot', {
          userId: user.id,
          trigger: 'import',
        });
      } catch (error) {
        console.error('[NetWorth] Failed to queue snapshot after import:', error);
        // Non-blocking: import success is not affected by snapshot failure
      }
      ```
    - The snapshot trigger must be NON-BLOCKING: wrap in try/catch, log errors but never fail the import

    2. Follow the established pattern from Phase 4 where recurring detection was added to the import flow (also non-blocking).

    IMPORTANT: Do NOT modify any other import logic. Only add the snapshot trigger after successful import completion.
  </action>
  <verify>
    - `cd spendwise-api && npx tsc --noEmit` compiles without errors
    - Statement import resolver contains `snapshotQueue.add('on-demand-snapshot'` call
    - The snapshot trigger is wrapped in try/catch (non-blocking)
  </verify>
  <done>
    Statement imports trigger on-demand net worth snapshots for the importing user. Snapshot failure does not affect import success.
  </done>
</task>

</tasks>

<verification>
1. `cd spendwise-api && npx tsc --noEmit` compiles without errors
2. GraphQL introspection shows netWorth query accepting TimeRange enum
3. toggleIncludeInNetWorth mutation exists in schema
4. backfillNetWorthSnapshots mutation exists in schema
5. Statement import resolver includes non-blocking snapshot trigger
</verification>

<success_criteria>
- netWorth query returns current value, changes, history, and account breakdown
- Credit accounts correctly subtracted as liabilities
- Cache keys include all filter parameters
- toggleIncludeInNetWorth flips boolean and invalidates cache
- backfillNetWorthSnapshots generates up to 24 months of monthly history
- Statement import triggers on-demand snapshot (non-blocking)
- All TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-net-worth-tracking/05-02-SUMMARY.md`
</output>
