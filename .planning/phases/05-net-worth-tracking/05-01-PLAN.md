---
phase: 05-net-worth-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spendwise/prisma/schema.prisma
  - spendwise-api/prisma/schema.prisma
  - spendwise-api/package.json
  - spendwise-api/src/lib/redis.ts
  - spendwise-api/src/lib/jobs/snapshotNetWorth.ts
  - spendwise-api/src/index.ts
autonomous: true

must_haves:
  truths:
    - "NetWorthSnapshot model exists in Prisma schema with userId, accountId, balance (Decimal 12,2), and date fields"
    - "Account model has includeInNetWorth Boolean field defaulting to true"
    - "BullMQ daily cron job is scheduled to capture all user snapshots at 2 AM"
    - "Snapshot job captures per-account balances for every user with includeInNetWorth enabled"
    - "Duplicate snapshots for same userId+accountId+date are prevented via unique constraint"
    - "BullMQ worker shuts down gracefully on SIGTERM/SIGINT"
  artifacts:
    - path: "spendwise/prisma/schema.prisma"
      provides: "NetWorthSnapshot model with composite indexes"
      contains: "model NetWorthSnapshot"
    - path: "spendwise-api/src/lib/jobs/snapshotNetWorth.ts"
      provides: "Snapshot capture logic and BullMQ queue/worker setup"
      exports: ["setupNetWorthSnapshotQueue", "captureUserSnapshot"]
    - path: "spendwise-api/src/index.ts"
      provides: "BullMQ worker initialization on server start"
      contains: "setupNetWorthSnapshotQueue"
  key_links:
    - from: "spendwise-api/src/index.ts"
      to: "spendwise-api/src/lib/jobs/snapshotNetWorth.ts"
      via: "import and call setupNetWorthSnapshotQueue()"
      pattern: "setupNetWorthSnapshotQueue"
    - from: "spendwise-api/src/lib/jobs/snapshotNetWorth.ts"
      to: "prisma.netWorthSnapshot"
      via: "Prisma createMany with skipDuplicates"
      pattern: "prisma\\.netWorthSnapshot\\.createMany"
---

<objective>
Extend Prisma schema with NetWorthSnapshot model and includeInNetWorth account field, install BullMQ, and set up daily scheduled snapshot job that captures per-account balances for all users.

Purpose: Foundation for net worth tracking — without snapshots, there is no historical data to chart or analyze.
Output: Database schema ready, BullMQ worker running on server start, daily snapshots scheduled.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-net-worth-tracking/05-RESEARCH.md
@.planning/phases/05-net-worth-tracking/05-CONTEXT.md

Key existing files:
@spendwise/prisma/schema.prisma
@spendwise-api/prisma/schema.prisma
@spendwise-api/src/lib/redis.ts
@spendwise-api/src/lib/jobs/cleanup2FA.ts
@spendwise-api/src/index.ts
@spendwise-api/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Prisma schema and install BullMQ</name>
  <files>
    spendwise/prisma/schema.prisma
    spendwise-api/prisma/schema.prisma
    spendwise-api/package.json
  </files>
  <action>
    1. Add `includeInNetWorth Boolean @default(true)` field to the Account model in BOTH prisma/schema.prisma files (spendwise/ and spendwise-api/). Place it after the existing `officialName` field, before `transactions`.

    2. Add NetWorthSnapshot model to BOTH schema files:
    ```
    model NetWorthSnapshot {
      id        String   @id @default(cuid())
      userId    String
      user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
      accountId String
      account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
      balance   Decimal  @db.Decimal(12, 2)
      date      DateTime @db.Date

      createdAt DateTime @default(now())

      @@unique([userId, accountId, date])
      @@index([userId, date])
      @@index([accountId, date])
    }
    ```

    3. Add relations to User model: `netWorthSnapshots NetWorthSnapshot[]`
    4. Add relation to Account model: `netWorthSnapshots NetWorthSnapshot[]`

    5. Use `@db.Date` (not `@db.Timestamp`) for the date field — snapshots are daily, only need date precision.

    6. Install BullMQ in spendwise-api/:
    ```bash
    cd spendwise-api && npm install bullmq
    ```

    7. Run `npx prisma db push` in BOTH spendwise/ and spendwise-api/ to apply schema changes.
    8. Run `npx prisma generate` in BOTH projects.

    IMPORTANT: Do NOT change the existing Redis client's `maxRetriesPerRequest: 3` setting — BullMQ will use its own Redis connection configured separately.
  </action>
  <verify>
    - `npx prisma validate` passes in both projects
    - `npx prisma db push` completes without errors in both projects
    - `node -e "require('bullmq')"` works in spendwise-api/
    - Schema includes NetWorthSnapshot model with @@unique([userId, accountId, date])
    - Account model has includeInNetWorth field
  </verify>
  <done>
    NetWorthSnapshot model exists with correct indexes and unique constraint. Account has includeInNetWorth field. BullMQ is installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BullMQ snapshot job and integrate with server</name>
  <files>
    spendwise-api/src/lib/jobs/snapshotNetWorth.ts
    spendwise-api/src/index.ts
  </files>
  <action>
    1. Create `spendwise-api/src/lib/jobs/snapshotNetWorth.ts`:

    - Import `Queue`, `Worker` from 'bullmq' and `Redis` from 'ioredis'
    - Create a SEPARATE Redis connection for BullMQ with `maxRetriesPerRequest: null` (do NOT reuse the existing redis.ts client which has maxRetriesPerRequest: 3). Use the same REDIS_URL env var.

    - Export `captureUserSnapshot(userId: string)`:
      - Fetch all accounts for user where `includeInNetWorth: true`
      - For each account, create snapshot with today's date (start of day UTC)
      - Use `prisma.netWorthSnapshot.createMany({ data: snapshots, skipDuplicates: true })` to handle duplicates
      - Log: `[NetWorth] Captured snapshot for user ${userId}: ${accounts.length} accounts`

    - Export `captureAllUserSnapshots()`:
      - Fetch all distinct userIds from Account table
      - For each userId, call captureUserSnapshot()
      - Log: `[NetWorth] Daily snapshot complete: ${userCount} users processed`

    - Export `setupNetWorthSnapshotQueue()`:
      - Create queue: `new Queue('net-worth-snapshots', { connection: bullmqRedis })`
      - Add daily repeating job: `queue.add('daily-snapshot', {}, { repeat: { pattern: '0 0 2 * * *' } })`
      - Create worker processing jobs:
        - 'daily-snapshot': call captureAllUserSnapshots()
        - 'on-demand-snapshot': call captureUserSnapshot(job.data.userId) — this job name will be used by the import trigger in Plan 02
      - Set up graceful shutdown on SIGTERM and SIGINT: await worker.close(), await queue.close()
      - Return { queue, worker } for reference
      - Log: `[NetWorth] Snapshot queue and worker initialized`

    - Export the queue instance so Plan 02 can import it to add on-demand jobs

    2. Update `spendwise-api/src/index.ts`:
    - Import `setupNetWorthSnapshotQueue` from `./lib/jobs/snapshotNetWorth`
    - Call `await setupNetWorthSnapshotQueue()` AFTER the httpServer starts listening (after the `console.log` line with the ready message)
    - Add a try/catch around it so BullMQ startup failure doesn't crash the server; log warning on failure

    IMPORTANT: The BullMQ Redis connection MUST have `maxRetriesPerRequest: null`. Create a new IORedis instance specifically for BullMQ. Do NOT modify the existing redis.ts export used by resolvers.
  </action>
  <verify>
    - `cd spendwise-api && npx tsc --noEmit` compiles without errors
    - Server starts without errors: `npm run dev` (check for "[NetWorth] Snapshot queue and worker initialized" in logs)
    - No Redis connection errors in logs
  </verify>
  <done>
    BullMQ daily snapshot job runs at 2 AM, worker processes jobs, graceful shutdown works, server.ts initializes queue on startup. On-demand snapshot job name ('on-demand-snapshot') is ready for Plan 02's import trigger.
  </done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes in both projects
2. `cd spendwise-api && npx tsc --noEmit` compiles without errors
3. Server starts and logs "[NetWorth] Snapshot queue and worker initialized"
4. NetWorthSnapshot model has @@unique([userId, accountId, date]) constraint
5. Account model has includeInNetWorth Boolean field
</verification>

<success_criteria>
- Prisma schema extended with NetWorthSnapshot model and includeInNetWorth field
- BullMQ installed and configured with separate Redis connection
- Daily snapshot job scheduled at 2 AM via cron pattern
- Worker processes both daily-snapshot and on-demand-snapshot jobs
- Graceful shutdown handlers prevent stalled jobs
- Server integrates snapshot queue on startup
</success_criteria>

<output>
After completion, create `.planning/phases/05-net-worth-tracking/05-01-SUMMARY.md`
</output>
