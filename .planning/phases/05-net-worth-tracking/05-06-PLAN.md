---
phase: 05-net-worth-tracking
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - spendwise/src/app/(dashboard)/net-worth/page.tsx
  - spendwise/src/components/dashboard/NetWorthSummaryCard.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Backfill button appears when user has accounts but insufficient historical coverage"
    - "Dashboard sparkline shows a recognizable mini graph, not just a dot"
  artifacts:
    - path: "spendwise/src/app/(dashboard)/net-worth/page.tsx"
      provides: "Improved backfill button visibility condition"
      contains: "backfill"
    - path: "spendwise/src/components/dashboard/NetWorthSummaryCard.tsx"
      provides: "Sparkline with minimum data point handling"
      contains: "dot"
  key_links:
    - from: "spendwise/src/components/dashboard/NetWorthSummaryCard.tsx"
      to: "recharts"
      via: "LineChart with sparse data handling"
      pattern: "sparklineData"
---

<objective>
Improve backfill button visibility logic and fix dashboard sparkline rendering for sparse data.

Purpose: Two UX issues need fixing. (1) The backfill button uses `hasAccounts && !hasHistory` which hides the button as soon as the daily cron creates any snapshot, even if only 1 day of history exists. Users need a way to generate deeper historical coverage. (2) The dashboard sparkline renders a single dot (or nothing) when only 1-2 data points exist, which doesn't look like a graph.

Output: Backfill button appears when history coverage is insufficient. Dashboard sparkline handles sparse data gracefully.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@spendwise/src/app/(dashboard)/net-worth/page.tsx
@spendwise/src/components/dashboard/NetWorthSummaryCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Improve backfill button condition to check for sufficient historical coverage</name>
  <files>spendwise/src/app/(dashboard)/net-worth/page.tsx</files>
  <action>
The current backfill button condition on line 83 is `{hasAccounts && !hasHistory}`. This hides the button as soon as a single snapshot exists (from the daily cron job), even if the user has months of transaction history that could be backfilled into deeper snapshots.

Change the condition to show the backfill button when history coverage is insufficient. The logic should be:

1. Keep the existing `hasAccounts` check.
2. Instead of `!hasHistory`, check if history has fewer data points than expected for reasonable coverage. A good threshold: show the button if history has fewer than 3 data points (meaning only a couple days of cron-generated snapshots exist, but no backfilled monthly history).
3. Additionally, add a small "Backfill History" text button below the time range buttons (inside the chart section) that is always visible when `hasAccounts` is true, so users can always trigger a backfill even after the initial banner disappears. This should be subtle â€” a small text link, not a prominent banner.

Implementation:
- Change line 83 from `{hasAccounts && !hasHistory && (` to `{hasAccounts && (!hasHistory || (netWorth?.history && netWorth.history.length < 3)) && (`
- Also update the banner text to be more helpful: "You have limited historical data. Generate monthly snapshots from your transaction history for a more complete trend."
- Add a subtle "Regenerate historical data" link below the chart time range selector. Place it inside the chart grid area (line 132-138), after the `<NetWorthChart>` component. Use a small text button styled as: `text-xs text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 cursor-pointer mt-2`. Wire it to the existing `handleBackfill` function. Show it only when `hasAccounts` is true and `!backfillLoading`. When loading, show "Generating..." text.
  </action>
  <verify>
1. `cd spendwise && npx tsc --noEmit` compiles without errors
2. Visual inspection: Banner shows when fewer than 3 history points exist
3. Visual inspection: Subtle "Regenerate historical data" link appears below chart
  </verify>
  <done>
Backfill banner appears for users with limited history (fewer than 3 data points). A persistent subtle link below the chart provides ongoing access to backfill functionality regardless of history length.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix dashboard sparkline to handle sparse data gracefully</name>
  <files>spendwise/src/components/dashboard/NetWorthSummaryCard.tsx</files>
  <action>
The dashboard sparkline renders poorly when only 1-2 data points exist because:
1. Recharts with `dot={false}` cannot draw a visible line from a single point
2. No minimum data point handling exists
3. No data padding for visual density

Fix the sparkline in NetWorthSummaryCard.tsx:

**1. Add minimum data point padding (in the sparklineData useMemo, around lines 47-55):**

After sorting the history data, if fewer than 2 points exist, pad the data to create a visible line:
- If 0 points: return empty array (no sparkline shown, which is correct)
- If 1 point: duplicate the single point to create a flat line (two identical values). This makes Recharts draw a visible horizontal line instead of an invisible dot.
- If 2+ points: use as-is

```typescript
const sparklineData = useMemo(() => {
  if (!netWorth?.history || netWorth.history.length === 0) {
    return [];
  }

  const sorted = [...netWorth.history]
    .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())
    .map((item) => ({ value: item.value }));

  // Pad sparse data for visual density
  if (sorted.length === 1) {
    // Duplicate single point to draw a flat line
    return [sorted[0], sorted[0]];
  }

  return sorted;
}, [netWorth]);
```

**2. Enable dot rendering for sparse data (around line 216):**

Change the `dot` prop on the Line component from `dot={false}` to conditionally show dots when data is sparse:
```tsx
dot={sparklineData.length <= 3 ? { r: 2, fill: sparklineColor } : false}
```

This shows small dots when there are 1-3 data points (making them visible) but hides dots for normal-density data to keep the chart clean.

**3. Add a subtle fill/area effect to make the sparkline more visually recognizable as a chart:**

Import `Area` from recharts alongside `Line`:
```tsx
import { LineChart, Line, ResponsiveContainer, Area, AreaChart } from 'recharts';
```

Replace the `<LineChart>` with `<AreaChart>` to add a subtle fill under the line, making even sparse data look more chart-like:
```tsx
<AreaChart data={sparklineData}>
  <defs>
    <linearGradient id="sparklineGradient" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stopColor={sparklineColor} stopOpacity={0.2} />
      <stop offset="100%" stopColor={sparklineColor} stopOpacity={0} />
    </linearGradient>
  </defs>
  <Area
    type="monotone"
    dataKey="value"
    stroke={sparklineColor}
    strokeWidth={2}
    fill="url(#sparklineGradient)"
    dot={sparklineData.length <= 3 ? { r: 2, fill: sparklineColor } : false}
    isAnimationActive={false}
  />
</AreaChart>
```

This replaces the LineChart+Line with AreaChart+Area, giving a filled gradient beneath the line that makes even a single horizontal line look recognizably like a chart/graph.
  </action>
  <verify>
1. `cd spendwise && npx tsc --noEmit` compiles without errors
2. Visual inspection: With 1 data point, sparkline shows a visible horizontal line with gradient fill (not just a dot)
3. Visual inspection: With many data points, sparkline shows normal area chart with gradient fill
  </verify>
  <done>
Dashboard sparkline handles sparse data gracefully: single points render as visible horizontal lines with gradient fill, 2-3 points show dots for visibility, and all data renders as a recognizable area chart with gradient fill beneath the trend line.
  </done>
</task>

</tasks>

<verification>
1. `cd spendwise && npx tsc --noEmit` passes
2. Net worth page shows backfill banner when history has < 3 data points
3. Net worth page shows subtle "Regenerate historical data" link below chart
4. Dashboard sparkline renders as recognizable area chart even with 1-2 data points
5. Dashboard sparkline with many points shows clean area chart without excessive dots
</verification>

<success_criteria>
- Backfill button visible for users with limited historical data (< 3 snapshots)
- Persistent subtle backfill link available below chart for all users with accounts
- Dashboard sparkline renders as recognizable graph (area chart with gradient) regardless of data point count
- Single data point shows as horizontal line with fill, not invisible dot
- TypeScript compilation passes for both changed files
</success_criteria>

<output>
After completion, create `.planning/phases/05-net-worth-tracking/05-06-SUMMARY.md`
</output>
