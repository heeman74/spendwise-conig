---
phase: 01-database-schema-encryption
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spendwise/prisma/schema.prisma
  - spendwise-api/prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Schema includes PlaidItem model with accessToken, plaidItemId, status fields"
    - "Schema includes InvestmentHolding model linked to Account and Security"
    - "Schema includes Security model with plaidSecurityId, tickerSymbol, type, closePrice"
    - "Schema includes RecurringTransaction model with plaidStreamId, frequency, amounts"
    - "Account model has optional Plaid fields (plaidAccountId, plaidItemId, isLinked, mask, officialName)"
    - "Transaction model has optional Plaid fields (plaidTransactionId, pending, personalFinanceCategory, paymentChannel)"
    - "User model has plaidItems relation"
    - "All Plaid-specific fields are optional so manual accounts continue to work"
  artifacts:
    - path: "spendwise/prisma/schema.prisma"
      provides: "Extended schema with Plaid models"
      contains: "model PlaidItem"
    - path: "spendwise-api/prisma/schema.prisma"
      provides: "Identical copy of extended schema"
      contains: "model PlaidItem"
  key_links:
    - from: "Account"
      to: "PlaidItem"
      via: "plaidItemId optional foreign key"
      pattern: "plaidItem.*PlaidItem.*@relation"
    - from: "InvestmentHolding"
      to: "Account"
      via: "accountId foreign key"
      pattern: "account.*Account.*@relation"
    - from: "InvestmentHolding"
      to: "Security"
      via: "securityId foreign key"
      pattern: "security.*Security.*@relation"
    - from: "RecurringTransaction"
      to: "User"
      via: "userId foreign key"
      pattern: "user.*User.*@relation"
    - from: "PlaidItem"
      to: "User"
      via: "userId foreign key"
      pattern: "user.*User.*@relation"
---

<objective>
Extend the Prisma schema with four new models (PlaidItem, InvestmentHolding, Security, RecurringTransaction) and add optional Plaid integration fields to existing Account and Transaction models. Both spendwise/ and spendwise-api/ share identical schema files.

Purpose: Create the database foundation for Plaid financial data integration while preserving full backward compatibility with existing manual accounts and transactions.
Output: Updated prisma/schema.prisma in both projects with new models and extended existing models. Database migrated with new tables and columns.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-schema-encryption/01-RESEARCH.md
@spendwise-api/prisma/schema.prisma
@spendwise-api/src/lib/prisma.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new Plaid models and extend existing models in schema</name>
  <files>spendwise/prisma/schema.prisma, spendwise-api/prisma/schema.prisma</files>
  <action>
Edit spendwise/prisma/schema.prisma to add the following changes. Then copy the identical file to spendwise-api/prisma/schema.prisma.

1. Add `plaidItems PlaidItem[]` and `recurringTransactions RecurringTransaction[]` relations to the User model.

2. Add these optional fields to the Account model (AFTER existing fields, BEFORE relations):
   - `plaidAccountId  String?` with comment "Plaid's unique account identifier"
   - `plaidItemId     String?` with comment "Links to PlaidItem"
   - `plaidItem       PlaidItem?  @relation(fields: [plaidItemId], references: [id])` relation
   - `isLinked        Boolean     @default(false)` with comment "Manual vs Plaid-linked"
   - `mask            String?` with comment "Last 4 digits"
   - `officialName    String?` with comment "Institution's official account name"
   - Add `holdings InvestmentHolding[]` relation
   - Add `@@index([plaidAccountId])` index

3. Add these optional fields to the Transaction model (AFTER existing fields, BEFORE createdAt):
   - `plaidTransactionId    String?    @unique` with comment "Plaid's unique transaction identifier"
   - `pending               Boolean    @default(false)` with comment "Pending vs posted"
   - `personalFinanceCategory String?` with comment "Enhanced categorization from Plaid"
   - `paymentChannel        String?` with comment "online, in store, other"
   - Add `@@index([plaidTransactionId])` index

4. Add the PlaidItem model:
   ```
   model PlaidItem {
     id                    String    @id @default(cuid())
     userId                String
     user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
     accessToken           String    /// @encrypted
     accessTokenHash       String?   /// @encryption:hash(accessToken)
     plaidItemId           String    @unique
     plaidInstitutionId    String
     institutionName       String
     status                String    @default("active") // "active", "error", "pending_disconnect"
     transactionsCursor    String?
     consentExpirationTime DateTime?
     accounts              Account[]
     createdAt             DateTime  @default(now())
     updatedAt             DateTime  @updatedAt
     @@index([userId])
     @@index([plaidItemId])
     @@index([status])
   }
   ```
   IMPORTANT: The `/// @encrypted` and `/// @encryption:hash(accessToken)` are triple-slash doc comments that prisma-field-encryption reads. They MUST be triple-slash (///) not double-slash (//).

5. Add the Security model:
   ```
   model Security {
     id                String              @id @default(cuid())
     plaidSecurityId   String              @unique
     name              String
     tickerSymbol      String?
     type              String              // "equity", "etf", "mutual fund", "cash", "bond"
     closePrice        Decimal?            @db.Decimal(12, 4)
     closePriceAsOf    DateTime?
     sector            String?
     industry          String?
     holdings          InvestmentHolding[]
     createdAt         DateTime            @default(now())
     updatedAt         DateTime            @updatedAt
     @@index([plaidSecurityId])
     @@index([tickerSymbol])
   }
   ```

6. Add the InvestmentHolding model:
   ```
   model InvestmentHolding {
     id                String   @id @default(cuid())
     accountId         String
     account           Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
     securityId        String
     security          Security @relation(fields: [securityId], references: [id])
     quantity          Decimal  @db.Decimal(12, 6)
     institutionPrice  Decimal  @db.Decimal(12, 4)
     institutionValue  Decimal  @db.Decimal(12, 2)
     costBasis         Decimal? @db.Decimal(12, 2)
     isoCurrencyCode   String?
     createdAt         DateTime @default(now())
     updatedAt         DateTime @updatedAt
     @@index([accountId])
     @@index([securityId])
   }
   ```

7. Add the RecurringTransaction model:
   ```
   model RecurringTransaction {
     id                String   @id @default(cuid())
     userId            String
     user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
     plaidStreamId     String   @unique
     description       String
     merchantName      String?
     category          String
     frequency         String   // "WEEKLY", "BIWEEKLY", "MONTHLY", "SEMI_MONTHLY", "ANNUALLY"
     isActive          Boolean  @default(true)
     lastAmount        Decimal  @db.Decimal(12, 2)
     averageAmount     Decimal  @db.Decimal(12, 2)
     lastDate          DateTime
     firstDate         DateTime
     transactionIds    String[] // Array of transaction IDs in this stream
     createdAt         DateTime @default(now())
     updatedAt         DateTime @updatedAt
     @@index([userId])
     @@index([plaidStreamId])
   }
   ```

After editing spendwise/prisma/schema.prisma, copy the exact same file to spendwise-api/prisma/schema.prisma so both are identical.

CRITICAL: All new fields on existing models (Account, Transaction) MUST be optional (String?, Boolean with @default, etc.) to preserve backward compatibility with manual accounts. Do NOT make any Plaid field required.
  </action>
  <verify>
1. Run `diff spendwise/prisma/schema.prisma spendwise-api/prisma/schema.prisma` - should show no differences
2. Run `cd spendwise && npx prisma validate` - should succeed with no errors
3. Run `cd spendwise-api && npx prisma validate` - should succeed with no errors
4. Verify PlaidItem model has `/// @encrypted` triple-slash comment on accessToken field
5. Verify all new Account fields are optional (String? or Boolean with @default)
  </verify>
  <done>
Both schema files are identical, pass Prisma validation, contain PlaidItem (with encrypted accessToken annotation), Security, InvestmentHolding, RecurringTransaction models, and Account/Transaction have optional Plaid fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply database migration</name>
  <files>spendwise/prisma/migrations/</files>
  <action>
Run the Prisma migration from the spendwise/ directory (which is the canonical schema location shared by both projects).

1. Ensure Docker is running with PostgreSQL available on port 5433:
   `cd spendwise && docker-compose up -d`

2. Generate the Prisma client and create migration:
   `cd spendwise && npx prisma migrate dev --name add_plaid_models`

   This will:
   - Create a new migration file in spendwise/prisma/migrations/
   - Apply the migration to the PostgreSQL database
   - Regenerate the Prisma client

3. Also regenerate the API's Prisma client:
   `cd spendwise-api && npx prisma generate`

4. Verify the migration applied correctly by checking the database has the new tables:
   `cd spendwise && npx prisma db execute --stdin <<< "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' ORDER BY table_name;"` or use `npx prisma studio` to visually confirm.

If the migration fails because Docker/PostgreSQL is not running, use `npx prisma db push` as a fallback (it applies schema changes without creating migration files, acceptable for development).

IMPORTANT: If existing tests use the database, make sure the migration doesn't break them. The migration only adds optional columns and new tables, so existing data should be unaffected.
  </action>
  <verify>
1. Migration file exists in spendwise/prisma/migrations/
2. `cd spendwise && npx prisma generate` succeeds
3. `cd spendwise-api && npx prisma generate` succeeds
4. Database contains tables: PlaidItem, Security, InvestmentHolding, RecurringTransaction (in addition to existing tables)
5. Account table has columns: plaidAccountId, plaidItemId, isLinked, mask, officialName
6. Transaction table has columns: plaidTransactionId, pending, personalFinanceCategory, paymentChannel
  </verify>
  <done>
Database migration applied successfully. New tables (PlaidItem, Security, InvestmentHolding, RecurringTransaction) exist in PostgreSQL. Existing tables (Account, Transaction) have new optional Plaid columns. Prisma client regenerated for both projects.
  </done>
</task>

</tasks>

<verification>
1. Both prisma/schema.prisma files are identical (diff shows no differences)
2. `npx prisma validate` passes in both projects
3. Prisma client generated successfully in both projects
4. New database tables exist: PlaidItem, Security, InvestmentHolding, RecurringTransaction
5. Existing Account and Transaction tables have new optional columns
6. No existing functionality is broken (all new fields are optional)
</verification>

<success_criteria>
- Four new Prisma models exist: PlaidItem, InvestmentHolding, Security, RecurringTransaction
- Account model has optional plaidAccountId, plaidItemId, isLinked, mask, officialName fields
- Transaction model has optional plaidTransactionId, pending, personalFinanceCategory, paymentChannel fields
- User model has plaidItems and recurringTransactions relations
- PlaidItem.accessToken has `/// @encrypted` annotation for prisma-field-encryption
- All Plaid fields are optional (manual accounts unaffected)
- Database migration applied, all tables created
- Both spendwise/ and spendwise-api/ schemas are identical
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-schema-encryption/01-01-SUMMARY.md`
</output>
