---
phase: 02-plaid-integration-foundation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - spendwise-api/src/routes/plaid-webhooks.ts
  - spendwise-api/src/lib/plaid-webhooks.ts
  - spendwise-api/src/index.ts
  - spendwise-api/package.json
autonomous: true

must_haves:
  truths:
    - "POST /webhooks/plaid endpoint accepts Plaid webhook payloads"
    - "Webhook signature is verified using jose JWT verification before processing"
    - "ITEM ERROR webhook with ITEM_LOGIN_REQUIRED updates PlaidItem status to 'error'"
    - "LOGIN_REPAIRED webhook updates PlaidItem status back to 'active'"
    - "Invalid or expired webhooks are rejected with 401"
  artifacts:
    - path: "spendwise-api/src/lib/plaid-webhooks.ts"
      provides: "Webhook JWT verification logic"
      exports: ["verifyPlaidWebhook"]
    - path: "spendwise-api/src/routes/plaid-webhooks.ts"
      provides: "Express route handler for /webhooks/plaid"
      exports: ["plaidWebhookRouter"]
  key_links:
    - from: "spendwise-api/src/routes/plaid-webhooks.ts"
      to: "spendwise-api/src/lib/plaid-webhooks.ts"
      via: "import verifyPlaidWebhook"
      pattern: "import.*verifyPlaidWebhook"
    - from: "spendwise-api/src/routes/plaid-webhooks.ts"
      to: "prisma.plaidItem"
      via: "status update on webhook"
      pattern: "prisma\\.plaidItem\\.update"
    - from: "spendwise-api/src/index.ts"
      to: "spendwise-api/src/routes/plaid-webhooks.ts"
      via: "app.use route registration"
      pattern: "app\\.use.*plaidWebhook"
---

<objective>
Create the Plaid webhook endpoint that receives and verifies Plaid webhook notifications, updating PlaidItem connection status when institutions report errors or repairs.

Purpose: Webhooks are the mechanism by which Plaid notifies the app of connection status changes (ITEM_LOGIN_REQUIRED, LOGIN_REPAIRED). Without this, the app cannot detect broken connections and prompt re-authentication.

Output: A verified, secure webhook endpoint registered on the Express server that handles ITEM-type webhooks.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-plaid-integration-foundation/02-RESEARCH.md
@spendwise-api/src/index.ts
@spendwise-api/src/lib/plaid-client.ts
@spendwise-api/src/lib/prisma.ts
@spendwise-api/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhook verification utility and route handler</name>
  <files>
    spendwise-api/package.json
    spendwise-api/src/lib/plaid-webhooks.ts
    spendwise-api/src/routes/plaid-webhooks.ts
  </files>
  <action>
    Install webhook verification dependencies:
    ```bash
    cd spendwise-api && npm install jose js-sha256
    ```

    **Create `spendwise-api/src/lib/plaid-webhooks.ts`:**

    Implement Plaid webhook JWT verification following Plaid's official pattern:

    1. Extract `plaid-verification` header from request
    2. Decode the JWT header (without verification) to get the `kid` (key ID)
    3. Use `plaidClient.webhookVerificationKeyGet({ key_id: kid })` to fetch the JWK from Plaid
    4. Import the JWK using `jose.importJWK(jwk)`
    5. Verify the JWT signature using `jose.jwtVerify(signedJwt, publicKey, { algorithms: ['ES256'] })`
    6. Check that `iat` claim is less than 5 minutes old (300 seconds)
    7. Compute SHA-256 hash of the request body string using `sha256` from 'js-sha256'
    8. Compare computed hash against `request_body_sha256` claim in JWT payload
    9. Return true if all checks pass, throw error otherwise

    Export as `verifyPlaidWebhook(body: string, headers: Record<string, string | string[] | undefined>): Promise<boolean>`

    **Important:** The jose library's `decodeProtectedHeader` function should be used to extract `kid` from the JWT without verification first. The `jwtVerify` call should use `{ algorithms: ['ES256'] }` as Plaid uses ES256.

    **Create `spendwise-api/src/routes/plaid-webhooks.ts`:**

    Create a new directory `spendwise-api/src/routes/` if it doesn't exist.

    Create an Express Router with a POST handler:

    ```typescript
    import { Router } from 'express';
    import express from 'express';
    import { verifyPlaidWebhook } from '../lib/plaid-webhooks';
    import { prisma } from '../lib/prisma';

    export const plaidWebhookRouter = Router();

    // Use raw body parser for webhook verification (need original body string for hash)
    plaidWebhookRouter.post(
      '/webhooks/plaid',
      express.raw({ type: 'application/json' }),
      async (req, res) => {
        // ... handler
      }
    );
    ```

    Handler logic:
    1. Get body as string: `const bodyString = Buffer.isBuffer(req.body) ? req.body.toString('utf8') : JSON.stringify(req.body);`
    2. Verify webhook signature (wrap in try/catch, return 401 on failure)
    3. Parse the body as JSON
    4. Extract `webhook_type`, `webhook_code`, `item_id` from parsed body
    5. Handle ITEM webhooks:
       - `webhook_type === 'ITEM' && webhook_code === 'ERROR'`: Check if `error.error_code === 'ITEM_LOGIN_REQUIRED'`. If so, update PlaidItem where `plaidItemId === item_id` to `status: 'error'`. Log the error.
       - `webhook_type === 'ITEM' && webhook_code === 'LOGIN_REPAIRED'`: Update PlaidItem where `plaidItemId === item_id` to `status: 'active'`. Log the repair.
       - `webhook_type === 'ITEM' && webhook_code === 'PENDING_EXPIRATION'`: Update PlaidItem to `status: 'pending_disconnect'`. Log the warning.
    6. For all other webhook types (TRANSACTIONS, HOLDINGS, etc.): Log the webhook type/code for future implementation but return 200 OK.
    7. Always return 200 OK to Plaid (even for unhandled types) to prevent retries.

    Add console.log statements for all webhook events for debugging (prefix with `[Plaid Webhook]`).
  </action>
  <verify>
    ```bash
    cd spendwise-api && npx tsc --noEmit
    ```
    TypeScript compiles. Routes directory and both files exist.
  </verify>
  <done>Webhook verification utility correctly implements Plaid's JWT verification flow. Route handler processes ITEM webhooks and updates PlaidItem status accordingly.</done>
</task>

<task type="auto">
  <name>Task 2: Register webhook route in Express server</name>
  <files>
    spendwise-api/src/index.ts
  </files>
  <action>
    Modify `spendwise-api/src/index.ts` to register the webhook route:

    1. Import `plaidWebhookRouter` from './routes/plaid-webhooks'
    2. Register the webhook route BEFORE the GraphQL middleware (before `app.use('/graphql', ...)`) because the webhook needs its own body parser (raw) and must not go through the GraphQL JSON parser
    3. Add: `app.use(plaidWebhookRouter);`
    4. Place it after the `const app = express();` line but before the Apollo middleware setup

    **Critical:** The webhook route uses `express.raw()` for body parsing (needed for signature verification), NOT `express.json()`. This is why it must be registered separately from the GraphQL middleware which uses `express.json()`. Do NOT add a global `express.json()` or `express.raw()` middleware -- each route handles its own body parsing.

    **Also important:** The webhook endpoint is unauthenticated (Plaid calls it, not users). Authentication is handled via webhook JWT verification, not the app's auth system.
  </action>
  <verify>
    ```bash
    cd spendwise-api && npx tsc --noEmit && npm test
    ```
    TypeScript compiles. All existing tests still pass. The webhook route is registered before GraphQL middleware.
  </verify>
  <done>
    POST /webhooks/plaid is accessible on the Express server. Webhook handler runs before GraphQL middleware. Server starts without errors.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in spendwise-api
- `npm test` passes (all existing tests still green)
- jose and js-sha256 packages are in package.json
- `/webhooks/plaid` route is registered before GraphQL middleware
- Webhook verification function implements JWT + body hash check
- ITEM ERROR and LOGIN_REPAIRED webhooks update PlaidItem status
- Unhandled webhook types return 200 OK (no retries)
</verification>

<success_criteria>
- jose and js-sha256 installed
- Webhook verification implements Plaid's full JWT verification flow (key fetch, signature verify, timestamp check, body hash)
- Express route handler at POST /webhooks/plaid
- ITEM_LOGIN_REQUIRED sets status to 'error'
- LOGIN_REPAIRED sets status to 'active'
- PENDING_EXPIRATION sets status to 'pending_disconnect'
- Route registered before GraphQL middleware in server
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-plaid-integration-foundation/02-02-SUMMARY.md`
</output>
