---
phase: 02-plaid-integration-foundation
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - spendwise/package.json
  - spendwise/src/graphql/queries/plaid.ts
  - spendwise/src/graphql/queries/index.ts
  - spendwise/src/graphql/mutations/plaid.ts
  - spendwise/src/graphql/mutations/index.ts
  - spendwise/src/hooks/usePlaid.ts
  - spendwise/src/hooks/index.ts
  - spendwise/src/components/plaid/PlaidLinkButton.tsx
  - spendwise/src/components/plaid/LinkSuccessModal.tsx
autonomous: true

must_haves:
  truths:
    - "User can click 'Connect Bank' button which opens Plaid Link UI"
    - "After successful bank connection, user sees a success summary showing institution name and accounts found"
    - "Success summary includes 'Connect Another Bank' button for chaining multiple institutions"
    - "During token exchange, user sees a loading state ('Connecting your accounts...')"
    - "On Link failure or cancel, user sees a toast notification and stays on current page"
  artifacts:
    - path: "spendwise/src/components/plaid/PlaidLinkButton.tsx"
      provides: "Reusable button component that opens Plaid Link"
      min_lines: 30
    - path: "spendwise/src/components/plaid/LinkSuccessModal.tsx"
      provides: "Success summary modal showing connected institution and accounts"
      min_lines: 40
    - path: "spendwise/src/hooks/usePlaid.ts"
      provides: "Custom hooks wrapping Plaid GraphQL operations"
      exports: ["usePlaidLink", "usePlaidItems", "useExchangePublicToken", "useUnlinkItem", "useUpdateItemStatus"]
    - path: "spendwise/src/graphql/queries/plaid.ts"
      provides: "GraphQL query documents for Plaid operations"
      contains: "GET_PLAID_ITEMS"
    - path: "spendwise/src/graphql/mutations/plaid.ts"
      provides: "GraphQL mutation documents for Plaid operations"
      contains: "CREATE_LINK_TOKEN"
  key_links:
    - from: "spendwise/src/components/plaid/PlaidLinkButton.tsx"
      to: "spendwise/src/hooks/usePlaid.ts"
      via: "hook consumption"
      pattern: "usePlaidLink|useCreateLinkToken"
    - from: "spendwise/src/hooks/usePlaid.ts"
      to: "spendwise/src/graphql/mutations/plaid.ts"
      via: "Apollo mutation"
      pattern: "useMutation.*CREATE_LINK_TOKEN|EXCHANGE_PUBLIC_TOKEN"
    - from: "spendwise/src/components/plaid/PlaidLinkButton.tsx"
      to: "react-plaid-link"
      via: "usePlaidLink hook from library"
      pattern: "usePlaidLink.*from.*react-plaid-link"
---

<objective>
Build the frontend Plaid Link integration: install react-plaid-link, create GraphQL query/mutation documents, create custom hooks, and build the PlaidLinkButton and LinkSuccessModal components.

Purpose: This is the user-facing flow for connecting financial institutions. The PlaidLinkButton opens Plaid's Link UI, handles the token exchange on success, and shows a success summary. These components will be consumed by the accounts page and settings page in later plans.

Output: Reusable PlaidLinkButton component, LinkSuccessModal, custom hooks, and GraphQL documents for all Plaid operations.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-plaid-integration-foundation/02-CONTEXT.md
@.planning/phases/02-plaid-integration-foundation/02-RESEARCH.md
@.planning/phases/02-plaid-integration-foundation/02-01-SUMMARY.md
@spendwise/src/hooks/useAccounts.ts
@spendwise/src/graphql/queries/accounts.ts
@spendwise/src/graphql/mutations/accounts.ts
@spendwise/src/graphql/queries/index.ts
@spendwise/src/graphql/mutations/index.ts
@spendwise/src/hooks/index.ts
@spendwise/src/components/ui/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-plaid-link and create GraphQL documents + hooks</name>
  <files>
    spendwise/package.json
    spendwise/src/graphql/queries/plaid.ts
    spendwise/src/graphql/queries/index.ts
    spendwise/src/graphql/mutations/plaid.ts
    spendwise/src/graphql/mutations/index.ts
    spendwise/src/hooks/usePlaid.ts
    spendwise/src/hooks/index.ts
  </files>
  <action>
    Install react-plaid-link:
    ```bash
    cd spendwise && npm install react-plaid-link
    ```

    **Create `spendwise/src/graphql/queries/plaid.ts`:**
    ```typescript
    import { gql } from '@apollo/client';

    export const GET_PLAID_ITEMS = gql`
      query GetPlaidItems {
        plaidItems {
          id
          plaidInstitutionId
          institutionName
          status
          consentExpirationTime
          accounts {
            id
            name
            officialName
            mask
            type
            balance
            isLinked
            lastSynced
          }
          createdAt
          updatedAt
        }
      }
    `;
    ```

    **Create `spendwise/src/graphql/mutations/plaid.ts`:**
    ```typescript
    import { gql } from '@apollo/client';

    export const CREATE_LINK_TOKEN = gql`
      mutation CreateLinkToken($itemId: String) {
        createLinkToken(itemId: $itemId) {
          linkToken
          expiration
        }
      }
    `;

    export const EXCHANGE_PUBLIC_TOKEN = gql`
      mutation ExchangePublicToken($input: ExchangePublicTokenInput!) {
        exchangePublicToken(input: $input) {
          plaidItem {
            id
            institutionName
            status
            accounts {
              id
              name
              officialName
              mask
              type
              balance
            }
          }
          accountsCreated
        }
      }
    `;

    export const UNLINK_ITEM = gql`
      mutation UnlinkItem($itemId: ID!, $keepAsManual: Boolean!) {
        unlinkItem(itemId: $itemId, keepAsManual: $keepAsManual) {
          success
          accountsAffected
          keptAsManual
        }
      }
    `;

    export const UPDATE_ITEM_STATUS = gql`
      mutation UpdateItemStatus($itemId: ID!, $status: String!) {
        updateItemStatus(itemId: $itemId, status: $status) {
          id
          status
        }
      }
    `;
    ```

    **Update index files** to export the new queries and mutations. Follow the existing pattern in each index.ts (re-export all from the file).

    **Create `spendwise/src/hooks/usePlaid.ts`:**

    Follow the pattern from useAccounts.ts. Mark as 'use client'.

    Create these hooks:

    **`useCreateLinkToken(itemId?: string)`** - Uses useQuery for CREATE_LINK_TOKEN mutation. Wait -- actually, link token creation should be a query or a lazy query since we need it before opening Link. Use `useMutation` for createLinkToken and call it to get the token, OR use `useQuery` if the backend exposes it as a query. Since the backend has it as a Mutation (because it has side effects -- creates a token), use `useMutation` with a manual trigger pattern. Actually, to keep it simple and match Plaid's pattern where you fetch a token then open Link:

    Use `useMutation` for CREATE_LINK_TOKEN. The hook should:
    1. Call the mutation to get a link token
    2. Return `{ createLinkToken, linkToken, loading, error }`

    **`usePlaidItems()`** - Uses useQuery for GET_PLAID_ITEMS with 'cache-and-network' policy. Returns `{ plaidItems, loading, error, refetch }`.

    **`useExchangePublicToken()`** - Uses useMutation for EXCHANGE_PUBLIC_TOKEN. On completion, refetch GetPlaidItems and GetAccounts queries. Returns `{ exchangePublicToken, loading, error, data }`.

    **`useUnlinkItem()`** - Uses useMutation for UNLINK_ITEM. On completion, refetch GetPlaidItems and GetAccounts. Returns `{ unlinkItem, loading, error }`.

    **`useUpdateItemStatus()`** - Uses useMutation for UPDATE_ITEM_STATUS. On completion, refetch GetPlaidItems. Returns `{ updateItemStatus, loading, error }`.

    **Update `spendwise/src/hooks/index.ts`** to export all hooks from usePlaid.ts.
  </action>
  <verify>
    ```bash
    cd spendwise && npx tsc --noEmit
    ```
    TypeScript compiles. react-plaid-link is in package.json. All GraphQL documents and hooks are importable from their index files.
  </verify>
  <done>GraphQL documents for all Plaid operations exist. Five custom hooks available for Plaid operations. react-plaid-link installed. All exports registered in index files.</done>
</task>

<task type="auto">
  <name>Task 2: Create PlaidLinkButton and LinkSuccessModal components</name>
  <files>
    spendwise/src/components/plaid/PlaidLinkButton.tsx
    spendwise/src/components/plaid/LinkSuccessModal.tsx
  </files>
  <action>
    Create `spendwise/src/components/plaid/` directory.

    **Create `spendwise/src/components/plaid/PlaidLinkButton.tsx`:**

    'use client' component that orchestrates the full Plaid Link flow:

    Props:
    ```typescript
    interface PlaidLinkButtonProps {
      mode?: 'create' | 'update';
      itemId?: string;         // Required for update mode (re-auth)
      onSuccess?: (result: ExchangeResult) => void;
      onExit?: () => void;
      className?: string;
      children?: React.ReactNode;
    }
    ```

    Implementation:
    1. State: `linkToken` (string | null), `isExchanging` (boolean), `successResult` (exchange result | null), `showSuccess` (boolean)
    2. On mount (useEffect), call `createLinkToken` mutation (passing itemId if update mode) to get a link token. Store in state.
    3. Use `usePlaidLink` hook from 'react-plaid-link' with:
       - `token: linkToken`
       - `onSuccess: async (public_token, metadata) => { ... }`
       - `onExit: (error, metadata) => { ... }`
    4. onSuccess handler:
       - If mode === 'create': Set isExchanging true, show loading overlay. Call exchangePublicToken with publicToken, institutionId (metadata.institution.institution_id), institutionName (metadata.institution.name). On success: set successResult, set showSuccess true, call props.onSuccess. On error: show toast.
       - If mode === 'update': Call updateItemStatus to set status to 'active'. Show toast "Connection restored!". Call props.onSuccess.
       - Always set isExchanging false when done.
    5. onExit handler:
       - If error exists: show toast with error message (e.g., "Connection cancelled" or error.display_message)
       - If error.error_code === 'INVALID_LINK_TOKEN': refetch link token
       - Call props.onExit if provided

    Render:
    - If isExchanging: render a full-page overlay with "Connecting your accounts..." text and a spinner (use Tailwind for styling: fixed inset-0, bg-white/80, flex items-center justify-center, z-50)
    - If showSuccess: render `<LinkSuccessModal>` with successResult data
    - Default: render a button that calls `open()` when clicked, disabled when `!ready || !linkToken`
    - Button text: props.children ?? (mode === 'create' ? 'Connect Bank' : 'Re-authenticate')
    - Style: Use Tailwind classes matching existing UI patterns (check existing button styles in the codebase). Default to a primary button style (bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700)

    **Create `spendwise/src/components/plaid/LinkSuccessModal.tsx`:**

    'use client' component that shows a success summary after connecting an institution.

    Props:
    ```typescript
    interface LinkSuccessModalProps {
      institutionName: string;
      accounts: Array<{
        id: string;
        name: string;
        officialName?: string;
        mask?: string;
        type: string;
        balance: number;
      }>;
      onDone: () => void;
      onConnectAnother: () => void;
    }
    ```

    Render a modal/overlay (use same overlay pattern: fixed inset-0, z-50) with:
    - Title: "Connected {institutionName}!" with a check icon
    - Subtitle: "Found {accounts.length} account(s)"
    - List of accounts showing: name, type badge (Checking/Savings/Credit/Investment), last 4 digits (mask), balance formatted as currency
    - "Connect Another Bank" button (secondary style) -- calls onConnectAnother
    - "Done" button (primary style) -- calls onDone

    Style with Tailwind: centered card on overlay, rounded-xl shadow-xl, white background, max-w-md. Account list with divide-y. Type badges with colored backgrounds (green for checking, blue for savings, red/orange for credit, purple for investment).

    **Important notes:**
    - Both components must be 'use client'
    - Do NOT import or use any toast library that doesn't already exist in the project. Check if sonner, react-hot-toast, or similar is installed. If not, use a simple state-based notification or console.log as placeholder and note it in the summary.
    - Use the existing Tailwind configuration and color scheme. Check tailwind.config.ts for custom colors.
  </action>
  <verify>
    ```bash
    cd spendwise && npx tsc --noEmit
    ```
    TypeScript compiles. Both components exist in src/components/plaid/. Components use react-plaid-link's usePlaidLink hook. Components use custom hooks from usePlaid.ts.
  </verify>
  <done>
    PlaidLinkButton component handles the full Link flow (token creation, Link open, token exchange, success/error). LinkSuccessModal shows connected institution with account details and "Connect Another" option. Both components are reusable and accept callback props for integration into any page.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in spendwise
- react-plaid-link is in package.json
- GraphQL documents match the backend schema from Plan 01
- All hooks follow the useAccounts.ts pattern (useQuery/useMutation wrappers)
- PlaidLinkButton handles both create and update modes
- LinkSuccessModal displays institution name, account count, and account details
- "Connect Another Bank" button is present in success modal
- Loading overlay appears during token exchange
- No access_token or sensitive data referenced in frontend code
</verification>

<success_criteria>
- react-plaid-link installed
- 5 GraphQL documents (1 query, 4 mutations) matching backend schema
- 5 custom hooks wrapping Apollo Client operations
- PlaidLinkButton component handles create + update modes
- LinkSuccessModal shows success summary with accounts
- Components are reusable (accept props, callbacks)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-plaid-integration-foundation/02-03-SUMMARY.md`
</output>
