---
phase: 02-plaid-integration-foundation
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - spendwise/src/app/(dashboard)/accounts/page.tsx
  - spendwise/src/components/accounts/AccountCard.tsx
  - spendwise/src/components/accounts/AccountList.tsx
  - spendwise/src/components/accounts/AccountTypeGroup.tsx
  - spendwise/src/components/accounts/BalanceSummary.tsx
autonomous: false

must_haves:
  truths:
    - "Accounts page groups all accounts by type (Checking, Savings, Credit, Investment) not by institution"
    - "Both manual and Plaid-linked accounts appear in the same type groups"
    - "Each account card shows institution name and whether it is linked"
    - "Balance summary at top shows total per account type"
    - "'Connect Bank' button appears in page header and in empty type groups"
    - "Account cards for linked accounts with broken connections show a warning indicator"
  artifacts:
    - path: "spendwise/src/app/(dashboard)/accounts/page.tsx"
      provides: "Redesigned accounts page with type-grouped layout"
      min_lines: 40
    - path: "spendwise/src/components/accounts/AccountTypeGroup.tsx"
      provides: "Component rendering a group of accounts under a type heading"
      min_lines: 25
    - path: "spendwise/src/components/accounts/BalanceSummary.tsx"
      provides: "Balance summary bar showing totals per account type"
      min_lines: 20
    - path: "spendwise/src/components/accounts/AccountCard.tsx"
      provides: "Updated account card with institution info and connection status"
      min_lines: 30
  key_links:
    - from: "spendwise/src/app/(dashboard)/accounts/page.tsx"
      to: "spendwise/src/hooks/usePlaid.ts"
      via: "usePlaidItems hook"
      pattern: "usePlaidItems"
    - from: "spendwise/src/app/(dashboard)/accounts/page.tsx"
      to: "spendwise/src/components/plaid/PlaidLinkButton.tsx"
      via: "Connect Bank button"
      pattern: "PlaidLinkButton"
    - from: "spendwise/src/components/accounts/AccountCard.tsx"
      to: "connection status"
      via: "isLinked and plaidItem.status fields"
      pattern: "isLinked|status.*error"
---

<objective>
Redesign the accounts page to group accounts by type (Checking, Savings, Credit, Investment), add a balance summary by type, integrate the PlaidLinkButton for connecting new institutions, and show connection status indicators on account cards.

Purpose: The accounts page is the primary view where users see all their financial accounts. This redesign unifies manual and Plaid-linked accounts in one view organized by account type (not institution), fulfilling the vision that "the accounts page should feel like one unified view."

Output: Updated accounts page with type-grouped layout, balance summary, Connect Bank button, and connection status indicators.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-plaid-integration-foundation/02-CONTEXT.md
@.planning/phases/02-plaid-integration-foundation/02-03-SUMMARY.md
@spendwise/src/app/(dashboard)/accounts/page.tsx
@spendwise/src/components/accounts/AccountCard.tsx
@spendwise/src/components/accounts/AccountList.tsx
@spendwise/src/hooks/useAccounts.ts
@spendwise/src/hooks/usePlaid.ts
@spendwise/src/components/plaid/PlaidLinkButton.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BalanceSummary and AccountTypeGroup components</name>
  <files>
    spendwise/src/components/accounts/BalanceSummary.tsx
    spendwise/src/components/accounts/AccountTypeGroup.tsx
  </files>
  <action>
    **Create `spendwise/src/components/accounts/BalanceSummary.tsx`:**

    'use client' component showing a summary bar at the top of accounts page.

    Props:
    ```typescript
    interface BalanceSummaryProps {
      accounts: Array<{ type: string; balance: number }>;
    }
    ```

    Calculate totals per account type by reducing over accounts array. Display:
    - A horizontal row of cards (grid grid-cols-2 lg:grid-cols-4 gap-4)
    - Each card shows: type label (Checking, Savings, Credit, Investment), total balance formatted as currency, count of accounts
    - Net worth line at the bottom: sum of checking + savings + investment - credit
    - Use Tailwind: rounded-lg border p-4, type-specific accent colors (green for checking, blue for savings, red for credit, purple for investment)
    - Show "$0.00" for types with no accounts
    - Format currency using Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' })

    **Create `spendwise/src/components/accounts/AccountTypeGroup.tsx`:**

    'use client' component rendering a group of accounts under a type heading.

    Props:
    ```typescript
    interface AccountTypeGroupProps {
      type: 'CHECKING' | 'SAVINGS' | 'CREDIT' | 'INVESTMENT';
      accounts: Account[];
      plaidItems: PlaidItem[];  // To look up connection status
      onConnectBank?: () => void;
    }
    ```

    Render:
    - Section heading with type name and account count (e.g., "Checking (3)")
    - If accounts is empty: show an empty state card with "No {type} accounts" message and a "Connect Bank" button (use PlaidLinkButton) to add one
    - If accounts exist: render AccountCard for each account in a grid (grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4)
    - Pass connection status to each AccountCard by looking up the account's plaidItemId in plaidItems array to get the item's status

    Type labels: CHECKING -> "Checking", SAVINGS -> "Savings", CREDIT -> "Credit Cards", INVESTMENT -> "Investments"
  </action>
  <verify>
    ```bash
    cd spendwise && npx tsc --noEmit
    ```
    TypeScript compiles. Both components exist.
  </verify>
  <done>BalanceSummary shows per-type totals. AccountTypeGroup renders accounts under type headings with empty states that include Connect Bank.</done>
</task>

<task type="auto">
  <name>Task 2: Update AccountCard and redesign accounts page</name>
  <files>
    spendwise/src/components/accounts/AccountCard.tsx
    spendwise/src/app/(dashboard)/accounts/page.tsx
    spendwise/src/components/accounts/AccountList.tsx
  </files>
  <action>
    **Update `spendwise/src/components/accounts/AccountCard.tsx`:**

    Read the existing AccountCard component first. Extend it to show:
    1. Institution name (account.institution field) -- displayed as subtitle or secondary text
    2. Account mask (last 4 digits) if available: "****{mask}"
    3. Connection status indicator for Plaid-linked accounts:
       - If `isLinked === true && connectionStatus === 'active'`: small green dot or connected icon
       - If `isLinked === true && connectionStatus === 'error'`: warning badge (amber/orange exclamation icon) -- clickable, will trigger re-auth (wire this via onReAuthClick prop)
       - If `isLinked === true && connectionStatus === 'pending_disconnect'`: yellow warning icon
       - If `isLinked === false` (manual): no status indicator, or subtle "Manual" label
    4. Keep all existing AccountCard functionality (balance display, click to view, etc.)

    New props to add:
    ```typescript
    interface AccountCardProps {
      account: Account;
      connectionStatus?: 'active' | 'error' | 'pending_disconnect';
      onReAuthClick?: () => void;
    }
    ```

    Style the warning badge: inline-flex items-center gap-1, bg-amber-50 text-amber-700 border border-amber-200 rounded-full px-2 py-0.5 text-xs. On hover, darken slightly to indicate clickability.

    **Redesign `spendwise/src/app/(dashboard)/accounts/page.tsx`:**

    Read the existing page first. Rewrite it to:

    1. Use both `useAccounts()` and `usePlaidItems()` hooks to fetch all data
    2. Page header: title "Accounts" on the left, PlaidLinkButton ("Connect Bank") on the right
    3. Below header: BalanceSummary component with all accounts
    4. Below summary: four AccountTypeGroup sections, one per type, in order: Checking, Savings, Credit Cards, Investments
    5. Group accounts by type using accounts.filter(a => a.type === type) for each group
    6. Pass plaidItems to each AccountTypeGroup for connection status lookup
    7. Handle loading state: show skeleton/spinner while data loads
    8. Handle empty state: if no accounts at all, show a welcome message with prominent "Connect Bank" and "Add Manual Account" buttons
    9. When PlaidLinkButton onSuccess fires: the hooks' refetch (via Apollo cache invalidation in usePlaid hooks) should automatically refresh the page data

    **Handle PlaidLinkButton success flow:**
    - Create state `showLinkSuccess` and `linkResult` to track success modal
    - Pass onSuccess callback to PlaidLinkButton that sets these states
    - When LinkSuccessModal's onDone is called: reset state, data will already be refreshed via Apollo
    - When LinkSuccessModal's onConnectAnother is called: reset state and trigger PlaidLinkButton to open again (may need a ref or state trigger)

    **For AccountList.tsx:** Either update it to use the new type-grouped layout, or leave it as-is if the page.tsx directly uses AccountTypeGroup components instead. If AccountList is no longer needed for the new layout, keep it but it may become unused (don't delete existing code -- it might be used elsewhere).
  </action>
  <verify>
    ```bash
    cd spendwise && npx tsc --noEmit && npm run build
    ```
    TypeScript compiles. Next.js build succeeds. Accounts page renders without errors.
  </verify>
  <done>
    Accounts page shows accounts grouped by type with balance summary. Connect Bank button in header and empty type groups. Account cards show institution name, mask, and connection status indicators. Warning badges on accounts with broken connections. Manual and Plaid-linked accounts appear unified in the same type groups.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Redesigned accounts page with type-grouped layout, balance summary, Connect Bank button integration, and connection status indicators on account cards. Manual and Plaid-linked accounts coexist in unified type groups.</what-built>
  <how-to-verify>
    1. Start the dev server: `cd spendwise && npm run dev`
    2. Navigate to the accounts page (http://localhost:3000/accounts or the dashboard accounts route)
    3. Verify the layout:
       - Balance summary at top showing per-type totals
       - Four type sections: Checking, Savings, Credit Cards, Investments
       - "Connect Bank" button in page header
       - Empty type groups show "Connect Bank" prompt
    4. If you have existing manual accounts, verify they appear in the correct type group
    5. Verify the "Connect Bank" button is visible and enabled (it will fail to connect without Plaid credentials, but the button should be clickable)
    6. Check that the page is responsive (resize browser to mobile width)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/layout issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in spendwise
- `npm run build` succeeds
- Accounts page groups by type (CHECKING, SAVINGS, CREDIT, INVESTMENT)
- Balance summary shows per-type totals
- Connect Bank button in header and empty groups
- AccountCard shows institution name, mask, connection status
- Manual accounts (isLinked: false) show without connection indicator
- Linked accounts with error status show warning badge
- Page uses both useAccounts and usePlaidItems hooks
</verification>

<success_criteria>
- Accounts organized by type, not by institution
- Balance summary by account type at top
- "Connect Bank" button in header and empty type groups
- AccountCard shows institution, mask, connection status
- Warning indicator on broken connections
- Manual and linked accounts unified in same type groups
- Page is responsive
- Visual verification approved by user
</success_criteria>

<output>
After completion, create `.planning/phases/02-plaid-integration-foundation/02-04-SUMMARY.md`
</output>
