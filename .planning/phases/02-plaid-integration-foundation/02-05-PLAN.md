---
phase: 02-plaid-integration-foundation
plan: 05
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - spendwise/src/app/(dashboard)/settings/page.tsx
  - spendwise/src/components/plaid/InstitutionCard.tsx
  - spendwise/src/components/plaid/UnlinkConfirmationModal.tsx
  - spendwise/src/components/plaid/ReAuthBadge.tsx
autonomous: false

must_haves:
  truths:
    - "Settings page shows list of connected institutions with their accounts, status, and last sync time"
    - "Each institution shows a re-auth button when connection status is 'error'"
    - "User can click re-auth which opens Plaid Link in update mode"
    - "User can click unlink which shows confirmation modal requiring institution name typed"
    - "Unlink confirmation offers choice: keep data as manual or delete all data"
    - "After unlinking, user sees confirmation message with account count"
    - "After 2-3 re-auth failures, UI suggests unlinking and reconnecting"
  artifacts:
    - path: "spendwise/src/app/(dashboard)/settings/page.tsx"
      provides: "Settings page with institution management section"
      min_lines: 50
    - path: "spendwise/src/components/plaid/InstitutionCard.tsx"
      provides: "Card component showing institution with accounts, status, and actions"
      min_lines: 50
    - path: "spendwise/src/components/plaid/UnlinkConfirmationModal.tsx"
      provides: "Confirmation modal with name-typing verification and data retention choice"
      min_lines: 60
    - path: "spendwise/src/components/plaid/ReAuthBadge.tsx"
      provides: "Reusable warning badge/button for re-authentication"
      min_lines: 15
  key_links:
    - from: "spendwise/src/app/(dashboard)/settings/page.tsx"
      to: "spendwise/src/hooks/usePlaid.ts"
      via: "usePlaidItems hook"
      pattern: "usePlaidItems"
    - from: "spendwise/src/components/plaid/InstitutionCard.tsx"
      to: "spendwise/src/components/plaid/PlaidLinkButton.tsx"
      via: "re-auth button using update mode"
      pattern: "PlaidLinkButton.*mode.*update"
    - from: "spendwise/src/components/plaid/UnlinkConfirmationModal.tsx"
      to: "spendwise/src/hooks/usePlaid.ts"
      via: "useUnlinkItem hook"
      pattern: "useUnlinkItem"
---

<objective>
Build the settings page institution management section with full institution lifecycle: viewing connected institutions, re-authenticating broken connections via Plaid Link update mode, and unlinking institutions with confirmation and data retention choice.

Purpose: The settings page is where users manage their connected institutions -- see status, repair broken connections, and remove institutions. This completes the Plaid connection lifecycle (connect -> monitor -> repair -> disconnect).

Output: Settings page with institution cards, re-auth flow, and unlink confirmation modal.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-plaid-integration-foundation/02-CONTEXT.md
@.planning/phases/02-plaid-integration-foundation/02-03-SUMMARY.md
@spendwise/src/app/(dashboard)/settings/page.tsx
@spendwise/src/hooks/usePlaid.ts
@spendwise/src/components/plaid/PlaidLinkButton.tsx
@spendwise/src/components/plaid/LinkSuccessModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReAuthBadge, InstitutionCard, and UnlinkConfirmationModal components</name>
  <files>
    spendwise/src/components/plaid/ReAuthBadge.tsx
    spendwise/src/components/plaid/InstitutionCard.tsx
    spendwise/src/components/plaid/UnlinkConfirmationModal.tsx
  </files>
  <action>
    **Create `spendwise/src/components/plaid/ReAuthBadge.tsx`:**

    'use client' component -- a small, reusable warning badge that indicates a connection needs re-authentication.

    Props:
    ```typescript
    interface ReAuthBadgeProps {
      onClick?: () => void;
      size?: 'sm' | 'md';  // sm for account cards, md for institution cards
    }
    ```

    Render:
    - Amber/orange badge with exclamation triangle icon (use an SVG inline or emoji as fallback)
    - Text: "Needs attention" (md) or just icon (sm)
    - If onClick provided: cursor-pointer, hover:bg-amber-100 transition
    - Tailwind: inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium bg-amber-50 text-amber-700 border border-amber-200

    **Create `spendwise/src/components/plaid/InstitutionCard.tsx`:**

    'use client' component showing a connected institution with its accounts and management actions.

    Props:
    ```typescript
    interface InstitutionCardProps {
      plaidItem: {
        id: string;
        institutionName: string;
        plaidInstitutionId: string;
        status: string;
        accounts: Array<{
          id: string;
          name: string;
          officialName?: string;
          mask?: string;
          type: string;
          balance: number;
        }>;
        createdAt: string;
        updatedAt: string;
      };
      onReAuth: (itemId: string) => void;
      onUnlink: (itemId: string) => void;
    }
    ```

    Render a card (rounded-xl border bg-white shadow-sm p-6):
    - Header row: institution name (bold, text-lg), status indicator (green dot for active, amber dot for error, yellow dot for pending_disconnect)
    - If status === 'error': ReAuthBadge with "Connection needs re-authentication" message and a "Re-authenticate" button (calls onReAuth(item.id))
    - Accounts list (always visible, not collapsed): Each account as a row showing name, type badge, mask (****XXXX), balance. Use divide-y for separation.
    - Footer: "Connected {timeAgo}" on left (format createdAt as relative time like "2 days ago" or "Jan 15, 2026"), "Last updated {timeAgo}" in middle
    - Action buttons at bottom right: "Re-authenticate" button (only if status is 'error', uses primary style), "Unlink" button (always visible, uses danger/red outline style, calls onUnlink(item.id))
    - Track re-auth attempt count in local state (increment when onReAuth called). If count >= 3: show message "Having trouble? Try unlinking and reconnecting this institution." with a link to the unlink action.

    **Create `spendwise/src/components/plaid/UnlinkConfirmationModal.tsx`:**

    'use client' component -- a modal that requires the user to type the institution name and choose data retention before unlinking.

    Props:
    ```typescript
    interface UnlinkConfirmationModalProps {
      institutionName: string;
      accountCount: number;
      itemId: string;
      onConfirm: (itemId: string, keepAsManual: boolean) => Promise<void>;
      onCancel: () => void;
    }
    ```

    State:
    - `confirmText` (string): what user has typed
    - `keepAsManual` (boolean): data retention choice, default true
    - `isUnlinking` (boolean): loading state during unlink
    - `result` (object | null): unlink result for confirmation screen

    Render as modal overlay (fixed inset-0 z-50 bg-black/50 flex items-center justify-center):

    **Before confirmation (result is null):**
    - Title: "Unlink {institutionName}?" in red/danger text
    - Warning text: "This will disconnect {institutionName} from SpendWise. {accountCount} account(s) will be affected."
    - Data retention choice (radio buttons or toggle):
      - "Keep accounts as manual" -- "Your accounts and transaction history will be preserved but no longer sync automatically."
      - "Delete all data" -- "All accounts and transactions from {institutionName} will be permanently deleted."
    - Confirmation input: "Type '{institutionName}' to confirm" with an input field
    - Buttons: "Cancel" (secondary) and "Unlink {institutionName}" (danger/red, disabled until confirmText matches institutionName exactly, case-insensitive)
    - When confirmed: set isUnlinking true, call onConfirm(itemId, keepAsManual), store result

    **After confirmation (result is set):**
    - Title: "{institutionName} disconnected" with check icon
    - Message: "{accountCount} account(s) {keptAsManual ? 'converted to manual' : 'removed'}"
    - Single "Done" button that calls onCancel (closes modal)

    Style: max-w-md bg-white rounded-xl shadow-2xl p-6. Danger elements in red-600. Input with ring-red-300 focus state.
  </action>
  <verify>
    ```bash
    cd spendwise && npx tsc --noEmit
    ```
    TypeScript compiles. All three components exist in src/components/plaid/.
  </verify>
  <done>ReAuthBadge, InstitutionCard, and UnlinkConfirmationModal components created with proper props, states, and styling. InstitutionCard shows accounts, status, and actions. UnlinkConfirmationModal requires name typing and offers data retention choice.</done>
</task>

<task type="auto">
  <name>Task 2: Build settings page with institution management</name>
  <files>
    spendwise/src/app/(dashboard)/settings/page.tsx
  </files>
  <action>
    Read the existing settings page first. Extend it (or rewrite if it's a stub) to include an "Connected Institutions" section.

    **Implementation:**

    1. Use `usePlaidItems()` hook to fetch connected institutions
    2. Use `useUnlinkItem()` hook for unlinking
    3. State management: `unlinkTarget` (PlaidItem | null) for which item is being unlinked, `reAuthItemId` (string | null) for which item is being re-authed

    **Page structure:**

    If the settings page already has content (profile settings, etc.), ADD a new section below. Do NOT replace existing settings content.

    New section "Connected Institutions":
    - Section heading: "Connected Institutions" with "Connect Bank" button (PlaidLinkButton) on the right
    - If no plaidItems: empty state -- "No institutions connected yet. Connect your first bank to start syncing accounts." with PlaidLinkButton
    - If plaidItems exist: render InstitutionCard for each item, in a vertical stack (space-y-6)
    - Pass onReAuth handler that:
      1. Sets reAuthItemId to the item's id
      2. This triggers rendering a PlaidLinkButton in update mode with that itemId (can be rendered conditionally or use a hidden PlaidLinkButton that auto-opens)
      3. On success: clear reAuthItemId, show success toast/message, data auto-refreshes via Apollo
    - Pass onUnlink handler that: sets unlinkTarget to the item

    **Re-auth flow implementation:**
    - When reAuthItemId is set: render a PlaidLinkButton with `mode="update"` and `itemId={reAuthItemId}` that auto-opens Plaid Link
    - The simplest approach: render the PlaidLinkButton hidden/invisible and use a ref or useEffect to call open() when reAuthItemId changes
    - OR: render a small modal/overlay that contains the PlaidLinkButton and a message "Re-authenticating with {institutionName}..."
    - On success: updateItemStatus to 'active', clear reAuthItemId
    - On exit/cancel: clear reAuthItemId

    **Unlink flow implementation:**
    - When unlinkTarget is set: render UnlinkConfirmationModal
    - onConfirm: call unlinkItem mutation from useUnlinkItem hook, pass result to modal
    - onCancel: clear unlinkTarget

    **Important:** The PlaidLinkButton for re-auth needs to work differently from the Connect Bank button. For re-auth:
    - It creates a link token with the item's access_token (update mode)
    - On success, there's NO token exchange -- just update the item status to 'active'
    - This is already handled in PlaidLinkButton's mode='update' logic from Plan 03
  </action>
  <verify>
    ```bash
    cd spendwise && npx tsc --noEmit && npm run build
    ```
    TypeScript compiles. Next.js build succeeds. Settings page renders without errors.
  </verify>
  <done>
    Settings page shows connected institutions with full management capabilities. Each institution shows accounts, status, last sync time. Re-auth available for error-state institutions. Unlink flow with name-typing confirmation and data retention choice.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Settings page with institution management: connected institutions list, re-auth flow for broken connections, and unlink flow with confirmation modal requiring name typing and data retention choice. Also includes ReAuthBadge for use on account cards.</what-built>
  <how-to-verify>
    1. Start the dev server: `cd spendwise && npm run dev`
    2. Navigate to settings page (http://localhost:3000/settings)
    3. Verify the "Connected Institutions" section exists
    4. If no institutions connected: verify empty state with "Connect Bank" button
    5. Verify "Connect Bank" button is visible in section header
    6. Check that the page integrates with any existing settings content (doesn't replace it)
    7. Verify the unlink modal renders correctly:
       - Open browser console and verify no React errors
       - The modal should be accessible (focus trap, escape to close)
    8. Check responsive layout at mobile widths
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in spendwise
- `npm run build` succeeds
- Settings page shows connected institutions section
- InstitutionCard shows institution name, status, accounts, and action buttons
- Re-auth button appears for error-state institutions
- Unlink button appears for all institutions
- UnlinkConfirmationModal requires typing institution name
- Data retention choice (keep as manual vs delete) is functional
- PlaidLinkButton in update mode works for re-auth
- After 3 re-auth failures, suggestion to unlink appears
</verification>

<success_criteria>
- Settings page has "Connected Institutions" section
- Each institution shows accounts, status, last sync time
- Re-auth available for broken connections (opens Link in update mode)
- Unlink requires typing institution name to confirm
- Unlink offers keep-as-manual vs delete-all choice
- After unlinking, confirmation message shows with affected account count
- Re-auth failure counter suggests unlinking after 2-3 failures
- Visual verification approved by user
</success_criteria>

<output>
After completion, create `.planning/phases/02-plaid-integration-foundation/02-05-SUMMARY.md`
</output>
