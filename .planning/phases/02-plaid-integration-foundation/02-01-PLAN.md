---
phase: 02-plaid-integration-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spendwise-api/package.json
  - spendwise-api/src/lib/plaid-client.ts
  - spendwise-api/src/schema/typeDefs/plaid.ts
  - spendwise-api/src/schema/typeDefs/index.ts
  - spendwise-api/src/schema/resolvers/plaid.ts
  - spendwise-api/src/schema/resolvers/index.ts
autonomous: true
user_setup:
  - service: plaid
    why: "Plaid Sandbox credentials needed for link token creation and token exchange"
    env_vars:
      - name: PLAID_CLIENT_ID
        source: "Plaid Dashboard (https://dashboard.plaid.com) -> Team Settings -> Keys"
      - name: PLAID_SECRET
        source: "Plaid Dashboard -> Team Settings -> Keys (use Sandbox secret)"
      - name: PLAID_ENV
        source: "Set to 'sandbox' for development"
      - name: PLAID_WEBHOOK_URL
        source: "Your publicly accessible webhook URL (can use ngrok for dev, e.g. https://xxxx.ngrok.io/webhooks/plaid)"
      - name: PLAID_REDIRECT_URI
        source: "Your app URL for OAuth banks (e.g. http://localhost:3000/plaid-oauth)"
    dashboard_config:
      - task: "Create a Plaid account and get Sandbox API keys"
        location: "https://dashboard.plaid.com/signup"

must_haves:
  truths:
    - "GraphQL createLinkToken mutation returns a valid link_token string"
    - "GraphQL exchangePublicToken mutation stores PlaidItem with encrypted access_token and creates Account records"
    - "GraphQL plaidItems query returns all connected institutions for the authenticated user"
    - "GraphQL unlinkItem mutation revokes Plaid access and either converts accounts to manual or deletes them"
    - "GraphQL updateItemStatus mutation marks a PlaidItem as active after re-auth"
  artifacts:
    - path: "spendwise-api/src/lib/plaid-client.ts"
      provides: "Initialized PlaidApi client singleton"
      exports: ["plaidClient"]
    - path: "spendwise-api/src/schema/typeDefs/plaid.ts"
      provides: "GraphQL type definitions for Plaid operations"
      contains: "createLinkToken"
    - path: "spendwise-api/src/schema/resolvers/plaid.ts"
      provides: "Resolver implementations for all Plaid GraphQL operations"
      exports: ["plaidResolvers"]
  key_links:
    - from: "spendwise-api/src/schema/resolvers/plaid.ts"
      to: "spendwise-api/src/lib/plaid-client.ts"
      via: "import plaidClient"
      pattern: "import.*plaidClient.*from.*plaid-client"
    - from: "spendwise-api/src/schema/resolvers/plaid.ts"
      to: "prisma.plaidItem"
      via: "database operations"
      pattern: "prisma\\.plaidItem\\.(create|findMany|update|delete)"
    - from: "spendwise-api/src/schema/resolvers/index.ts"
      to: "spendwise-api/src/schema/resolvers/plaid.ts"
      via: "resolver registration"
      pattern: "plaidResolvers"
---

<objective>
Create the backend Plaid infrastructure: SDK client initialization, GraphQL type definitions, and resolver implementations for all Plaid operations (link token creation, public token exchange, item listing, unlinking, and status updates).

Purpose: This is the backend foundation that all frontend Plaid features depend on. Without these GraphQL endpoints, no Plaid Link flow, connection management, or institution display can work.

Output: Working GraphQL API endpoints for complete Plaid item lifecycle management.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-plaid-integration-foundation/02-CONTEXT.md
@.planning/phases/02-plaid-integration-foundation/02-RESEARCH.md
@spendwise-api/prisma/schema.prisma
@spendwise-api/src/schema/typeDefs/account.ts
@spendwise-api/src/schema/typeDefs/index.ts
@spendwise-api/src/schema/resolvers/account.ts
@spendwise-api/src/schema/resolvers/index.ts
@spendwise-api/src/context/index.ts
@spendwise-api/src/lib/prisma.ts
@spendwise-api/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Plaid SDK and create client initialization</name>
  <files>
    spendwise-api/package.json
    spendwise-api/src/lib/plaid-client.ts
  </files>
  <action>
    Install the Plaid Node.js SDK:
    ```bash
    cd spendwise-api && npm install plaid
    ```

    Create `spendwise-api/src/lib/plaid-client.ts` that initializes a PlaidApi singleton:
    - Import `Configuration`, `PlaidApi`, `PlaidEnvironments` from 'plaid'
    - Read `PLAID_CLIENT_ID`, `PLAID_SECRET`, `PLAID_ENV` from process.env
    - Default `PLAID_ENV` to 'sandbox' if not set
    - Create Configuration with basePath from PlaidEnvironments[env] and headers for PLAID-CLIENT-ID and PLAID-SECRET
    - Export the PlaidApi instance as `plaidClient`
    - Also export `PlaidEnvironments` re-export and any useful types from plaid that resolvers will need (e.g., `Products`, `CountryCode`)

    Follow the pattern from existing lib files (prisma.ts, redis.ts) -- simple singleton export.
  </action>
  <verify>
    ```bash
    cd spendwise-api && npx tsc --noEmit
    ```
    TypeScript compiles without errors. The plaid package is in package.json dependencies.
  </verify>
  <done>plaid-client.ts exports a configured PlaidApi instance that resolvers can import.</done>
</task>

<task type="auto">
  <name>Task 2: Create Plaid GraphQL typeDefs and resolvers with full CRUD operations</name>
  <files>
    spendwise-api/src/schema/typeDefs/plaid.ts
    spendwise-api/src/schema/typeDefs/index.ts
    spendwise-api/src/schema/resolvers/plaid.ts
    spendwise-api/src/schema/resolvers/index.ts
  </files>
  <action>
    **Create `spendwise-api/src/schema/typeDefs/plaid.ts`:**

    Define these GraphQL types using the same `gql` tag pattern as account.ts:

    ```graphql
    type PlaidItem {
      id: ID!
      plaidInstitutionId: String!
      institutionName: String!
      status: String!                    # "active", "error", "pending_disconnect"
      accounts: [Account!]!
      consentExpirationTime: DateTime
      createdAt: DateTime!
      updatedAt: DateTime!
    }
    # NOTE: accessToken is intentionally NEVER exposed in GraphQL schema

    type PlaidLinkToken {
      linkToken: String!
      expiration: String!
    }

    type ExchangeResult {
      plaidItem: PlaidItem!
      accountsCreated: Int!
    }

    type UnlinkResult {
      success: Boolean!
      accountsAffected: Int!
      keptAsManual: Boolean!
    }

    input ExchangePublicTokenInput {
      publicToken: String!
      institutionId: String!
      institutionName: String!
    }

    extend type Query {
      plaidItems: [PlaidItem!]!
    }

    extend type Mutation {
      createLinkToken(itemId: String): PlaidLinkToken!
      # itemId is optional -- if provided, creates update-mode token for re-auth
      exchangePublicToken(input: ExchangePublicTokenInput!): ExchangeResult!
      unlinkItem(itemId: ID!, keepAsManual: Boolean!): UnlinkResult!
      updateItemStatus(itemId: ID!, status: String!): PlaidItem!
    }
    ```

    **Register in `spendwise-api/src/schema/typeDefs/index.ts`:**
    - Import `plaidTypeDefs` from './plaid'
    - Add to the typeDefs array

    **Create `spendwise-api/src/schema/resolvers/plaid.ts`:**

    Import plaidClient from '../../lib/plaid-client', Context from '../../context', requireAuth from '../../middleware/authMiddleware', invalidateCache from '../../lib/redis'.

    Implement these resolvers:

    **Query.plaidItems:** Fetch all PlaidItems for authenticated user with `include: { accounts: true }`, ordered by createdAt desc.

    **Mutation.createLinkToken:**
    - If `itemId` is provided: This is update/re-auth mode. Fetch the PlaidItem, verify it belongs to the user, call `plaidClient.linkTokenCreate` with the item's `accessToken` parameter (decrypted automatically by prisma-field-encryption). Do NOT include `products` when in update mode.
    - If `itemId` is null: This is create mode. Call `plaidClient.linkTokenCreate` with:
      - `user: { client_user_id: userId }`
      - `client_name: 'SpendWise'`
      - `products: [Products.Transactions, Products.Investments]` (import Products enum from plaid)
      - `country_codes: [CountryCode.Us]` (import CountryCode enum from plaid)
      - `language: 'en'`
      - `webhook: process.env.PLAID_WEBHOOK_URL`
      - `redirect_uri: process.env.PLAID_REDIRECT_URI` (only include if env var is set)
      - `account_filters` for depository (checking, savings), credit (credit card), and investment (401k, 403b, ira, roth, brokerage) subtypes
    - Return `{ linkToken: response.data.link_token, expiration: response.data.expiration }`

    **Mutation.exchangePublicToken:**
    - Call `plaidClient.itemPublicTokenExchange({ public_token: input.publicToken })`
    - Get access_token and item_id from response
    - Call `plaidClient.accountsGet({ access_token })` to fetch account details
    - Create PlaidItem record in database with userId, accessToken (encrypted automatically), plaidItemId (item_id), plaidInstitutionId, institutionName, status: 'active'
    - For each account in accountsGet response, create Account record:
      - Map Plaid account type to AccountType enum: 'depository' -> check subtype for CHECKING vs SAVINGS, 'credit' -> CREDIT, 'investment' -> INVESTMENT
      - Set: userId, plaidItemId (the new PlaidItem.id), plaidAccountId (account.account_id), name (account.name), officialName (account.official_name), mask (account.mask), type, balance (account.balances.current ?? 0), institution (input.institutionName), isLinked: true, lastSynced: new Date()
    - Invalidate cache for user
    - Return PlaidItem with accounts count

    **Mutation.unlinkItem:**
    - Verify item belongs to authenticated user
    - Fetch PlaidItem with `include: { accounts: true }`
    - Call `plaidClient.itemRemove({ access_token: item.accessToken })` to revoke with Plaid
    - If keepAsManual: update all accounts to set isLinked: false, plaidAccountId: null, plaidItemId: null (use a transaction to do both updateMany and delete)
    - If !keepAsManual: delete all accounts belonging to this item (cascade will handle transactions)
    - Delete the PlaidItem record
    - Invalidate cache
    - Return { success: true, accountsAffected: item.accounts.length, keptAsManual }

    **Mutation.updateItemStatus:**
    - Verify item belongs to authenticated user
    - Update PlaidItem status field
    - Return updated PlaidItem with accounts

    **Type resolver PlaidItem.accounts:** Already handled by Prisma include, but add a field resolver as fallback that fetches accounts where plaidItemId matches, in case the include wasn't used.

    **Register in `spendwise-api/src/schema/resolvers/index.ts`:**
    - Import `plaidResolvers` from './plaid'
    - Spread plaidResolvers.Query into Query object
    - Spread plaidResolvers.Mutation into Mutation object
    - Add `PlaidItem: plaidResolvers.PlaidItem` if field resolvers exist

    **Important:** Use Plaid SDK's TypeScript types where available (Products, CountryCode, AccountSubtype). Wrap all Plaid API calls in try/catch and throw GraphQLError with appropriate error codes (PLAID_ERROR, ITEM_NOT_FOUND, etc.) using `extensions: { code: 'PLAID_ERROR' }` pattern.

    **Account type mapping function** (create as helper within the resolver file):
    ```typescript
    function mapPlaidAccountType(plaidType: string, plaidSubtype: string | null): 'CHECKING' | 'SAVINGS' | 'CREDIT' | 'INVESTMENT' {
      if (plaidType === 'depository') {
        return plaidSubtype === 'savings' ? 'SAVINGS' : 'CHECKING';
      }
      if (plaidType === 'credit') return 'CREDIT';
      if (plaidType === 'investment') return 'INVESTMENT';
      return 'CHECKING'; // fallback
    }
    ```
  </action>
  <verify>
    ```bash
    cd spendwise-api && npx tsc --noEmit && npm test
    ```
    TypeScript compiles without errors. Existing tests still pass (201 tests). The new typeDefs and resolvers are registered in the index files.
  </verify>
  <done>
    GraphQL schema includes PlaidItem type, PlaidLinkToken type, ExchangeResult type, UnlinkResult type. Five operations available: plaidItems query, createLinkToken mutation, exchangePublicToken mutation, unlinkItem mutation, updateItemStatus mutation. All operations require authentication. Access token is never exposed in GraphQL responses.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in spendwise-api
- `npm test` passes (all existing 201 tests still green)
- GraphQL schema introspection shows PlaidItem type, plaidItems query, and all four mutations
- No `accessToken` field appears in any GraphQL type definition (security check)
- plaid-client.ts exports plaidClient singleton
- resolvers/index.ts includes plaidResolvers spread
- typeDefs/index.ts includes plaidTypeDefs in array
</verification>

<success_criteria>
- Plaid SDK installed and PlaidApi client initialized with env vars
- All 5 GraphQL operations (1 query + 4 mutations) are defined and implemented
- Type definitions registered in schema index
- Resolvers registered in resolver index
- All Plaid API calls wrapped in error handling
- Access token never exposed in GraphQL responses
- Existing test suite passes unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/02-plaid-integration-foundation/02-01-SUMMARY.md`
</output>
