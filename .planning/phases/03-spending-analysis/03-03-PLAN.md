---
phase: 03-spending-analysis
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - spendwise/src/app/(dashboard)/analytics/page.tsx
  - spendwise/src/components/charts/TopMerchantsTable.tsx
autonomous: true

must_haves:
  truths:
    - "User can view spending breakdown by category with pie and bar charts using real data"
    - "User can view monthly spending trends over time as a line chart with multiple months"
    - "User can see month-over-month spending comparison with percentage change indicators"
    - "User can view top merchants ranked by total spending with transaction count and average"
    - "User can filter all spending analysis by date range using presets or calendar"
    - "User can filter all spending analysis by specific accounts"
    - "Page shows loading states while data fetches"
    - "Page shows helpful empty states when no data matches filters"
  artifacts:
    - path: "spendwise/src/app/(dashboard)/analytics/page.tsx"
      provides: "Complete analytics page with real data, filters, charts, comparison cards, merchant table"
      min_lines: 100
    - path: "spendwise/src/components/charts/TopMerchantsTable.tsx"
      provides: "Sortable merchant spending table with rank, count, total, and average"
      min_lines: 40
  key_links:
    - from: "spendwise/src/app/(dashboard)/analytics/page.tsx"
      to: "spendwise/src/hooks/useDashboard.ts"
      via: "useAnalytics, useSpendingByCategory, useTopMerchants hooks"
      pattern: "useAnalytics|useSpendingByCategory|useTopMerchants"
    - from: "spendwise/src/app/(dashboard)/analytics/page.tsx"
      to: "spendwise/src/hooks/useAnalyticsFilters.ts"
      via: "useAnalyticsFilters for filter state"
      pattern: "useAnalyticsFilters"
    - from: "spendwise/src/app/(dashboard)/analytics/page.tsx"
      to: "spendwise/src/components/ui/DateRangePicker.tsx"
      via: "DateRangePicker component in filter bar"
      pattern: "DateRangePicker"
    - from: "spendwise/src/app/(dashboard)/analytics/page.tsx"
      to: "spendwise/src/components/charts/"
      via: "SpendingPieChart, TrendLineChart, CategoryBarChart components"
      pattern: "SpendingPieChart|TrendLineChart|CategoryBarChart"
---

<objective>
Rebuild the analytics page to use real API data with filters, replacing all mock data. Add comparison cards, top merchants table, and wire everything together.

Purpose: This is the user-facing deliverable -- the complete spending analysis experience. It connects the API (Plan 01) through the filter infrastructure (Plan 02) to produce the visual analytics page that satisfies all five SPND requirements.

Output: Fully functional analytics page with category charts, trend line chart, comparison metrics, top merchants, and date/account filters.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-spending-analysis/03-RESEARCH.md

# Prior plan outputs needed for wiring
@.planning/phases/03-spending-analysis/03-01-SUMMARY.md
@.planning/phases/03-spending-analysis/03-02-SUMMARY.md

# Source files to modify/reference
@spendwise/src/app/(dashboard)/analytics/page.tsx
@spendwise/src/components/charts/SpendingPieChart.tsx
@spendwise/src/components/charts/TrendLineChart.tsx
@spendwise/src/components/charts/CategoryBarChart.tsx
@spendwise/src/components/charts/SavingsAreaChart.tsx
@spendwise/src/components/ui/Card.tsx
@spendwise/src/lib/utils.ts
@spendwise/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TopMerchantsTable component</name>
  <files>spendwise/src/components/charts/TopMerchantsTable.tsx</files>
  <action>
  Create `spendwise/src/components/charts/TopMerchantsTable.tsx`:

  - 'use client' directive
  - Import `MerchantStats` from '@/types' and `formatCurrency` from '@/lib/utils'.
  - Props: `merchants: MerchantStats[]`, `loading: boolean`.
  - If loading, show a skeleton/spinner placeholder (reuse any existing loading pattern, or a simple "Loading merchants..." text in gray).
  - If merchants.length === 0 and not loading, show empty state: "No merchant data available for this period" centered in the container with gray text and py-8 padding.
  - Render a responsive table (`overflow-x-auto` wrapper):
    - Table header row with columns: Merchant, Transactions, Total Spent, Avg. per Transaction.
    - Style headers: `text-left text-sm text-gray-500 dark:text-gray-400 font-medium border-b border-gray-200 dark:border-gray-700 pb-3`.
    - Table body: map over merchants.
    - Each row shows:
      - Rank number: `#{idx + 1}` in gray, followed by merchant name in font-medium.
      - Transaction count: right-aligned, gray-700.
      - Total spent: right-aligned, font-medium, formatted with `formatCurrency`.
      - Average per transaction: right-aligned, gray-700, formatted with `formatCurrency`.
    - Row styling: `border-b border-gray-100 dark:border-gray-800 last:border-0`, py-3 padding.
    - Dark mode support throughout with dark: variants.
  </action>
  <verify>Run `cd /Users/heechung/projects/spendwise && npm run build` to confirm it compiles.</verify>
  <done>TopMerchantsTable component renders merchants with rank, name, transaction count, total spent, and average amount. Handles loading and empty states.</done>
</task>

<task type="auto">
  <name>Task 2: Rebuild analytics page with real data, filters, and all visualizations</name>
  <files>spendwise/src/app/(dashboard)/analytics/page.tsx</files>
  <action>
  **Completely rewrite** `spendwise/src/app/(dashboard)/analytics/page.tsx`:

  Remove ALL imports from `@/data/mockData`. This page must use only real API data.

  **Imports needed:**
  - React: `useState`, `useMemo`, `Suspense`
  - Components: `Card`, `CardHeader`, `CardTitle` from '@/components/ui/Card', `Button` from '@/components/ui/Button'
  - Charts: `SpendingPieChart`, `TrendLineChart`, `CategoryBarChart` from '@/components/charts/'
  - New: `TopMerchantsTable` from '@/components/charts/TopMerchantsTable'
  - New: `DateRangePicker` from '@/components/ui/DateRangePicker'
  - New: `AccountFilter` from '@/components/ui/AccountFilter'
  - Hooks: `useAnalytics`, `useSpendingByCategory`, `useTopMerchants` from '@/hooks/useDashboard'
  - New: `useAnalyticsFilters` from '@/hooks/useAnalyticsFilters'
  - New: `useAccounts` from '@/hooks/useAccounts'
  - Utils: `formatCurrency`, `formatPercentage` from '@/lib/utils'

  **Page structure:**

  1. **Filter bar** (top, flex row with items-center, gap-4, flex-wrap):
     - Page title "Spending Analysis" with subtitle "Understand your spending patterns and financial trends"
     - Right side (ml-auto): DateRangePicker bound to useAnalyticsFilters dateRange/setDateRange, AccountFilter bound to useAccounts data and useAnalyticsFilters accountIds/setAccountIds.

  2. **Summary comparison cards** (grid: 1 col mobile, 2 col sm, 4 col lg):
     Use analytics data from `useAnalytics({ dateRange, accountIds })`.
     Four cards:
     - **Total Spending**: `analytics.summary.totalExpenses`, show `analytics.comparison.expensesChange` percentage. For expenses, UP is bad (red), DOWN is good (green).
     - **Total Income**: `analytics.summary.totalIncome`, show `analytics.comparison.incomeChange`. For income, UP is good (green), DOWN is bad (red).
     - **Net Savings**: `analytics.summary.netSavings`, show savings rate as subtitle text.
     - **Avg. Transaction**: `analytics.summary.averageTransaction`, show transaction count as subtitle.

     Each card: show loading skeleton if analytics loading, show the value with formatCurrency, and the comparison change with colored arrow indicator (up arrow + green for good, down arrow + red for bad, based on whether it's expense or income).

     Handle comparison edge cases:
     - If expensesChange is 0, show "No change" in gray
     - Use `Math.abs(change).toFixed(1)` for the percentage display
     - Prefix with up arrow or down arrow based on sign

  3. **Charts grid** (grid: 1 col mobile, 2 cols lg):
     - **Income vs Expenses Trend** (full width, lg:col-span-2): Card with TrendLineChart using `analytics.trends` data. Show loading state if loading. Show empty state "No trend data available" if trends has empty labels.
     - **Spending by Category - Pie** (half width): Card with SpendingPieChart using data from `useSpendingByCategory({ dateRange, accountIds })`. Show loading/empty states.
     - **Spending by Category - Bar** (half width): Card with CategoryBarChart using same spending category data. Show loading/empty states.

  4. **Top Merchants section** (full width):
     Card with CardHeader "Top Merchants" and TopMerchantsTable using data from `useTopMerchants({ dateRange, accountIds, limit: 10 })`.

  5. **Top spending categories list** (full width):
     Keep the existing category progress bar list but wire to real `spendingByCategory` data instead of mock data. Show top 5 categories with:
     - Rank number, color dot, category name, amount, progress bar (width = percentage%), percentage text.
     - This section was already styled nicely in the existing page -- preserve that visual pattern.

  **Loading states:**
  - While data loads, show a subtle loading state per section (either a skeleton shimmer or a spinner). Do NOT show the entire page as a loading spinner -- show sections independently.
  - Use `analytics?.summary`, `analytics?.trends`, etc. with optional chaining to handle undefined during loading.

  **Empty states:**
  - If no transactions match filters: show a centered message "No transactions found for this period. Try expanding your date range or changing account filters." with a muted icon or illustration placeholder.
  - Individual chart components already handle their own empty states (SpendingPieChart, TrendLineChart, CategoryBarChart all have "No data available" returns).

  **Error states:**
  - If any hook returns an error, show a simple error message in a red-tinted Card: "Failed to load analytics. Please try again."

  **Important implementation notes:**
  - The useAnalyticsFilters hook uses useSearchParams which requires the component to be wrapped in Suspense. Wrap the main content in a Suspense boundary with a fallback loading state, OR check if the existing layout already provides Suspense.
  - Use `useMemo` for any data transformations (e.g., building chart data objects from API response).
  - Pass `analytics.trends` directly to TrendLineChart since it expects `TrendData` shape `{ labels, income, expenses, savings }` -- this matches the API response.
  - Pass `categories` (from useSpendingByCategory) directly to SpendingPieChart and CategoryBarChart since they expect `CategoryAmount[]` shape -- this matches the API response.
  </action>
  <verify>
  Run `cd /Users/heechung/projects/spendwise && npm run build` to confirm TypeScript compiles.
  Run `cd /Users/heechung/projects/spendwise && npm test` to confirm existing tests pass.
  Visually verify: No imports from '@/data/mockData' remain in the analytics page.
  </verify>
  <done>
  - Analytics page uses real API data (zero mock imports)
  - Category breakdown visible as pie chart and bar chart
  - Monthly spending trends visible as multi-month line chart
  - Month-over-month comparison cards show percentage changes with color coding
  - Top merchants table shows ranked merchants with counts and amounts
  - Date range picker filters all visualizations
  - Account filter filters all visualizations
  - Loading, empty, and error states handled gracefully
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/heechung/projects/spendwise && npm run build` -- compiles successfully with no errors
2. `cd /Users/heechung/projects/spendwise && npm test` -- existing tests pass
3. `grep -r "mockData" spendwise/src/app/(dashboard)/analytics/page.tsx` returns nothing (no mock data imports)
4. Analytics page imports useAnalyticsFilters, useAnalytics, useSpendingByCategory, useTopMerchants, DateRangePicker, AccountFilter, TopMerchantsTable
5. All 5 SPND requirements verifiable through the page:
   - SPND-01: Category pie chart + bar chart visible
   - SPND-02: Monthly trend line chart visible
   - SPND-03: Comparison cards with percentage changes visible
   - SPND-04: Top merchants table visible
   - SPND-05: Date range picker and account filter functional
</verification>

<success_criteria>
- Analytics page loads with real data from API (no mock data)
- Category charts (pie + bar) render spending breakdown
- Trend line chart shows multiple months of income/expenses/savings
- Comparison cards show month-over-month changes with directional colors
- Top merchants table shows ranked merchants with spending metrics
- Date range filter changes all visualizations
- Account filter changes all visualizations
- Empty states shown when no data matches filters
- Page builds without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-spending-analysis/03-03-SUMMARY.md`
</output>
