---
phase: 03-spending-analysis
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - spendwise/package.json
  - spendwise/src/components/ui/DateRangePicker.tsx
  - spendwise/src/components/ui/AccountFilter.tsx
  - spendwise/src/hooks/useAnalyticsFilters.ts
  - spendwise/src/graphql/queries/analytics.ts
  - spendwise/src/hooks/useDashboard.ts
  - spendwise/src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "DateRangePicker component renders with preset options (Last 7 days, Last 30 days, This month, Last 3 months, Last 6 months)"
    - "AccountFilter component shows user accounts as selectable checkboxes"
    - "useAnalyticsFilters hook manages date range and account filter state synced to URL params"
    - "GraphQL queries pass dateRange and accountIds variables to the API"
    - "useAnalytics and useSpendingByCategory hooks accept filter parameters"
  artifacts:
    - path: "spendwise/src/components/ui/DateRangePicker.tsx"
      provides: "Date range picker with presets and dual-month calendar"
      min_lines: 40
    - path: "spendwise/src/components/ui/AccountFilter.tsx"
      provides: "Multi-select account filter dropdown"
      min_lines: 30
    - path: "spendwise/src/hooks/useAnalyticsFilters.ts"
      provides: "Filter state management with URL param sync"
      exports: ["useAnalyticsFilters"]
    - path: "spendwise/src/graphql/queries/analytics.ts"
      provides: "Updated GraphQL queries with filter variables and new topMerchants query"
      contains: "DateRangeInput"
    - path: "spendwise/src/hooks/useDashboard.ts"
      provides: "Updated hooks accepting date range and account filter params"
      exports: ["useAnalytics", "useSpendingByCategory", "useTopMerchants"]
  key_links:
    - from: "spendwise/src/hooks/useAnalyticsFilters.ts"
      to: "next/navigation"
      via: "useSearchParams and useRouter"
      pattern: "useSearchParams|useRouter"
    - from: "spendwise/src/hooks/useDashboard.ts"
      to: "spendwise/src/graphql/queries/analytics.ts"
      via: "Apollo useQuery with filter variables"
      pattern: "GET_ANALYTICS.*variables.*dateRange"
    - from: "spendwise/src/components/ui/DateRangePicker.tsx"
      to: "react-day-picker"
      via: "DayPicker component import"
      pattern: "react-day-picker"
---

<objective>
Create the filter infrastructure for spending analysis: date range picker, account filter, filter state management hook, and updated GraphQL queries/hooks.

Purpose: The analytics page needs filtering by date range and account. This plan creates all reusable filter components and wiring so Plan 03 can compose them into the page without dealing with state management or API concerns.

Output: Filter components, useAnalyticsFilters hook, updated GraphQL queries with filter variables, updated useDashboard hooks with useTopMerchants.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-spending-analysis/03-RESEARCH.md
@spendwise/src/graphql/queries/analytics.ts
@spendwise/src/graphql/fragments/index.ts
@spendwise/src/hooks/useDashboard.ts
@spendwise/src/hooks/useAccounts.ts
@spendwise/src/types/index.ts
@spendwise/src/components/ui/Card.tsx
@spendwise/src/components/ui/Button.tsx
@spendwise/src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install date-fns and react-day-picker, create DateRangePicker and AccountFilter components</name>
  <files>
    spendwise/package.json
    spendwise/src/components/ui/DateRangePicker.tsx
    spendwise/src/components/ui/AccountFilter.tsx
    spendwise/src/types/index.ts
  </files>
  <action>
  1. **Install dependencies:**
     ```bash
     cd /Users/heechung/projects/spendwise && npm install react-day-picker date-fns
     ```

  2. **Add MerchantStats type** to `spendwise/src/types/index.ts`:
     ```typescript
     export interface MerchantStats {
       merchant: string;
       totalAmount: number;
       transactionCount: number;
       averageAmount: number;
       categoryBreakdown: CategoryAmount[];
     }
     ```
     Add it after the existing CategoryAmount interface. Also add:
     ```typescript
     export interface AnalyticsFilters {
       dateRange: { from: Date; to: Date };
       accountIds: string[];
     }
     ```

  3. **Create DateRangePicker** at `spendwise/src/components/ui/DateRangePicker.tsx`:
     - 'use client' directive
     - Import `DayPicker` and `DateRange` from 'react-day-picker' and `format`, `subDays`, `startOfMonth`, `endOfMonth`, `subMonths` from 'date-fns'.
     - Import 'react-day-picker/style.css'.
     - Props: `value: { from: Date; to: Date }`, `onChange: (range: { from: Date; to: Date }) => void`.
     - Define presets array:
       ```
       Last 7 days, Last 30 days, This month, Last 3 months, Last 6 months
       ```
       Each preset has a `label` and `getValue()` function returning `{ from, to }`.
     - Render as a popover-style component:
       - A button showing current range formatted as "MMM d, yyyy - MMM d, yyyy" using date-fns `format`.
       - On click, toggle a dropdown panel (absolute positioned div with shadow/border).
       - Left side: preset buttons as vertical list, styled with Tailwind (text-sm, px-3 py-2, rounded, hover:bg-gray-100, dark:hover:bg-gray-700).
       - Right side: `DayPicker` with `mode="range"`, `selected={{ from: value.from, to: value.to }}`, `onSelect` handler that calls onChange when both from and to are selected, `numberOfMonths={2}`.
       - Click outside closes dropdown (use a click-outside handler via useRef + useEffect).
     - Style the DayPicker with Tailwind-compatible CSS overrides using a wrapper className.

  4. **Create AccountFilter** at `spendwise/src/components/ui/AccountFilter.tsx`:
     - 'use client' directive
     - Props: `accounts: Array<{ id: string; name: string; type: string; institution: string }>`, `selectedIds: string[]`, `onChange: (ids: string[]) => void`.
     - Render as a dropdown button:
       - Button label: "All Accounts" if none selected, or "{N} accounts" if some selected.
       - Dropdown panel with checkboxes for each account.
       - Each row shows: checkbox, account name, account type badge (small colored pill: checking=blue, savings=green, credit=red, investment=purple).
       - "Select All" / "Clear" links at the top of dropdown.
       - Click outside closes dropdown.
     - Tailwind styling matching existing app patterns (dark mode support with dark: variants).
  </action>
  <verify>
  Run `cd /Users/heechung/projects/spendwise && npm run build` to confirm TypeScript compiles with new deps and components.
  </verify>
  <done>
  - date-fns and react-day-picker installed in spendwise/package.json
  - DateRangePicker component renders with 5 presets and dual-month DayPicker calendar
  - AccountFilter component renders with checkboxes and account type badges
  - MerchantStats and AnalyticsFilters types added to types/index.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useAnalyticsFilters hook and update GraphQL queries and hooks</name>
  <files>
    spendwise/src/hooks/useAnalyticsFilters.ts
    spendwise/src/graphql/queries/analytics.ts
    spendwise/src/hooks/useDashboard.ts
  </files>
  <action>
  1. **Create useAnalyticsFilters hook** at `spendwise/src/hooks/useAnalyticsFilters.ts`:
     - 'use client' directive
     - Import `useSearchParams`, `useRouter`, `usePathname` from 'next/navigation'.
     - Import `useState`, `useCallback` from 'react'.
     - Import `format`, `parseISO`, `startOfMonth`, `endOfMonth` from 'date-fns'.
     - Initialize state from URL search params:
       - `from` param -> dateRange.from (parse as Date), default: `startOfMonth(new Date())`
       - `to` param -> dateRange.to (parse as Date), default: `endOfMonth(new Date())`
       - `accounts` param -> accountIds (split by comma), default: `[]` (empty = all accounts)
     - `setDateRange(range: { from: Date; to: Date })`: updates state and URL params.
     - `setAccountIds(ids: string[])`: updates state and URL params.
     - URL update: use `router.push(pathname + '?' + params.toString(), { scroll: false })`.
     - Return `{ dateRange, accountIds, setDateRange, setAccountIds }`.
     - Use `useCallback` for setter functions to prevent unnecessary re-renders.

  2. **Update GraphQL queries** in `spendwise/src/graphql/queries/analytics.ts`:
     - Update `GET_ANALYTICS` to accept `$dateRange: DateRangeInput` and `$accountIds: [ID!]` variables, pass them to the analytics query field.
     - Update `GET_SPENDING_BY_CATEGORY` to accept `$dateRange: DateRangeInput` and `$accountIds: [ID!]` variables.
     - Add new `GET_TOP_MERCHANTS` query:
       ```graphql
       query GetTopMerchants($dateRange: DateRangeInput, $accountIds: [ID!], $limit: Int) {
         topMerchants(dateRange: $dateRange, accountIds: $accountIds, limit: $limit) {
           merchant
           totalAmount
           transactionCount
           averageAmount
           categoryBreakdown {
             ...CategoryAmountFields
           }
         }
       }
       ```
       Include `CATEGORY_AMOUNT_FRAGMENT`.
     - Keep `GET_DASHBOARD_STATS` unchanged (it's used by the dashboard page, not analytics).

  3. **Update hooks** in `spendwise/src/hooks/useDashboard.ts`:
     - Import GET_TOP_MERCHANTS from graphql queries.
     - Update `useAnalytics` signature:
       ```typescript
       export function useAnalytics(options?: {
         period?: Period;
         dateRange?: { from: Date; to: Date };
         accountIds?: string[];
       })
       ```
       Build variables object conditionally: include `period` if no dateRange, include `dateRange: { start: options.dateRange.from, end: options.dateRange.to }` if provided, include `accountIds` if non-empty array.

     - Update `useSpendingByCategory` with same pattern (accept optional dateRange and accountIds).

     - Add new `useTopMerchants` hook:
       ```typescript
       export function useTopMerchants(options?: {
         dateRange?: { from: Date; to: Date };
         accountIds?: string[];
         limit?: number;
       }) {
         const variables: Record<string, unknown> = {};
         if (options?.dateRange) {
           variables.dateRange = { start: options.dateRange.from, end: options.dateRange.to };
         }
         if (options?.accountIds?.length) {
           variables.accountIds = options.accountIds;
         }
         if (options?.limit) {
           variables.limit = options.limit;
         }

         const { data, loading, error, refetch } = useQuery<any>(GET_TOP_MERCHANTS, {
           variables,
           fetchPolicy: 'cache-and-network',
         });

         return {
           merchants: data?.topMerchants ?? [],
           loading,
           error,
           refetch,
         };
       }
       ```

     - Export GET_TOP_MERCHANTS from `spendwise/src/graphql/queries/analytics.ts` and add it to the barrel export if needed.

  4. **Update graphql barrel export** -- Check if `spendwise/src/graphql/queries/index.ts` exists and exports analytics queries. If so, ensure GET_TOP_MERCHANTS is exported. If not, the named export from analytics.ts should suffice since useDashboard imports directly from '@/graphql'.
  </action>
  <verify>
  Run `cd /Users/heechung/projects/spendwise && npm run build` to confirm everything compiles.
  Run `cd /Users/heechung/projects/spendwise && npm test` to confirm existing tests pass.
  </verify>
  <done>
  - useAnalyticsFilters hook manages date range + account IDs state synced to URL search params
  - GET_ANALYTICS and GET_SPENDING_BY_CATEGORY accept dateRange and accountIds variables
  - GET_TOP_MERCHANTS query exists
  - useAnalytics and useSpendingByCategory accept optional filter params
  - useTopMerchants hook exists and works
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/heechung/projects/spendwise && npm run build` -- compiles successfully
2. `cd /Users/heechung/projects/spendwise && npm test` -- existing tests pass
3. Verify DateRangePicker and AccountFilter components exist with correct props interface
4. Verify useAnalyticsFilters returns dateRange, accountIds, setDateRange, setAccountIds
5. Verify GET_TOP_MERCHANTS query is exported and used by useTopMerchants hook
</verification>

<success_criteria>
- DateRangePicker renders with 5 preset ranges and DayPicker calendar
- AccountFilter shows accounts with checkboxes and type badges
- useAnalyticsFilters manages filter state with URL sync
- All GraphQL queries pass filter variables to API
- useTopMerchants hook exists and returns merchants array
- All existing frontend tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-spending-analysis/03-02-SUMMARY.md`
</output>
