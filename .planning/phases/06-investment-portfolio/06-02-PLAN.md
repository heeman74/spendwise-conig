---
phase: 06-investment-portfolio
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - spendwise/src/graphql/queries/portfolio.ts
  - spendwise/src/graphql/mutations/portfolio.ts
  - spendwise/src/graphql/queries/index.ts
  - spendwise/src/graphql/mutations/index.ts
  - spendwise/src/hooks/usePortfolio.ts
  - spendwise/src/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "GET_PORTFOLIO query fetches totalValue, totalGain, totalGainPercent, holdingCount, accountCount, and accounts array"
    - "GET_ASSET_ALLOCATION query fetches type, value, percentage, color for each asset class"
    - "GET_HOLDINGS query fetches holdings with security name, tickerSymbol, type, quantity, prices, cost basis, gains"
    - "usePortfolio hook returns portfolio data with loading/error/refetch"
    - "useAssetAllocation hook returns allocation array with loading/error"
    - "useHoldings hook returns holdings array with optional accountId filter"
    - "useAddHolding hook returns addHolding function with loading/error"
    - "useUpdateHoldingPrice hook returns updatePrice function with loading/error"
  artifacts:
    - path: "spendwise/src/graphql/queries/portfolio.ts"
      provides: "GET_PORTFOLIO, GET_ASSET_ALLOCATION, GET_HOLDINGS query definitions"
      exports: ["GET_PORTFOLIO", "GET_ASSET_ALLOCATION", "GET_HOLDINGS"]
    - path: "spendwise/src/graphql/mutations/portfolio.ts"
      provides: "ADD_HOLDING, UPDATE_HOLDING_PRICE mutation definitions"
      exports: ["ADD_HOLDING", "UPDATE_HOLDING_PRICE"]
    - path: "spendwise/src/hooks/usePortfolio.ts"
      provides: "usePortfolio, useAssetAllocation, useHoldings, useAddHolding, useUpdateHoldingPrice hooks"
      exports: ["usePortfolio", "useAssetAllocation", "useHoldings", "useAddHolding", "useUpdateHoldingPrice"]
  key_links:
    - from: "spendwise/src/graphql/queries/index.ts"
      to: "spendwise/src/graphql/queries/portfolio.ts"
      via: "barrel re-export"
      pattern: "export.*portfolio"
    - from: "spendwise/src/hooks/index.ts"
      to: "spendwise/src/hooks/usePortfolio.ts"
      via: "barrel re-export"
      pattern: "export.*usePortfolio"
---

<objective>
Create frontend GraphQL query/mutation definitions and custom hooks for portfolio data fetching. These are the data access primitives that all portfolio UI components will use.

Purpose: Provides the hooks and queries that Plan 03 (page + components) and Plan 04 (dashboard card) will consume. Running in parallel with Plan 01 (backend).
Output: Portfolio queries, mutations, and hooks with barrel exports.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@spendwise/src/graphql/queries/netWorth.ts
@spendwise/src/graphql/mutations/netWorth.ts
@spendwise/src/hooks/useNetWorth.ts
@spendwise/src/graphql/queries/index.ts
@spendwise/src/graphql/mutations/index.ts
@spendwise/src/hooks/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create portfolio GraphQL query and mutation definitions</name>
  <files>
    spendwise/src/graphql/queries/portfolio.ts
    spendwise/src/graphql/mutations/portfolio.ts
    spendwise/src/graphql/queries/index.ts
    spendwise/src/graphql/mutations/index.ts
  </files>
  <action>
**Create `spendwise/src/graphql/queries/portfolio.ts`** following the exact pattern from `netWorth.ts` (import gql from @apollo/client):

```typescript
import { gql } from '@apollo/client';

export const GET_PORTFOLIO = gql`
  query GetPortfolio {
    portfolio {
      totalValue
      totalCostBasis
      totalGain
      totalGainPercent
      holdingCount
      accountCount
      accounts {
        id
        name
        institution
        value
        holdingCount
      }
    }
  }
`;

export const GET_ASSET_ALLOCATION = gql`
  query GetAssetAllocation {
    assetAllocation {
      type
      value
      percentage
      color
    }
  }
`;

export const GET_HOLDINGS = gql`
  query GetHoldings($accountId: ID) {
    holdings(accountId: $accountId) {
      id
      quantity
      institutionPrice
      institutionValue
      costBasis
      unrealizedGain
      unrealizedGainPercent
      isoCurrencyCode
      security {
        id
        name
        tickerSymbol
        type
        closePrice
        closePriceAsOf
      }
      account {
        id
        name
      }
    }
  }
`;
```

**Create `spendwise/src/graphql/mutations/portfolio.ts`:**

```typescript
import { gql } from '@apollo/client';

export const ADD_HOLDING = gql`
  mutation AddHolding($input: AddHoldingInput!) {
    addHolding(input: $input) {
      id
      quantity
      institutionPrice
      institutionValue
      costBasis
      unrealizedGain
      unrealizedGainPercent
      security {
        id
        name
        tickerSymbol
        type
      }
      account {
        id
        name
      }
    }
  }
`;

export const UPDATE_HOLDING_PRICE = gql`
  mutation UpdateHoldingPrice($input: UpdateHoldingPriceInput!) {
    updateHoldingPrice(input: $input) {
      id
      institutionPrice
      institutionValue
      unrealizedGain
      unrealizedGainPercent
    }
  }
`;
```

**Update barrel exports:**

In `spendwise/src/graphql/queries/index.ts`, add: `export * from './portfolio';`

In `spendwise/src/graphql/mutations/index.ts`, add: `export * from './portfolio';`
  </action>
  <verify>Run `cd /Users/heechung/projects/spendwise && npx tsc --noEmit` to check for TypeScript errors in the new files.</verify>
  <done>Three query definitions (GET_PORTFOLIO, GET_ASSET_ALLOCATION, GET_HOLDINGS) and two mutation definitions (ADD_HOLDING, UPDATE_HOLDING_PRICE) exist and are exported from barrel files.</done>
</task>

<task type="auto">
  <name>Task 2: Create usePortfolio hooks</name>
  <files>
    spendwise/src/hooks/usePortfolio.ts
    spendwise/src/hooks/index.ts
  </files>
  <action>
**Create `spendwise/src/hooks/usePortfolio.ts`** following the exact pattern from `useNetWorth.ts`:

```typescript
'use client';

import { useQuery, useMutation } from '@apollo/client/react';
import {
  GET_PORTFOLIO,
  GET_ASSET_ALLOCATION,
  GET_HOLDINGS,
  ADD_HOLDING,
  UPDATE_HOLDING_PRICE,
} from '@/graphql';

export function usePortfolio(options?: { skip?: boolean }) {
  const { data, loading, error, refetch } = useQuery<any>(GET_PORTFOLIO, {
    fetchPolicy: 'cache-and-network',
    skip: options?.skip,
  });

  return {
    portfolio: data?.portfolio,
    loading,
    error,
    refetch,
  };
}

export function useAssetAllocation(options?: { skip?: boolean }) {
  const { data, loading, error, refetch } = useQuery<any>(GET_ASSET_ALLOCATION, {
    fetchPolicy: 'cache-and-network',
    skip: options?.skip,
  });

  return {
    allocation: data?.assetAllocation ?? [],
    loading,
    error,
    refetch,
  };
}

export function useHoldings(options?: { accountId?: string; skip?: boolean }) {
  const variables: Record<string, unknown> = {};

  if (options?.accountId) {
    variables.accountId = options.accountId;
  }

  const { data, loading, error, refetch } = useQuery<any>(GET_HOLDINGS, {
    variables,
    fetchPolicy: 'cache-and-network',
    skip: options?.skip,
  });

  return {
    holdings: data?.holdings ?? [],
    loading,
    error,
    refetch,
  };
}

export function useAddHolding() {
  const [addHoldingMutation, { loading, error }] = useMutation<any>(
    ADD_HOLDING,
    {
      refetchQueries: ['GetPortfolio', 'GetAssetAllocation', 'GetHoldings'],
      awaitRefetchQueries: true,
    }
  );

  const addHolding = async (input: {
    accountId: string;
    securityName: string;
    tickerSymbol?: string;
    securityType: string;
    quantity: number;
    price: number;
    costBasis?: number;
  }) => {
    return addHoldingMutation({
      variables: { input },
    });
  };

  return {
    addHolding,
    loading,
    error,
  };
}

export function useUpdateHoldingPrice() {
  const [updatePriceMutation, { loading, error }] = useMutation<any>(
    UPDATE_HOLDING_PRICE,
    {
      refetchQueries: ['GetPortfolio', 'GetAssetAllocation', 'GetHoldings'],
      awaitRefetchQueries: true,
    }
  );

  const updatePrice = async (holdingId: string, newPrice: number) => {
    return updatePriceMutation({
      variables: { input: { holdingId, newPrice } },
    });
  };

  return {
    updatePrice,
    loading,
    error,
  };
}
```

**Update barrel export:**

In `spendwise/src/hooks/index.ts`, add: `export * from './usePortfolio';`
  </action>
  <verify>Run `cd /Users/heechung/projects/spendwise && npx tsc --noEmit` to check for TypeScript errors.</verify>
  <done>Five hooks exported (usePortfolio, useAssetAllocation, useHoldings, useAddHolding, useUpdateHoldingPrice) and available via barrel import from `@/hooks`.</done>
</task>

</tasks>

<verification>
1. `cd /Users/heechung/projects/spendwise && npx tsc --noEmit` passes with no errors
2. `portfolio.ts` query file exports GET_PORTFOLIO, GET_ASSET_ALLOCATION, GET_HOLDINGS
3. `portfolio.ts` mutation file exports ADD_HOLDING, UPDATE_HOLDING_PRICE
4. `usePortfolio.ts` exports five hooks
5. All exports accessible via barrel files: `import { GET_PORTFOLIO } from '@/graphql'` and `import { usePortfolio } from '@/hooks'`
</verification>

<success_criteria>
- Three GraphQL queries defined matching the backend schema types
- Two GraphQL mutations defined for addHolding and updateHoldingPrice
- Five hooks wrapping queries/mutations with cache-and-network fetch policy
- Mutation hooks refetch portfolio, allocation, and holdings queries after success
- All exports registered in barrel index files
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-investment-portfolio/06-02-SUMMARY.md`
</output>
