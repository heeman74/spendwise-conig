---
phase: 07-financial-planning
plan: 04
type: execute
wave: 4
depends_on: ["07-03"]
files_modified:
  - spendwise/src/components/planning/InsightCard.tsx
  - spendwise/src/components/planning/ChatMessage.tsx
  - spendwise/src/components/planning/StreamingMessage.tsx
  - spendwise/src/components/planning/ChatInput.tsx
  - spendwise/src/components/planning/ChatInterface.tsx
  - spendwise/src/components/planning/InlineChart.tsx
  - spendwise/src/components/planning/GoalSuggestion.tsx
  - spendwise/src/app/(dashboard)/planning/page.tsx
  - spendwise/src/components/layout/Sidebar.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to /planning page from sidebar"
    - "Pre-generated insights display on page load as conversation starters"
    - "User can type a message and see streaming AI response with thinking dots animation"
    - "Chat messages persist across page refreshes"
    - "Each AI response displays disclaimer text at the bottom"
    - "Rate limit counter shows remaining messages"
    - "Chat input links to other pages using markdown links rendered as clickable"
  artifacts:
    - path: "spendwise/src/app/(dashboard)/planning/page.tsx"
      provides: "Financial planning page with insights and chat"
      min_lines: 50
    - path: "spendwise/src/components/planning/ChatInterface.tsx"
      provides: "Main chat container with message list and streaming"
      min_lines: 80
    - path: "spendwise/src/components/planning/InsightCard.tsx"
      provides: "Pre-generated insight display card"
      min_lines: 20
    - path: "spendwise/src/components/planning/StreamingMessage.tsx"
      provides: "Streaming text display with thinking indicator"
      min_lines: 30
  key_links:
    - from: "spendwise/src/app/(dashboard)/planning/page.tsx"
      to: "spendwise/src/hooks/useFinancialPlanning.ts"
      via: "imports hooks for data fetching"
      pattern: "useActiveInsights|useChatSession"
    - from: "spendwise/src/components/planning/ChatInterface.tsx"
      to: "spendwise/src/hooks/useFinancialPlanning.ts"
      via: "uses streaming and mutation hooks"
      pattern: "useChatStream|useSendChatMessage"
    - from: "spendwise/src/components/layout/Sidebar.tsx"
      to: "/planning"
      via: "navigation link added"
      pattern: "planning"
---

<objective>
Build the complete financial planning UI: planning page with pre-generated insights, conversational chat interface with streaming responses, thinking indicators, inline charts, goal suggestions, rate limit display, and sidebar navigation.

Purpose: This is the user-facing delivery of Phase 7. Users interact with their AI financial advisor through this page, see pre-generated insights, ask follow-up questions, and create goals from chat.

Output: Planning page at /planning with all chat components, insight cards, and sidebar navigation entry.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-financial-planning/07-CONTEXT.md
@.planning/phases/07-financial-planning/07-03-SUMMARY.md

Key existing patterns:
@spendwise/src/app/(dashboard)/investments/page.tsx (recent page pattern)
@spendwise/src/app/(dashboard)/net-worth/page.tsx (page with chart and data)
@spendwise/src/components/layout/Sidebar.tsx (sidebar nav structure)
@spendwise/src/components/dashboard/NetWorthSummaryCard.tsx (card component pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chat components and planning page</name>
  <files>
    spendwise/src/components/planning/InsightCard.tsx
    spendwise/src/components/planning/ChatMessage.tsx
    spendwise/src/components/planning/StreamingMessage.tsx
    spendwise/src/components/planning/ChatInput.tsx
    spendwise/src/components/planning/ChatInterface.tsx
    spendwise/src/components/planning/InlineChart.tsx
    spendwise/src/components/planning/GoalSuggestion.tsx
    spendwise/src/app/(dashboard)/planning/page.tsx
  </files>
  <action>
Install react-markdown in the frontend: `cd spendwise && npm install react-markdown`

**Create `src/components/planning/InsightCard.tsx`:**
- Props: { insightType, title, content, priority, onAskAbout: (title) => void }
- Styled card with type-specific icon (lightbulb for spending_anomaly, piggy bank for savings_opportunity, chart for investment_observation)
- Priority indicator (1-2 = red badge "High Impact", 3 = yellow "Medium", 4-5 = green "Info")
- Title in bold, content as paragraph (truncated to 3 lines with "Read more" expand)
- "Ask about this" button that calls onAskAbout with the insight title
- Tailwind styling: rounded-lg, border, p-4, hover:shadow-md transition

**Create `src/components/planning/ChatMessage.tsx`:**
- Props: { role: 'user' | 'assistant', content: string, createdAt: string, isStreaming?: boolean }
- User messages: right-aligned, blue background, white text
- Assistant messages: left-aligned, gray background, dark text
- Render assistant content with react-markdown (ReactMarkdown component)
- Markdown links rendered as Next.js Link components for internal app links (href starts with '/')
- Detect disclaimer line at bottom of assistant messages, render in smaller italic gray text
- Timestamp below each message in small gray text
- If isStreaming is true, show cursor blink animation at end of content

**Create `src/components/planning/StreamingMessage.tsx`:**
- Props: { content: string, isThinking: boolean }
- When isThinking and no content: show three animated dots (thinking indicator, like iMessage)
- Animation: three gray dots with staggered bounce animation using Tailwind keyframes
- When content starts arriving: transition to showing content with ChatMessage component (role='assistant', isStreaming=true)
- Smooth transition from dots to text

**Create `src/components/planning/ChatInput.tsx`:**
- Props: { onSend: (message: string) => void, disabled: boolean, remaining: number, resetAt: string | null }
- Text input with send button (arrow icon)
- Enter key to send (Shift+Enter for newline â€” use textarea with auto-resize)
- Disabled state when disabled prop is true (during streaming or rate limit exceeded)
- Rate limit display: "{remaining} messages remaining today" in small text below input
- If remaining === 0: show "Daily limit reached. Resets at {formatted time}" message, disable input
- Placeholder: "Ask about your finances or set a goal..."

**Create `src/components/planning/InlineChart.tsx`:**
- Props: { type: 'trend' | 'breakdown', data: any[], title: string }
- For 'trend': LineChart from recharts with XAxis (month), YAxis, Tooltip, Line
- For 'breakdown': BarChart from recharts with horizontal bars
- Compact size: 200px height, full width
- Wrapped in rounded gray background with title
- Only rendered when data is provided

**Create `src/components/planning/GoalSuggestion.tsx`:**
- Props: { goalName: string, targetAmount: number, deadline?: string, onCreateGoal: () => void, onDismiss: () => void }
- Card-style component showing parsed goal details
- "Create Goal" primary button and "Not now" secondary button
- Shows: goal name, target amount formatted as currency, deadline if present
- Success state: "Goal created!" with checkmark after onCreateGoal succeeds

**Create `src/components/planning/ChatInterface.tsx`:**
'use client' component. Main orchestrator for the chat experience.

State management:
- activeSessionId (string | null) - current chat session
- messages (array) - local message state for real-time updates
- isThinking (boolean) - thinking dots state

Data hooks:
- const { sessions } = useChatSessions()
- const { session, messages: loadedMessages, refetch: refetchSession } = useChatSession(activeSessionId)
- const { rateLimit, loading: rateLimitLoading } = useChatRateLimit()
- const { createSession } = useCreateChatSession()
- const { sendMessage } = useSendChatMessage()
- const { startStream, stopStream, isStreaming, streamedContent, error: streamError } = useChatStream()

Behavior:
- On mount: if sessions exist, load most recent. Otherwise, auto-create new session.
- When user sends message:
  1. Optimistically add user message to local messages array
  2. Call sendMessage mutation with sessionId and content
  3. Set isThinking = true
  4. Call startStream(sessionId, content, onChunk, onDone, onError)
  5. onChunk: isThinking = false (first chunk received, stop thinking dots)
  6. onDone: add assistant message to local messages, refetch session for persistence
  7. onError: show error toast/banner
- Auto-scroll to bottom on new messages (useRef on container, scrollIntoView)
- "New Chat" button to create fresh session
- Session list in sidebar/dropdown for switching between conversations

Layout:
- Full height flex container (h-[calc(100vh-...)] accounting for page header)
- Messages area: flex-1 overflow-y-auto with padding
- StreamingMessage shown at bottom of messages when streaming
- ChatInput fixed at bottom

**Create `src/app/(dashboard)/planning/page.tsx`:**
'use client' page component.

Layout:
- Page title: "Financial Planning" with subtitle "AI-powered insights and personalized advice"
- Two-section layout:
  - Top section: Pre-generated insights (horizontal scroll or grid, 3-5 cards)
  - Bottom section: Chat interface (takes remaining height)
- Insights section:
  - Use useActiveInsights() hook
  - If loading: show skeleton cards
  - If no insights: show "Import more statements to unlock AI insights" message
  - Map insights to InsightCard components
  - onAskAbout: populate chat input with "Tell me more about: {insight title}"
- Chat section:
  - Full ChatInterface component
- Disclaimer banner at very top: subtle gray text "AI-generated insights are not professional financial advice"
  </action>
  <verify>
Run `cd /Users/heechung/projects/spendwise && npx tsc --noEmit` passes.
Verify all 7 component files exist in src/components/planning/.
Verify page.tsx exists at src/app/(dashboard)/planning/page.tsx.
Verify react-markdown is in package.json dependencies.
  </verify>
  <done>
Complete planning page with: InsightCard (3 types, priority badges, "ask about" action), ChatMessage (markdown rendering, disclaimer styling, internal links), StreamingMessage (thinking dots to streaming text transition), ChatInput (rate limit display, auto-resize textarea), ChatInterface (session management, streaming orchestration, auto-scroll), InlineChart (trend and breakdown), GoalSuggestion (parsed goal confirmation). Planning page shows insights grid + chat interface.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete financial planning page with AI chat interface, pre-generated insights, streaming responses, and sidebar navigation.
  </what-built>
  <how-to-verify>
1. Start both services: `cd spendwise-api && npm run dev` and `cd spendwise && npm run dev`
2. Ensure ANTHROPIC_API_KEY is set in spendwise-api/.env
3. Navigate to http://localhost:3000/planning
4. Verify:
   a. Page loads with "Financial Planning" title
   b. If you have 2+ months of transaction data, insight cards should appear at top
   c. Chat interface is visible below insights
   d. Type a message like "How are my finances looking?" and press Enter
   e. You should see thinking dots animation, then streaming text appearing word-by-word
   f. Response should end with "Not professional financial advice" disclaimer in smaller text
   g. Rate limit counter shows remaining messages
   h. Check sidebar has "Planning" navigation link
   i. Try asking "I want to save $5000 for a vacation by June" - should offer to create a goal
   j. Refresh page - previous messages should persist
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Add sidebar navigation for planning page</name>
  <files>
    spendwise/src/components/layout/Sidebar.tsx
  </files>
  <action>
Add a "Planning" entry to the sidebar navigation. Place it after "Investments" and before "Settings".

Use a brain/lightbulb icon (or sparkles icon if available in the icon set used by the sidebar). Follow the exact same pattern as existing nav items (icon + label + href + active state).

- Label: "Planning"
- Href: "/planning"
- Icon: Use a lightbulb or brain icon consistent with the existing icon library used in Sidebar.tsx. If the sidebar uses Heroicons, use `LightBulbIcon`. If it uses custom SVG, create a matching one.
- Active state: highlight when pathname starts with '/planning'
  </action>
  <verify>
Navigate to http://localhost:3000/dashboard and verify "Planning" appears in sidebar.
Click it and verify navigation to /planning page.
Verify active state highlighting works.
  </verify>
  <done>
Sidebar includes "Planning" navigation link with appropriate icon, positioned after Investments. Active state correctly highlights when on /planning page.
  </done>
</task>

</tasks>

<verification>
1. `cd spendwise && npx tsc --noEmit` passes
2. /planning page loads with insights section and chat interface
3. Chat streaming works (thinking dots -> streaming text)
4. Messages persist after page refresh
5. Rate limit display shows remaining count
6. Disclaimer appears on every AI response
7. Sidebar has Planning nav link
8. Insight cards have "Ask about this" action
9. react-markdown in package.json
</verification>

<success_criteria>
- Planning page accessible at /planning from sidebar navigation
- Pre-generated insights display as cards with type icons and priority badges
- Chat interface supports real-time streaming with thinking-to-text transition
- Messages persist across page refreshes via database-backed sessions
- Every AI response includes disclaimer text
- Rate limit shows remaining daily messages
- Cross-page links in AI responses are clickable
- User can create goals from chat via freeform text
</success_criteria>

<output>
After completion, create `.planning/phases/07-financial-planning/07-04-SUMMARY.md`
</output>
