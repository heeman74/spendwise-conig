---
phase: 07-financial-planning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spendwise-api/prisma/schema.prisma
  - spendwise/prisma/schema.prisma
  - spendwise-api/src/lib/anthropic.ts
  - spendwise-api/src/services/financialPlanning/financial-summarizer.ts
  - spendwise-api/src/services/financialPlanning/prompt-templates.ts
  - spendwise-api/src/services/financialPlanning/claude-client.ts
  - spendwise-api/src/services/financialPlanning/insight-generator.ts
  - spendwise-api/src/services/financialPlanning/goal-parser.ts
  - spendwise-api/src/services/financialPlanning/rate-limiter.ts
autonomous: true
user_setup:
  - service: anthropic
    why: "Claude API for AI-powered financial planning chat"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create Key (https://console.anthropic.com/settings/keys)"

must_haves:
  truths:
    - "ChatSession, ChatMessage, and InsightCache models exist in Prisma schema with proper relations and indexes"
    - "Anthropic Claude client can stream responses token-by-token"
    - "Financial summarizer builds compact 1-2K token summary from 6 months of user data"
    - "Rate limiter tracks daily message count per user in Redis with TTL"
    - "Insight generator produces 3-5 ranked insights from financial data"
    - "Goal parser extracts goal details from freeform text with confidence scores"
  artifacts:
    - path: "spendwise-api/prisma/schema.prisma"
      provides: "ChatSession, ChatMessage, InsightCache models"
      contains: "model ChatSession"
    - path: "spendwise-api/src/lib/anthropic.ts"
      provides: "Shared Anthropic client singleton"
      contains: "new Anthropic"
    - path: "spendwise-api/src/services/financialPlanning/financial-summarizer.ts"
      provides: "Financial data summarization for token efficiency"
      exports: ["buildFinancialSummary"]
    - path: "spendwise-api/src/services/financialPlanning/claude-client.ts"
      provides: "Streaming chat response generator"
      exports: ["streamChatResponse"]
    - path: "spendwise-api/src/services/financialPlanning/rate-limiter.ts"
      provides: "Redis-based daily rate limiting"
      exports: ["checkRateLimit", "incrementUsage"]
  key_links:
    - from: "spendwise-api/src/services/financialPlanning/claude-client.ts"
      to: "spendwise-api/src/lib/anthropic.ts"
      via: "import anthropic client"
      pattern: "import.*anthropic"
    - from: "spendwise-api/src/services/financialPlanning/insight-generator.ts"
      to: "spendwise-api/src/services/financialPlanning/financial-summarizer.ts"
      via: "builds summary then sends to Claude"
      pattern: "buildFinancialSummary"
---

<objective>
Extend the database schema with chat persistence models and build all backend services for AI-powered financial planning: Anthropic client, financial data summarizer, insight generator, goal parser, rate limiter, and prompt templates.

Purpose: This is the foundation layer that all subsequent plans depend on. The schema enables chat persistence and insight caching. The services encapsulate all Claude API interactions, financial data compression, and business logic.

Output: Extended Prisma schema (both projects), Anthropic client singleton, and six service modules in `spendwise-api/src/services/financialPlanning/`.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-financial-planning/07-RESEARCH.md
@.planning/phases/07-financial-planning/07-CONTEXT.md

Key existing files to reference:
@spendwise-api/prisma/schema.prisma (current schema - extend with new models)
@spendwise-api/src/lib/redis.ts (Redis client for rate limiting)
@spendwise-api/src/lib/utils.ts (parseDecimal utility)
@spendwise-api/src/schema/resolvers/advice.ts (existing financial analysis pattern)
@spendwise-api/src/lib/ai/categorizer.ts (existing OpenAI pattern for reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Prisma schema with ChatSession, ChatMessage, and InsightCache models</name>
  <files>
    spendwise-api/prisma/schema.prisma
    spendwise/prisma/schema.prisma
  </files>
  <action>
Add three new models to the Prisma schema (both projects must stay in sync):

**ChatSession model:**
- id: String @id @default(cuid())
- userId: String (relation to User)
- title: String? (auto-generated from first message or user-set)
- createdAt: DateTime @default(now())
- updatedAt: DateTime @updatedAt
- messages: ChatMessage[] relation
- Indexes: @@index([userId, updatedAt])

**ChatMessage model:**
- id: String @id @default(cuid())
- sessionId: String (relation to ChatSession, onDelete: Cascade)
- role: String ("user" or "assistant")
- content: String @db.Text
- metadata: Json? (for tokens, model, etc.)
- createdAt: DateTime @default(now())
- Indexes: @@index([sessionId, createdAt])

**InsightCache model:**
- id: String @id @default(cuid())
- userId: String (relation to User)
- insightType: String ("spending_anomaly", "savings_opportunity", "investment_observation")
- title: String
- content: String @db.Text
- priority: Int (1 = highest impact)
- dataSnapshot: Json (financial summary used to generate)
- generatedAt: DateTime @default(now())
- invalidatedAt: DateTime? (set when new statement imported)
- Indexes: @@unique([userId, insightType, generatedAt]), @@index([userId, invalidatedAt])

**Update User model** to add relations:
- chatSessions: ChatSession[]
- insightCaches: InsightCache[]

After adding models, run `cd spendwise-api && npx prisma db push` and `cd spendwise && npx prisma db push` to apply schema changes. Then run `npx prisma generate` in both projects to regenerate clients.

IMPORTANT: Keep both schema files identical. Copy the exact same changes to both.
  </action>
  <verify>
Run `cd /Users/heechung/projects/spendwise-api && npx prisma db push --accept-data-loss` succeeds.
Run `cd /Users/heechung/projects/spendwise && npx prisma db push --accept-data-loss` succeeds.
Run `npx prisma generate` in both projects succeeds.
Verify models exist: `npx prisma studio` or check that generated client includes ChatSession, ChatMessage, InsightCache types.
  </verify>
  <done>
ChatSession, ChatMessage, and InsightCache models exist in both Prisma schemas with proper relations to User and each other. Database tables are created. Prisma client is regenerated with new types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Anthropic client and all financial planning services</name>
  <files>
    spendwise-api/src/lib/anthropic.ts
    spendwise-api/src/services/financialPlanning/financial-summarizer.ts
    spendwise-api/src/services/financialPlanning/prompt-templates.ts
    spendwise-api/src/services/financialPlanning/claude-client.ts
    spendwise-api/src/services/financialPlanning/insight-generator.ts
    spendwise-api/src/services/financialPlanning/goal-parser.ts
    spendwise-api/src/services/financialPlanning/rate-limiter.ts
  </files>
  <action>
Install @anthropic-ai/sdk in the API project: `cd spendwise-api && npm install @anthropic-ai/sdk`

**1. Create `src/lib/anthropic.ts`** - Shared Anthropic client singleton:
```typescript
import Anthropic from '@anthropic-ai/sdk';
const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
export default anthropic;
```

**2. Create `src/services/financialPlanning/prompt-templates.ts`** - System prompts:
Export `FINANCIAL_ADVISOR_SYSTEM_PROMPT` - The main system prompt for chat. Include:
- Role: friendly financial advisor helping users understand finances and reach goals
- Tone: warm, knowledgeable, conversational (not robotic or overly formal)
- Guidelines: reference specific data, provide actionable recommendations, include benchmark comparisons, celebrate progress
- For spending anomalies: explain what happened, why it matters, what to do
- For investment observations: directional guidance only, NOT specific buy/sell actions
- Cross-page link format: suggest user visit specific app pages using markdown links (e.g., "[See your spending breakdown](/analytics)")
- CRITICAL: Every response must end with disclaimer: "Not professional financial advice. Consult a licensed advisor for personalized guidance."
- Financial summary placeholder: `{{FINANCIAL_SUMMARY}}` to be replaced at runtime

Export `INSIGHT_GENERATOR_SYSTEM_PROMPT` - For generating pre-loaded insights. Include instructions for 3-5 insights across three categories (spending_anomaly, savings_opportunity, investment_observation), ranked by impact. Output format: JSON array with type, title, content (2-3 paragraphs), priority (1-5).

Export `GOAL_PARSER_SYSTEM_PROMPT` - For extracting goal details from freeform text. Output: JSON with name, targetAmount, deadline (ISO date or null), category (vacation/emergency_fund/home/debt_payoff/other), confidence (0-100).

**3. Create `src/services/financialPlanning/financial-summarizer.ts`**:
Export `buildFinancialSummary(prisma: PrismaClient, userId: string): Promise<FinancialSummary>`

Define `FinancialSummary` interface with:
- period: string ("Last 6 months")
- totals: { income, expenses, netCashFlow }
- trends: { monthlyIncome: {month, amount}[], monthlyExpenses: {month, amount}[] }
- topMerchants: { name, total, category }[] (top 10)
- recurringTransactions: { active: {merchant, frequency, amount}[] (top 5), possiblyCancelled: {merchant, lastDate, amount}[] (top 3) }
- netWorth: { current, change6m, trend: "increasing"|"decreasing"|"stable" }
- portfolio: { totalValue, allocation: {type, percentage}[], topHoldings: {symbol, value}[] } | null
- goals: { active: {name, target, current, deadline}[], nearingCompletion: string[] }

Implementation: Use `Promise.all()` for parallel Prisma queries. Query last 6 months of transactions, recurring transactions, net worth snapshots, investment holdings, and savings goals. Aggregate into compact summary. Use `parseDecimal()` from `../../lib/utils` for Decimal conversion. Import subMonths from date-fns.

Target: 1-2K tokens when JSON.stringified. Limit arrays to keep compact.

**4. Create `src/services/financialPlanning/claude-client.ts`**:
Export `streamChatResponse(conversationHistory, financialSummary, userMessage): AsyncGenerator<{type, content?}>`

Use Anthropic SDK streaming: `anthropic.messages.stream()` with:
- Model: `claude-sonnet-4-5-20250929`
- max_tokens: 4096
- System prompt: FINANCIAL_ADVISOR_SYSTEM_PROMPT with `{{FINANCIAL_SUMMARY}}` replaced by JSON.stringify(financialSummary)
- Use `cache_control: { type: 'ephemeral' }` on system prompt for prompt caching
- Messages: conversationHistory + new user message
- Yield `{ type: 'text_chunk', content: delta.text }` for each text delta
- After stream completes, yield `{ type: 'done', content: finalMessage.content[0].text }` with full response

Export `generateInsightsFromSummary(financialSummary): Promise<GeneratedInsight[]>` - Non-streaming call using INSIGHT_GENERATOR_SYSTEM_PROMPT. Parse JSON response. Return array of insights.

Export `parseGoalFromText(userInput, conversationContext?): Promise<ParsedGoal | null>` - Non-streaming call using GOAL_PARSER_SYSTEM_PROMPT. Parse JSON response with zod validation. Return null if no goal detected or confidence < 50.

**5. Create `src/services/financialPlanning/insight-generator.ts`**:
Export `generateAndCacheInsights(prisma, userId): Promise<InsightCache[]>`
- Call buildFinancialSummary to get summary
- Check data sufficiency: at least 2 months of expense data (count monthly trend entries)
- If insufficient data, return empty array
- Call generateInsightsFromSummary
- Invalidate existing insights: set invalidatedAt on all user's existing InsightCache rows
- Store new insights in InsightCache table via prisma.insightCache.createMany
- Return newly created insights

Export `getActiveInsights(prisma, userId): Promise<InsightCache[]>`
- Query InsightCache where userId matches and invalidatedAt IS NULL
- Order by priority ASC (1 = highest)
- Limit to 5

**6. Create `src/services/financialPlanning/goal-parser.ts`**:
Export `parseAndCreateGoal(prisma, userId, userInput, conversationContext?): Promise<SavingsGoal | null>`
- Call parseGoalFromText from claude-client
- If null or confidence < 70, return null
- Validate: targetAmount >= 100, deadline must be future if provided
- Check active goal count (SavingsGoal where userId matches and currentAmount < targetAmount), enforce 5-goal limit
- Create SavingsGoal via prisma.savingsGoal.create
- Return created goal

**7. Create `src/services/financialPlanning/rate-limiter.ts`**:
Export `checkRateLimit(userId): Promise<{allowed, remaining, resetAt}>`
Export `incrementUsage(userId): Promise<void>`
- Use Redis key `rate_limit:chat:${userId}` with INCR + EXPIRE pattern
- Daily limit: 25 messages
- TTL: seconds until next midnight UTC
- Import redis from `../../lib/redis`
  </action>
  <verify>
Run `cd /Users/heechung/projects/spendwise-api && npx tsc --noEmit` - TypeScript compilation passes with no errors.
Verify all 7 files exist and export expected functions.
Verify @anthropic-ai/sdk is in package.json dependencies.
  </verify>
  <done>
All financial planning services are implemented: Anthropic client singleton, financial summarizer (builds compact 6-month summary), Claude client (streaming chat + insight generation + goal parsing), insight generator (generate + cache + retrieve), goal parser (freeform text to SavingsGoal), rate limiter (25/day via Redis), and prompt templates (advisor, insight, goal prompts). TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `cd spendwise-api && npx tsc --noEmit` passes
2. `cd spendwise-api && npx prisma generate` succeeds
3. `cd spendwise && npx prisma generate` succeeds
4. All 7 service files exist in expected locations
5. Schema includes ChatSession, ChatMessage, InsightCache models
6. @anthropic-ai/sdk in spendwise-api/package.json
</verification>

<success_criteria>
- Database schema extended with 3 new models (ChatSession, ChatMessage, InsightCache)
- Anthropic SDK installed and client singleton created
- Financial summarizer compresses 6 months of data into 1-2K token summary
- Claude client supports streaming chat, insight generation, and goal parsing
- Rate limiter tracks daily usage per user via Redis with 25-message daily limit
- Prompt templates include financial advisor role, disclaimer requirement, cross-page links
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-financial-planning/07-01-SUMMARY.md`
</output>
