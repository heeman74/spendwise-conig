---
phase: 02-ai-categorization-enhancement
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - spendwise-api/src/schema/typeDefs/transaction.ts
  - spendwise-api/src/schema/resolvers/transaction.ts
  - spendwise/src/graphql/queries/transactions.ts
  - spendwise/src/hooks/useTransactions.ts
  - spendwise/src/components/transactions/TransactionList.tsx
  - spendwise/src/components/transactions/TransactionItem.tsx
  - spendwise/src/app/(dashboard)/transactions/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view a list of low-confidence transactions that need review"
    - "User can manually override the category of any transaction"
    - "After overriding, the transaction's confidence shows 100% and source shows 'manual'"
    - "The 'Needs Review' tab shows only AI/keyword/cache categorized transactions below 70% confidence"
    - "Correcting a transaction in the review list triggers merchant rule learning and retroactive updates"
  artifacts:
    - path: "spendwise-api/src/schema/typeDefs/transaction.ts"
      provides: "needsReview filter on TransactionFilterInput and transactionsNeedingReview query"
      contains: "needsReview"
    - path: "spendwise-api/src/schema/resolvers/transaction.ts"
      provides: "transactionsNeedingReview resolver"
      contains: "transactionsNeedingReview"
    - path: "spendwise/src/graphql/queries/transactions.ts"
      provides: "GET_TRANSACTIONS_NEEDING_REVIEW query"
      contains: "transactionsNeedingReview"
    - path: "spendwise/src/hooks/useTransactions.ts"
      provides: "useTransactionsNeedingReview hook"
      contains: "useTransactionsNeedingReview"
    - path: "spendwise/src/app/(dashboard)/transactions/page.tsx"
      provides: "Needs Review tab on transactions page"
      contains: "needsReview"
  key_links:
    - from: "spendwise/src/app/(dashboard)/transactions/page.tsx"
      to: "spendwise/src/hooks/useTransactions.ts"
      via: "useTransactionsNeedingReview hook"
      pattern: "useTransactionsNeedingReview"
    - from: "spendwise/src/hooks/useTransactions.ts"
      to: "spendwise/src/graphql/queries/transactions.ts"
      via: "GET_TRANSACTIONS_NEEDING_REVIEW query"
      pattern: "GET_TRANSACTIONS_NEEDING_REVIEW"
    - from: "spendwise/src/graphql/queries/transactions.ts"
      to: "spendwise-api/src/schema/typeDefs/transaction.ts"
      via: "transactionsNeedingReview GraphQL query"
      pattern: "transactionsNeedingReview"
    - from: "spendwise-api/src/schema/resolvers/transaction.ts"
      to: "prisma.transaction.findMany"
      via: "categoryConfidence lt 70, categorySource notIn manual/rule"
      pattern: "categoryConfidence.*lt.*70"
---

<objective>
Add a "Needs Review" query and UI for low-confidence transactions, completing the user feedback loop.

Purpose: Without a review UI, low-confidence categorizations sit silently incorrect. Users need a dedicated place to see flagged transactions, correct them, and train the system. This plan wires the full feedback loop: flagged transactions -> user review -> category correction -> merchant rule learning (from Plan 02) -> future AI improvement (from Plan 02's user history).

Output: New GraphQL query, frontend hook, and "Needs Review" tab on the transactions page.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/heechung/projects/.planning/PROJECT.md
@/Users/heechung/projects/.planning/ROADMAP.md
@/Users/heechung/projects/.planning/phases/02-ai-categorization-enhancement/02-RESEARCH.md

Key source files to read before implementing:
@/Users/heechung/projects/spendwise-api/src/schema/typeDefs/transaction.ts
@/Users/heechung/projects/spendwise-api/src/schema/resolvers/transaction.ts
@/Users/heechung/projects/spendwise/src/graphql/queries/transactions.ts
@/Users/heechung/projects/spendwise/src/graphql/fragments/index.ts
@/Users/heechung/projects/spendwise/src/hooks/useTransactions.ts
@/Users/heechung/projects/spendwise/src/components/transactions/TransactionList.tsx
@/Users/heechung/projects/spendwise/src/components/transactions/TransactionItem.tsx
@/Users/heechung/projects/spendwise/src/components/transactions/TransactionFilters.tsx
@/Users/heechung/projects/spendwise/src/app/(dashboard)/transactions/page.tsx
@/Users/heechung/projects/spendwise/src/types/index.ts

Plan 01 and 02 summaries (if available):
@/Users/heechung/projects/.planning/phases/02-ai-categorization-enhancement/02-01-SUMMARY.md
@/Users/heechung/projects/.planning/phases/02-ai-categorization-enhancement/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add needsReview GraphQL query and resolver</name>
  <files>
    spendwise-api/src/schema/typeDefs/transaction.ts
    spendwise-api/src/schema/resolvers/transaction.ts
  </files>
  <action>
    1. Update `spendwise-api/src/schema/typeDefs/transaction.ts`:

       Add a new query to the `extend type Query` block:
       ```graphql
       transactionsNeedingReview(limit: Int = 20, offset: Int = 0): TransactionsNeedingReviewResult!
       ```

       Add the result type (after the existing types, before the `extend type Query`):
       ```graphql
       type TransactionsNeedingReviewResult {
         transactions: [Transaction!]!
         totalCount: Int!
       }
       ```

       Also add `needsReview: Boolean` to the existing `TransactionFilterInput` input type so the main `transactions` query can also filter by review status.

    2. Update `spendwise-api/src/schema/resolvers/transaction.ts`:

       Add the `transactionsNeedingReview` resolver in the `Query` section (after `merchantRules`):
       ```typescript
       transactionsNeedingReview: async (
         _: unknown,
         { limit = 20, offset = 0 }: { limit?: number; offset?: number },
         context: Context
       ) => {
         const user = requireAuth(context);

         const where = {
           userId: user.id,
           categoryConfidence: { lt: 70 },
           categorySource: { notIn: ['manual', 'rule'] },
         };

         const [transactions, totalCount] = await Promise.all([
           context.prisma.transaction.findMany({
             where,
             orderBy: { date: 'desc' },
             take: limit,
             skip: offset,
             include: { account: true },
           }),
           context.prisma.transaction.count({ where }),
         ]);

         return { transactions, totalCount };
       },
       ```

       Also add `needsReview` filter support in the existing `transactions` resolver. In the filter building section (after the existing filters, around line 85), add:
       ```typescript
       if (args.filters?.needsReview) {
         where.categoryConfidence = { lt: 70 };
         where.categorySource = { notIn: ['manual', 'rule'] };
       }
       ```

       Add `needsReview?: boolean` to the `TransactionFilterInput` interface at the top of the file.

    IMPORTANT: The confidence threshold of 70 matches the existing amber dot indicator in TransactionItem.tsx (line 70: `(transaction.categoryConfidence ?? 100) < 70`). This ensures consistency.

    IMPORTANT: `categorySource: { notIn: ['manual', 'rule'] }` means we only flag AI, keyword, and cache categorizations. Once a user manually corrects or a rule applies, the transaction is no longer "needs review".
  </action>
  <verify>
    - `cd /Users/heechung/projects/spendwise-api && npx tsc --noEmit` compiles without errors
    - `grep "transactionsNeedingReview" /Users/heechung/projects/spendwise-api/src/schema/typeDefs/transaction.ts` returns a match
    - `grep "transactionsNeedingReview" /Users/heechung/projects/spendwise-api/src/schema/resolvers/transaction.ts` returns a match
    - `grep "needsReview" /Users/heechung/projects/spendwise-api/src/schema/typeDefs/transaction.ts` returns a match
    - `grep "lt: 70" /Users/heechung/projects/spendwise-api/src/schema/resolvers/transaction.ts` returns a match
    - Run: `cd /Users/heechung/projects/spendwise-api && npm test -- --passWithNoTests` passes
  </verify>
  <done>
    - `transactionsNeedingReview` query exists in GraphQL schema and resolver
    - Returns transactions with confidence < 70 and non-manual/rule source
    - Returns both transactions array and totalCount
    - `needsReview` filter also works on the main `transactions` query
    - TypeScript compiles and tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add frontend review UI with Needs Review tab</name>
  <files>
    spendwise/src/graphql/queries/transactions.ts
    spendwise/src/hooks/useTransactions.ts
    spendwise/src/components/transactions/TransactionItem.tsx
    spendwise/src/app/(dashboard)/transactions/page.tsx
  </files>
  <action>
    1. Add the new GraphQL query to `spendwise/src/graphql/queries/transactions.ts`:
       ```typescript
       export const GET_TRANSACTIONS_NEEDING_REVIEW = gql`
         ${TRANSACTION_FRAGMENT}
         ${ACCOUNT_FRAGMENT}
         query GetTransactionsNeedingReview($limit: Int, $offset: Int) {
           transactionsNeedingReview(limit: $limit, offset: $offset) {
             transactions {
               ...TransactionFields
               account {
                 ...AccountFields
               }
             }
             totalCount
           }
         }
       `;
       ```

    2. Add the hook to `spendwise/src/hooks/useTransactions.ts`:

       Add import for the new query:
       ```typescript
       import {
         GET_TRANSACTIONS,
         GET_RECENT_TRANSACTIONS,
         GET_CATEGORIES,
         GET_TRANSACTIONS_NEEDING_REVIEW,
         CREATE_TRANSACTION,
         UPDATE_TRANSACTION,
         DELETE_TRANSACTION,
       } from '@/graphql';
       ```

       Add the hook after the existing hooks:
       ```typescript
       export function useTransactionsNeedingReview(limit = 20) {
         const { data, loading, error, refetch } = useQuery<any>(GET_TRANSACTIONS_NEEDING_REVIEW, {
           variables: { limit, offset: 0 },
           fetchPolicy: 'cache-and-network',
         });

         return {
           transactions: data?.transactionsNeedingReview?.transactions ?? [],
           totalCount: data?.transactionsNeedingReview?.totalCount ?? 0,
           loading,
           error,
           refetch,
         };
       }
       ```

    3. Enhance `spendwise/src/components/transactions/TransactionItem.tsx`:

       Improve the confidence indicator to be more informative for the review workflow:
       - Keep the existing amber dot for AI source < 70 confidence
       - Add a tooltip-style text that shows on the review tab. Add an optional `showConfidenceDetail` prop:
         ```typescript
         interface TransactionItemProps {
           transaction: Transaction;
           onEdit?: (transaction: Transaction) => void;
           onDelete?: (id: string) => void;
           showConfidenceDetail?: boolean;  // NEW: show confidence info for review tab
         }
         ```
       - When `showConfidenceDetail` is true, show the confidence percentage and source next to the category badge:
         ```tsx
         {showConfidenceDetail && transaction.categoryConfidence != null && (
           <span className="text-xs text-amber-600 dark:text-amber-400 ml-1">
             {transaction.categoryConfidence}% ({transaction.categorySource})
           </span>
         )}
         ```

    4. Update `spendwise/src/app/(dashboard)/transactions/page.tsx`:

       Add a tab system to switch between "All Transactions" and "Needs Review":

       a. Add state for active tab:
          ```typescript
          const [activeTab, setActiveTab] = useState<'all' | 'review'>('all');
          ```

       b. Import and use the new hook:
          ```typescript
          import { useTransactionsNeedingReview } from '@/hooks/useTransactions';
          ```
          ```typescript
          const {
            transactions: reviewTransactions,
            totalCount: reviewCount,
            loading: reviewLoading,
            refetch: refetchReview,
          } = useTransactionsNeedingReview(50);
          ```

       c. Add tab buttons between the Filters card and the Transactions list card. Use a simple button group:
          ```tsx
          {/* Tab bar */}
          <div className="flex gap-1 bg-gray-100 dark:bg-gray-800 p-1 rounded-lg w-fit">
            <button
              onClick={() => setActiveTab('all')}
              className={`px-4 py-2 text-sm font-medium rounded-md transition-colors ${
                activeTab === 'all'
                  ? 'bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm'
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
              }`}
            >
              All Transactions
            </button>
            <button
              onClick={() => setActiveTab('review')}
              className={`px-4 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-2 ${
                activeTab === 'review'
                  ? 'bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm'
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
              }`}
            >
              Needs Review
              {reviewCount > 0 && (
                <span className="bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 text-xs font-semibold px-2 py-0.5 rounded-full">
                  {reviewCount}
                </span>
              )}
            </button>
          </div>
          ```

       d. Conditionally render the correct transaction list based on active tab:
          - When `activeTab === 'all'`: Show the existing TransactionList with all filters, sort, infinite scroll (no changes)
          - When `activeTab === 'review'`: Show a TransactionList with `reviewTransactions`, `reviewLoading`, and the edit handler. Pass `showConfidenceDetail` to indicate review mode. Hide the filters card and export button when in review mode.

          For the review tab content:
          ```tsx
          {activeTab === 'review' && (
            <Card padding="none">
              <div className="p-4 border-b border-gray-200 dark:border-gray-700">
                <p className="text-sm text-gray-500 dark:text-gray-400">
                  {reviewCount} transaction{reviewCount !== 1 ? 's' : ''} with low AI confidence need your review
                </p>
              </div>
              {reviewLoading ? (
                <div className="flex items-center justify-center py-12">
                  <Spinner size="lg" />
                </div>
              ) : reviewTransactions.length === 0 ? (
                <div className="text-center py-12">
                  <svg className="mx-auto h-12 w-12 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <h3 className="mt-2 text-sm font-medium text-gray-900 dark:text-white">All caught up!</h3>
                  <p className="mt-1 text-sm text-gray-500 dark:text-gray-400">
                    No transactions need review right now.
                  </p>
                </div>
              ) : (
                <TransactionList
                  transactions={reviewTransactions}
                  onEdit={handleEdit}
                  onDelete={handleDelete}
                />
              )}
            </Card>
          )}
          ```

       e. When a transaction is edited from the review tab (category changes via handleEdit -> handleSubmit), after the mutation completes, also refetch the review list:
          In the existing `handleSubmit` function, after `await updateTransaction(...)`, add:
          ```typescript
          // Refetch review list since correcting a category may remove it from review
          refetchReview();
          ```

       f. Only show filters and infinite scroll when `activeTab === 'all'`. Wrap the existing Filters Card with:
          ```tsx
          {activeTab === 'all' && (
            <Card>
              <TransactionFilters ... />
            </Card>
          )}
          ```
          And wrap the "all transactions" list card similarly.

    5. Pass `showConfidenceDetail` through TransactionList to TransactionItem:
       - Add `showConfidenceDetail?: boolean` to `TransactionListProps` in TransactionList.tsx
       - Forward it to each `<TransactionItem showConfidenceDetail={showConfidenceDetail} ... />`
       - When rendering the review tab, pass `showConfidenceDetail` to TransactionList:
         ```tsx
         <TransactionList
           transactions={reviewTransactions}
           onEdit={handleEdit}
           onDelete={handleDelete}
           showConfidenceDetail
         />
         ```
  </action>
  <verify>
    - `cd /Users/heechung/projects/spendwise && npx tsc --noEmit` compiles without errors (or `npm run build` if tsc fails on Next.js specifics)
    - `grep "GET_TRANSACTIONS_NEEDING_REVIEW" /Users/heechung/projects/spendwise/src/graphql/queries/transactions.ts` returns a match
    - `grep "useTransactionsNeedingReview" /Users/heechung/projects/spendwise/src/hooks/useTransactions.ts` returns a match
    - `grep "activeTab" /Users/heechung/projects/spendwise/src/app/\\(dashboard\\)/transactions/page.tsx` returns a match
    - `grep "Needs Review" /Users/heechung/projects/spendwise/src/app/\\(dashboard\\)/transactions/page.tsx` returns a match
    - `grep "showConfidenceDetail" /Users/heechung/projects/spendwise/src/components/transactions/TransactionItem.tsx` returns a match
    - `cd /Users/heechung/projects/spendwise && npm run lint` passes (or runs with only pre-existing warnings)
  </verify>
  <done>
    - GET_TRANSACTIONS_NEEDING_REVIEW query exists and fetches low-confidence transactions
    - useTransactionsNeedingReview hook wraps the query with loading/error states
    - Transactions page has "All Transactions" and "Needs Review" tabs
    - Needs Review tab shows count badge, list of flagged transactions, and "All caught up!" empty state
    - TransactionItem shows confidence detail (percentage + source) when in review mode
    - Correcting a transaction from review tab triggers refetch (item disappears from review list)
    - TypeScript compiles and lint passes
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/heechung/projects/spendwise-api && npx tsc --noEmit` - API TypeScript compiles
2. `cd /Users/heechung/projects/spendwise-api && npm test -- --passWithNoTests` - API tests pass
3. `cd /Users/heechung/projects/spendwise && npm run build` - Frontend builds successfully
4. Full chain verification:
   - Backend: `transactionsNeedingReview` query returns transactions where confidence < 70 and source not manual/rule
   - Frontend: "Needs Review" tab visible on transactions page with count badge
   - Frontend: Editing a transaction from review tab calls updateTransaction mutation (which triggers merchant rule + retroactive update from Plan 02)
   - Frontend: After edit, review list refreshes (corrected transaction disappears)
</verification>

<success_criteria>
- CATG-04 (manual category override): User can edit any transaction's category from the review tab (also works from "All" tab as before)
- CATG-07 (low-confidence flagging): Transactions with confidence < 70 from AI/keyword/cache sources appear in "Needs Review" tab with count badge
- Full feedback loop is wired: flagged transaction -> user review -> category edit -> merchant rule created (Plan 02) -> retroactive update (Plan 02) -> user history enriched (Plan 02) -> future AI improved
- Review tab shows "All caught up!" when no transactions need review
</success_criteria>

<output>
After completion, create `/Users/heechung/projects/.planning/phases/02-ai-categorization-enhancement/02-03-SUMMARY.md`
</output>
