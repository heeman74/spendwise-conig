---
phase: 02-ai-categorization-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spendwise-api/src/lib/constants.ts
  - spendwise-api/src/lib/ai/categorizer.ts
  - spendwise-api/src/lib/parsers/categorizer.ts
  - spendwise-api/package.json
  - spendwise/src/components/transactions/TransactionFilters.tsx
  - spendwise/src/app/(dashboard)/transactions/page.tsx
autonomous: true

must_haves:
  truths:
    - "Imported transactions are automatically categorized using AI with guaranteed schema compliance"
    - "Each categorization includes a confidence score (0-100)"
    - "Merchant names are cleaned for readability by AI"
    - "AI refusal is handled gracefully with keyword fallback"
    - "Category list is defined in one place and used everywhere"
  artifacts:
    - path: "spendwise-api/src/lib/constants.ts"
      provides: "Shared VALID_CATEGORIES array"
      contains: "VALID_CATEGORIES"
    - path: "spendwise-api/src/lib/ai/categorizer.ts"
      provides: "Upgraded AI categorizer with Structured Outputs"
      contains: "zodResponseFormat"
    - path: "spendwise-api/src/lib/parsers/categorizer.ts"
      provides: "Keyword categorizer importing from shared constants"
      contains: "VALID_CATEGORIES"
  key_links:
    - from: "spendwise-api/src/lib/ai/categorizer.ts"
      to: "spendwise-api/src/lib/constants.ts"
      via: "import VALID_CATEGORIES"
      pattern: "import.*VALID_CATEGORIES.*constants"
    - from: "spendwise-api/src/lib/ai/categorizer.ts"
      to: "openai"
      via: "client.chat.completions.parse() with zodResponseFormat"
      pattern: "completions\\.parse"
---

<objective>
Upgrade the AI categorizer to use OpenAI Structured Outputs and consolidate the category list into shared constants.

Purpose: Structured Outputs guarantee schema compliance (eliminating JSON parse errors), and shared constants eliminate the category duplication bug identified across 4+ files. This is the foundation that makes all other categorization improvements reliable.

Output: Enhanced categorizer.ts using zodResponseFormat, shared constants file, zod installed in API.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/heechung/projects/.planning/PROJECT.md
@/Users/heechung/projects/.planning/ROADMAP.md
@/Users/heechung/projects/.planning/phases/02-ai-categorization-enhancement/02-RESEARCH.md

Key source files to read before implementing:
@/Users/heechung/projects/spendwise-api/src/lib/ai/categorizer.ts
@/Users/heechung/projects/spendwise-api/src/lib/parsers/categorizer.ts
@/Users/heechung/projects/spendwise-api/src/lib/parsers/merchant-cleaner.ts
@/Users/heechung/projects/spendwise/src/components/transactions/TransactionFilters.tsx
@/Users/heechung/projects/spendwise/src/app/(dashboard)/transactions/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared category constants and install zod</name>
  <files>
    spendwise-api/src/lib/constants.ts
    spendwise-api/package.json
    spendwise-api/src/lib/ai/categorizer.ts
    spendwise-api/src/lib/parsers/categorizer.ts
    spendwise/src/components/transactions/TransactionFilters.tsx
    spendwise/src/app/(dashboard)/transactions/page.tsx
  </files>
  <action>
    1. Install zod in the API project:
       ```
       cd /Users/heechung/projects/spendwise-api && npm install zod
       ```

    2. Create `/Users/heechung/projects/spendwise-api/src/lib/constants.ts` with:
       - Export `VALID_CATEGORIES` as a const array: `['Food & Dining', 'Groceries', 'Shopping', 'Transportation', 'Bills & Utilities', 'Entertainment', 'Healthcare', 'Travel', 'Education', 'Personal Care', 'Income', 'Transfer', 'Other']`
       - Export `VALID_CATEGORIES_TUPLE` typed as `[string, ...string[]]` (needed by z.enum): `VALID_CATEGORIES as [string, ...string[]]`
       - Export `CONFIDENCE_THRESHOLD_REVIEW = 70` (threshold for "needs review")
       - Export `CONFIDENCE_THRESHOLD_LOW = 60` (threshold for low confidence display)

    3. Update `spendwise-api/src/lib/ai/categorizer.ts`:
       - Replace the local `VALID_CATEGORIES` array with `import { VALID_CATEGORIES } from '../constants';`
       - Remove the inline `VALID_CATEGORIES` definition (lines 7-11)

    4. Update `spendwise-api/src/lib/parsers/categorizer.ts`:
       - The CATEGORY_KEYWORDS keys already match VALID_CATEGORIES. No change needed to the keywords object itself, but verify the keys match the shared constant at the top of the file with a comment: `// Category keywords - keys must match VALID_CATEGORIES from ../constants`

    5. Update frontend files to import from a shared source instead of hardcoding:
       - In `spendwise/src/components/transactions/TransactionFilters.tsx`: Add a comment noting categories are hardcoded here and should match the API's VALID_CATEGORIES (don't import cross-project, just add the comment for future reference)
       - In `spendwise/src/app/(dashboard)/transactions/page.tsx`: Same comment treatment

    NOTE: We are NOT importing across project boundaries (API -> Frontend). The frontend already has its own category arrays. Just add comments for maintainability. The real dedup benefit is within the API where categorizer.ts, parsers/categorizer.ts, and the constants all live.
  </action>
  <verify>
    - `cd /Users/heechung/projects/spendwise-api && npx tsc --noEmit` compiles without errors
    - `ls /Users/heechung/projects/spendwise-api/node_modules/zod/package.json` exists
    - `grep -r "VALID_CATEGORIES" /Users/heechung/projects/spendwise-api/src/lib/constants.ts` shows the export
    - `grep "VALID_CATEGORIES" /Users/heechung/projects/spendwise-api/src/lib/ai/categorizer.ts` shows the import from constants
  </verify>
  <done>
    - zod is installed in spendwise-api
    - VALID_CATEGORIES is defined once in constants.ts and imported by categorizer.ts
    - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade AI categorizer to Structured Outputs</name>
  <files>
    spendwise-api/src/lib/ai/categorizer.ts
  </files>
  <action>
    Upgrade the OpenAI call in `categorizeTransactionsAI` from JSON mode to Structured Outputs. The function signature and overall flow (rules -> cache -> AI -> keyword fallback) stays the same. Only the OpenAI call section (Step 4, starting ~line 122) changes.

    Specific changes to `spendwise-api/src/lib/ai/categorizer.ts`:

    1. Add imports at top:
       ```typescript
       import { zodResponseFormat } from 'openai/helpers/zod';
       import { z } from 'zod';
       import { VALID_CATEGORIES, VALID_CATEGORIES_TUPLE } from '../constants';
       ```

    2. Define Zod schema after imports (module-level, not inside function):
       ```typescript
       const CategorizedResult = z.object({
         results: z.array(z.object({
           index: z.number().describe('The transaction index from the input batch'),
           category: z.enum(VALID_CATEGORIES_TUPLE).describe('The transaction category'),
           confidence: z.number().min(0).max(100).describe('Confidence score 0-100'),
           cleanedMerchant: z.string().describe('Clean, readable merchant name'),
         })),
       });
       ```

    3. Replace the OpenAI call (currently `openai.chat.completions.create` with `response_format: { type: 'json_object' }`) with:
       ```typescript
       const response = await openai.chat.completions.parse({
         model: 'gpt-4o-mini',
         temperature: 0.1,
         messages: [
           { role: 'system', content: systemPrompt },
           { role: 'user', content: userPrompt },
         ],
         response_format: zodResponseFormat(CategorizedResult, 'categorization'),
       });
       ```
       If `openai.chat.completions.parse` is not available (older SDK), try `openai.beta.chat.completions.parse` as fallback. The research notes say check at implementation time.

    4. Handle the response with refusal check:
       ```typescript
       const message = response.choices[0]?.message;
       if (message?.refusal) {
         console.warn('AI refused to categorize batch:', message.refusal);
         // Skip this batch - keyword fallback will handle these
         continue;  // (we're inside the batch loop)
       }
       const parsed = message?.parsed;
       if (parsed?.results) {
         for (const result of parsed.results) {
           // ... same logic as current but WITHOUT JSON.parse or VALID_CATEGORIES.includes check
           // because Structured Outputs guarantees the category is valid
           const batchIdx = result.index;
           if (batchIdx >= 0 && batchIdx < batchIndices.length) {
             const originalIdx = batchIndices[batchIdx];
             const confidence = Math.min(100, Math.max(0, result.confidence));
             const cleanedMerchant = result.cleanedMerchant || cleanedNames[originalIdx].displayName;
             results[originalIdx] = {
               ...transactions[originalIdx],
               category: result.category,
               confidence,
               source: 'ai',
               cleanedMerchant,
             };
             // Cache the result in Redis (same as current)
             // ...
           }
         }
       }
       ```

    5. Keep the system prompt content mostly the same but remove the JSON format instruction (Structured Outputs handles format). Update the system prompt to:
       ```
       You are a financial transaction categorizer. Categorize each transaction into exactly one of these categories: ${VALID_CATEGORIES.join(', ')}.

       Rules:
       - Use the merchant name as primary signal
       - confidence: 90+ for well-known merchants, 70-89 for likely matches, 50-69 for guesses
       - cleanedMerchant: a clean, readable merchant name (e.g., "AMZN MKTP" -> "Amazon")
       - If unsure, use "Other" with low confidence
       ```
       (Remove the "Respond with JSON..." instruction since Structured Outputs handles that.)

    6. Remove the outer `try { const parsed = JSON.parse(content); ... } catch (parseError)` block that currently wraps the response handling. Structured Outputs gives us typed `message.parsed` directly - no JSON.parse needed.

    IMPORTANT: Do NOT change the function signature, the Steps 1-3 (rules, cache), or Step 5 (keyword fallback). Only Step 4 (OpenAI call) changes.
  </action>
  <verify>
    - `cd /Users/heechung/projects/spendwise-api && npx tsc --noEmit` compiles without errors
    - `grep "zodResponseFormat" /Users/heechung/projects/spendwise-api/src/lib/ai/categorizer.ts` returns a match
    - `grep "completions.parse" /Users/heechung/projects/spendwise-api/src/lib/ai/categorizer.ts` returns a match
    - `grep "refusal" /Users/heechung/projects/spendwise-api/src/lib/ai/categorizer.ts` returns a match (refusal handling)
    - `grep "JSON.parse" /Users/heechung/projects/spendwise-api/src/lib/ai/categorizer.ts` returns NO match (removed)
    - Run existing tests: `cd /Users/heechung/projects/spendwise-api && npm test -- --passWithNoTests` passes
  </verify>
  <done>
    - AI categorizer uses Structured Outputs (zodResponseFormat + .parse()) instead of JSON mode
    - AI refusal is detected and handled with keyword fallback
    - No JSON.parse calls remain in the AI response handling
    - TypeScript compiles cleanly and existing tests pass
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/heechung/projects/spendwise-api && npx tsc --noEmit` - TypeScript compiles
2. `cd /Users/heechung/projects/spendwise-api && npm test -- --passWithNoTests` - Tests pass
3. `grep -c "VALID_CATEGORIES" /Users/heechung/projects/spendwise-api/src/lib/ai/categorizer.ts` - Uses shared constant (no local definition)
4. `grep "zodResponseFormat" /Users/heechung/projects/spendwise-api/src/lib/ai/categorizer.ts` - Uses Structured Outputs
5. `grep "refusal" /Users/heechung/projects/spendwise-api/src/lib/ai/categorizer.ts` - Handles AI refusal
</verification>

<success_criteria>
- CATG-01 (auto-categorize with AI): Categorizer upgraded with Structured Outputs for reliable schema compliance
- CATG-02 (existing categorizer as baseline): Keyword fallback preserved, imports shared constants
- CATG-06 (confidence scores): Confidence scoring preserved in Zod schema (0-100)
- CATG-08 (merchant cleaning): AI-generated cleanedMerchant preserved in Structured Outputs schema
- Category duplication eliminated within the API project
</success_criteria>

<output>
After completion, create `/Users/heechung/projects/.planning/phases/02-ai-categorization-enhancement/02-01-SUMMARY.md`
</output>
