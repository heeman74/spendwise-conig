---
phase: 03-spending-analysis
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - spendwise/src/graphql/queries/analytics.ts
  - spendwise/src/hooks/useDashboard.ts
  - spendwise/src/types/index.ts
  - spendwise/src/components/charts/MerchantBarChart.tsx
  - spendwise/src/app/(dashboard)/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees spending breakdown by category with pie and bar charts using real data"
    - "User sees monthly spending trend line chart with 6 months of data"
    - "User sees month-over-month comparison with percentage change indicators"
    - "User sees top merchants by total spend and transaction frequency"
    - "User can filter spending analysis by date range (week/month/year) and specific accounts"
  artifacts:
    - path: "spendwise/src/graphql/queries/analytics.ts"
      provides: "Updated GET_ANALYTICS with dateRange/accountIds, new GET_TOP_MERCHANTS query"
      contains: "GET_TOP_MERCHANTS"
    - path: "spendwise/src/hooks/useDashboard.ts"
      provides: "useTopMerchants hook, enhanced useAnalytics with dateRange/accountIds"
      contains: "useTopMerchants"
    - path: "spendwise/src/types/index.ts"
      provides: "MerchantSpending interface"
      contains: "MerchantSpending"
    - path: "spendwise/src/components/charts/MerchantBarChart.tsx"
      provides: "Horizontal bar chart for top merchants"
      min_lines: 40
    - path: "spendwise/src/app/(dashboard)/analytics/page.tsx"
      provides: "Complete analytics page wired to real GraphQL data with filters"
      min_lines: 100
  key_links:
    - from: "spendwise/src/app/(dashboard)/analytics/page.tsx"
      to: "spendwise/src/hooks/useDashboard.ts"
      via: "useAnalytics, useSpendingByCategory, useTopMerchants hooks"
      pattern: "useAnalytics|useTopMerchants|useSpendingByCategory"
    - from: "spendwise/src/hooks/useDashboard.ts"
      to: "spendwise/src/graphql/queries/analytics.ts"
      via: "Apollo useQuery with GET_ANALYTICS, GET_TOP_MERCHANTS"
      pattern: "GET_ANALYTICS|GET_TOP_MERCHANTS"
    - from: "spendwise/src/app/(dashboard)/analytics/page.tsx"
      to: "spendwise/src/components/charts/MerchantBarChart.tsx"
      via: "MerchantBarChart component import"
      pattern: "MerchantBarChart"
    - from: "spendwise/src/app/(dashboard)/analytics/page.tsx"
      to: "account filter state"
      via: "useState for selectedAccountIds passed to hooks"
      pattern: "selectedAccountIds|accountIds"
---

<objective>
Wire the analytics frontend to real GraphQL data, add account filtering, and build the merchant analysis chart. Replace all mock data in the analytics page with live queries.

Purpose: The analytics page currently renders mock data from `@/data/mockData`. This plan connects it to the enhanced GraphQL API from Plan 01, adds a merchant bar chart, and implements account-level filtering so users can analyze spending patterns across their real financial data.

Output: Fully functional analytics page with real data, date range switching, account filtering, and merchant analysis.
</objective>

<execution_context>
@/Users/heechung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heechung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-spending-analysis/03-01-SUMMARY.md
@spendwise/src/app/(dashboard)/analytics/page.tsx
@spendwise/src/hooks/useDashboard.ts
@spendwise/src/graphql/queries/analytics.ts
@spendwise/src/graphql/fragments/index.ts
@spendwise/src/types/index.ts
@spendwise/src/components/charts/TrendLineChart.tsx
@spendwise/src/components/charts/SpendingPieChart.tsx
@spendwise/src/components/charts/CategoryBarChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GraphQL queries, types, and hooks for enhanced analytics</name>
  <files>
    spendwise/src/graphql/queries/analytics.ts
    spendwise/src/types/index.ts
    spendwise/src/hooks/useDashboard.ts
  </files>
  <action>
**In spendwise/src/types/index.ts**, add the `MerchantSpending` interface after the `CategoryAmount` interface:
```typescript
export interface MerchantSpending {
  merchant: string;
  frequency: number;
  totalAmount: number;
  averageAmount: number;
}
```

**In spendwise/src/graphql/queries/analytics.ts**, make these changes:

1. Update `GET_ANALYTICS` query to accept `$dateRange: DateRangeInput` and `$accountIds: [ID!]` variables, and pass them to the `analytics` query field:
   ```graphql
   query GetAnalytics($period: Period, $dateRange: DateRangeInput, $accountIds: [ID!]) {
     analytics(period: $period, dateRange: $dateRange, accountIds: $accountIds) {
       ...existing fields unchanged...
     }
   }
   ```

2. Update `GET_SPENDING_BY_CATEGORY` to accept dateRange and accountIds:
   ```graphql
   query GetSpendingByCategory($period: Period, $dateRange: DateRangeInput, $accountIds: [ID!]) {
     spendingByCategory(period: $period, dateRange: $dateRange, accountIds: $accountIds) {
       ...CategoryAmountFields
     }
   }
   ```

3. Add a new `GET_TOP_MERCHANTS` query:
   ```graphql
   export const GET_TOP_MERCHANTS = gql`
     query GetTopMerchants($period: Period, $dateRange: DateRangeInput, $accountIds: [ID!], $limit: Int) {
       topMerchants(period: $period, dateRange: $dateRange, accountIds: $accountIds, limit: $limit) {
         merchant
         frequency
         totalAmount
         averageAmount
       }
     }
   `;
   ```

**In spendwise/src/hooks/useDashboard.ts**, make these changes:

1. Import `GET_TOP_MERCHANTS` from `@/graphql`.

2. Update `useAnalytics` to accept optional `dateRange` and `accountIds`:
   ```typescript
   export function useAnalytics(
     period: Period = 'MONTH',
     options?: { dateRange?: { start: string; end: string }; accountIds?: string[] }
   ) {
     const { data, loading, error, refetch } = useQuery<any>(GET_ANALYTICS, {
       variables: { period, dateRange: options?.dateRange, accountIds: options?.accountIds },
       fetchPolicy: 'cache-and-network',
     });
     return { analytics: data?.analytics, loading, error, refetch };
   }
   ```

3. Update `useSpendingByCategory` similarly:
   ```typescript
   export function useSpendingByCategory(
     period: Period = 'MONTH',
     options?: { dateRange?: { start: string; end: string }; accountIds?: string[] }
   ) {
     const { data, loading, error, refetch } = useQuery<any>(GET_SPENDING_BY_CATEGORY, {
       variables: { period, dateRange: options?.dateRange, accountIds: options?.accountIds },
       fetchPolicy: 'cache-and-network',
     });
     return { categories: data?.spendingByCategory ?? [], loading, error, refetch };
   }
   ```

4. Add new `useTopMerchants` hook:
   ```typescript
   export function useTopMerchants(
     period: Period = 'MONTH',
     options?: { dateRange?: { start: string; end: string }; accountIds?: string[]; limit?: number }
   ) {
     const { data, loading, error, refetch } = useQuery<any>(GET_TOP_MERCHANTS, {
       variables: {
         period,
         dateRange: options?.dateRange,
         accountIds: options?.accountIds,
         limit: options?.limit ?? 10,
       },
       fetchPolicy: 'cache-and-network',
     });
     return { merchants: data?.topMerchants ?? [], loading, error, refetch };
   }
   ```

5. Export `useTopMerchants` from the hooks index file (`spendwise/src/hooks/index.ts`) - add the export line.
  </action>
  <verify>
Run `cd /Users/heechung/projects/spendwise && npx tsc --noEmit` to verify TypeScript compilation. No type errors should appear from the new queries and hooks.
  </verify>
  <done>
- GET_ANALYTICS and GET_SPENDING_BY_CATEGORY accept dateRange and accountIds
- GET_TOP_MERCHANTS query exists
- useAnalytics and useSpendingByCategory accept optional dateRange and accountIds
- useTopMerchants hook exists and is exported
- MerchantSpending type is defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MerchantBarChart component</name>
  <files>
    spendwise/src/components/charts/MerchantBarChart.tsx
  </files>
  <action>
Create a new horizontal bar chart component for displaying top merchants. Follow the same patterns used in CategoryBarChart.tsx (dark mode support, custom tooltip, ResponsiveContainer).

The component should:
- Accept `data: MerchantSpending[]` prop (import from `@/types`)
- Accept optional `sortBy?: 'amount' | 'frequency'` prop (default: 'amount')
- Render a horizontal BarChart (layout="vertical") using Recharts
- Show merchant names on the Y-axis (left side), dollar amounts on X-axis
- Use a custom tooltip that displays: merchant name, total amount (formatted with formatCurrency), frequency ("N transactions"), and average amount
- Use `#3b82f6` (blue-500) as the bar fill color
- Set `ResponsiveContainer` height to `Math.max(data.length * 50 + 40, 200)` so it scales with data length
- Handle empty data: show "No merchant data available" centered in a 64px-height div, same pattern as other chart components
- Include `'use client'` directive at top
- Import `formatCurrency` from `@/lib/utils`

Style the tooltip to match existing chart tooltips: white bg with dark mode support, rounded-lg, shadow-lg, border, font-medium for merchant name, text-sm for amounts.
  </action>
  <verify>
Run `cd /Users/heechung/projects/spendwise && npx tsc --noEmit` to verify the component compiles. Verify the file exists and imports are correct.
  </verify>
  <done>
MerchantBarChart.tsx exists with horizontal bar chart layout, custom tooltip showing merchant name/amount/frequency, empty state handling, and dark mode support.
  </done>
</task>

<task type="auto">
  <name>Task 3: Rewire analytics page to real data with account filtering</name>
  <files>
    spendwise/src/app/(dashboard)/analytics/page.tsx
  </files>
  <action>
Completely rewrite the analytics page to replace mock data with real GraphQL queries. The page should use all three hooks (useAnalytics, useSpendingByCategory, useTopMerchants) and support account filtering.

**Remove all mock data imports:** Delete the import of `getSpendingByCategory, getTrendData, getDashboardStats` from `@/data/mockData`. Remove all `useMemo` calls that reference mock data. Remove the hardcoded comparison calculations (`previousMonthExpenses = stats.monthlyExpenses * 0.92`, etc.).

**Add these imports:**
- `{ useAnalytics, useSpendingByCategory, useTopMerchants, useDashboardStats, Period }` from `@/hooks/useDashboard`
- `{ useAccounts }` from `@/hooks/useAccounts` (for account filter dropdown)
- `MerchantBarChart` from `@/components/charts/MerchantBarChart`

**State management:**
- `const [period, setPeriod] = useState<Period>('MONTH')` (use uppercase Period from hook, matching API enum)
- `const [selectedAccountIds, setSelectedAccountIds] = useState<string[]>([])` (empty = all accounts)

**Data fetching:**
- `const { analytics, loading: analyticsLoading } = useAnalytics(period, { accountIds: selectedAccountIds.length > 0 ? selectedAccountIds : undefined })`
- `const { categories, loading: categoriesLoading } = useSpendingByCategory(period, { accountIds: selectedAccountIds.length > 0 ? selectedAccountIds : undefined })`
- `const { merchants, loading: merchantsLoading } = useTopMerchants(period, { accountIds: selectedAccountIds.length > 0 ? selectedAccountIds : undefined, limit: 10 })`
- `const { accounts } = useAccounts()` (for filter dropdown options -- check existing useAccounts hook for its return shape)

**Page structure (keep existing layout patterns):**

1. **Header section** (keep existing pattern): Title "Analytics" with subtitle. Period toggle buttons (Week/Month/Year) using uppercase values `'WEEK' | 'MONTH' | 'YEAR'`.

2. **Account filter** (new, add below period toggle): A multi-select or button group showing account names. When no accounts selected, show "All Accounts". Use a simple row of toggle-style buttons/chips: `accounts?.map(a => <Button variant={selectedAccountIds.includes(a.id) ? 'primary' : 'ghost'} onClick toggle />)`. Keep it simple - no external dropdown library needed.

3. **Summary cards** (replace mock data):
   - Total Spending: `formatCurrency(analytics?.summary?.totalExpenses ?? 0)` with `analytics?.comparison?.expensesChange` percentage
   - Total Income: `formatCurrency(analytics?.summary?.totalIncome ?? 0)` with `analytics?.comparison?.incomeChange` percentage
   - Net Savings: `formatCurrency(analytics?.summary?.netSavings ?? 0)` with `analytics?.summary?.savingsRate` percentage
   - Avg Daily Spending: Calculate from `totalExpenses / daysInPeriod` where daysInPeriod depends on period (7/30/365)

   Color the percentage changes: red if expenses went UP, green if DOWN. Opposite for income (green UP, red DOWN). Handle edge case where comparison values are 0 or undefined.

4. **Charts grid** (same layout, replace data):
   - Income vs Expenses Trend (full width): Pass `analytics?.trends` to TrendLineChart. The trends data from the API already matches the `TrendData` type shape `{ labels, income, expenses, savings }`.
   - Spending by Category - Pie: Pass `categories` to SpendingPieChart
   - Top Merchants (new, replaces Savings Over Time): Pass `merchants` to MerchantBarChart
   - Category Breakdown - Bar (full width): Pass `categories` to CategoryBarChart

5. **Top Spending Categories list** (keep existing, use real data): Map over `categories.slice(0, 5)` instead of mock `spendingData`.

**Loading state:** Show a simple loading indicator when any of the data hooks are loading. Use `analyticsLoading || categoriesLoading || merchantsLoading` and show a centered spinner or "Loading analytics..." text.

**Error state:** If `analytics` is undefined and not loading, show an empty state message.

**Important:** Do NOT import from `@/data/mockData`. The page must use exclusively real GraphQL data.
  </action>
  <verify>
1. Run `cd /Users/heechung/projects/spendwise && npx tsc --noEmit` - page compiles without errors
2. Run `cd /Users/heechung/projects/spendwise && npm run build` - full build succeeds
3. Verify no references to mockData remain: `grep -r "mockData" spendwise/src/app/\(dashboard\)/analytics/page.tsx` should return nothing
  </verify>
  <done>
- Analytics page uses real GraphQL data from useAnalytics, useSpendingByCategory, useTopMerchants
- Period toggle switches between WEEK/MONTH/YEAR and refetches data
- Account filter buttons allow filtering by specific accounts
- Summary cards show real totals with comparison percentage changes
- Trend chart shows 6-month multi-month time series
- Category pie and bar charts show real category data
- New merchant bar chart shows top 10 merchants by spending
- No mock data references remain
- Page builds successfully
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd /Users/heechung/projects/spendwise && npx tsc --noEmit`
2. Build succeeds: `cd /Users/heechung/projects/spendwise && npm run build`
3. No mock data in analytics page: `grep -r "mockData" src/app/\(dashboard\)/analytics/`
4. All chart components render with real data shapes
5. Account filtering state wired through to all three hooks
</verification>

<success_criteria>
- Analytics page loads and displays real data from GraphQL (no mock data)
- Period toggle (Week/Month/Year) refetches all analytics data
- Account filter allows selecting specific accounts or viewing all
- Category breakdown shown as both pie chart and bar chart
- Trend line chart shows 6 months of income/expenses/savings
- Month-over-month comparison percentages display in summary cards
- Top merchants displayed in horizontal bar chart with frequency and amount
- Page builds without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-spending-analysis/03-02-SUMMARY.md`
</output>
